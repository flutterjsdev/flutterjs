import d from"fs";import{Lexer as S}from"./lexer.js";import{Parser as w}from"./flutterjs_parser.js";import{WidgetAnalyzer as x}from"./flutterjs_widget_analyzer.js";import{StateAnalyzer as z}from"./state_analyzer_implementation.js";import{ContextAnalyzer as E}from"./context_analyzer.js";import{SSRAnalyzer as R}from"./ssr_analyzer.js";import{ReportGenerator as v}from"./flutterjs_report_generator.js";import{ImportResolver as $}from"./flutter_import_resolver.js";import{resolverConfig as b}from"./flutter_resolver_config.js";import{initLogger as C}from"./flutterjs_logger.js";class g{constructor(e={}){this.options={sourceFile:null,sourceCode:null,outputFormat:"json",outputFile:null,verbose:!0,strict:!1,projectRoot:process.cwd(),includeMetrics:!0,includeTree:!0,includeValidation:!0,includeSuggestions:!0,includeContext:!0,includeSsr:!0,includeImports:!0,ignoreUnresolvedImports:!0,prettyPrint:!0,debugLevel:"info",...e},this.logger=C({level:this.options.debugLevel,writeToFile:!0,writeToConsole:!1,debugDir:".debug"});const s=this.logger.createComponentLogger("Analyzer");this.log=s,this.importResolver=new $({projectRoot:this.options.projectRoot,ignoreUnresolved:this.options.ignoreUnresolvedImports,...b}),this.results={source:null,tokens:null,ast:null,widgets:null,importResolution:null,state:null,context:null,ssr:null,report:null},this.errors=[],this.timings={}}async analyze(){const e=this.log;e.startSession("FullAnalyzerPipeline");try{if(e.info(`
`+"=".repeat(80)),e.info("\u{1F680} FlutterJS ANALYZER - FULL PIPELINE"),e.info("=".repeat(80)),e.startSession("LoadSource"),e.info("STEP 1: Loading source code..."),await this.loadSource(),e.success("Source loaded"),e.endSession("LoadSource"),e.startSession("Lexing"),e.info("STEP 2: Tokenizing (Lexing)..."),this.lex(),e.trace("Tokens generated",this.results.tokens.length),e.success("Lexing complete"),e.endSession("Lexing"),e.startSession("Parsing"),e.info("STEP 3: Building AST (Parsing)..."),this.parse(),e.trace("Top-level items",this.results.ast.body.length),e.success("Parsing complete"),e.endSession("Parsing"),e.startSession("WidgetAnalysis"),e.info("STEP 4: Widget Analysis (Phase 1)..."),this.analyzeWidgets(),e.trace("Widgets detected",this.results.widgets.widgets.length),e.success("Widget analysis complete"),e.endSession("WidgetAnalysis"),this.options.includeImports){e.startSession("ImportResolution"),e.info("STEP 5: Resolving Imports..."),this.analyzeImports();const s=this.results.importResolution?.summary;e.trace("Imports resolved",s?.resolved||0),e.trace("Imports unresolved",s?.unresolved||0),e.success("Import resolution complete"),e.endSession("ImportResolution")}return e.startSession("StateAnalysis"),e.info("STEP 6: State Analysis (Phase 2)..."),this.analyzeState(),e.trace("State classes analyzed",this.results.state.stateClasses.length),e.success("State analysis complete"),e.endSession("StateAnalysis"),this.options.includeContext&&(e.startSession("ContextAnalysis"),e.info("STEP 7: Context Analysis (Phase 3)..."),this.analyzeContext(),e.trace("Inherited widgets detected",this.results.context.inheritedWidgets?.length||0),e.success("Context analysis complete"),e.endSession("ContextAnalysis")),this.options.includeSsr&&(e.startSession("SSRAnalysis"),e.info("STEP 8: SSR Compatibility Analysis (Phase 3)..."),this.analyzeSsr(),e.trace("SSR Compatibility Score",this.results.ssr.ssrCompatibilityScore),e.success("SSR analysis complete"),e.endSession("SSRAnalysis")),e.startSession("ReportGeneration"),e.info("STEP 9: Generating Report..."),this.generateReport(),e.success("Report generated"),e.endSession("ReportGeneration"),e.startSession("Output"),e.info("STEP 10: Output..."),this.output(),e.success("Output complete"),e.endSession("Output"),e.info("=".repeat(80)),e.success("\u2705 ANALYSIS COMPLETE"),e.info("=".repeat(80)+`
`),this.logger.saveLogs(),this.getResults()}catch(s){throw e.error("ANALYSIS FAILED"),e.failure("Analysis pipeline",s.message),e.endSession("FullAnalyzerPipeline"),s}}analyzeImports(){const e=Date.now(),s=this.log;try{if(!this.results.source){s.warn("No source code found, skipping import analysis");return}s.info("Processing imports from AST (parsed in Step 3)...");const t=this.results.widgets?.imports||[];s&&(s.info(`Found ${t.length} import statements`),t.forEach((a,c)=>{s.debug(`  \u{1F4CD} ${a.source} \u2192 [${a.items.join(", ")}]`)}));const o=this.importResolver.resolveImports(t);if(this.results.importResolution={imports:o.imports,summary:o.summary,parsed:t},s.info(`Resolved: ${o.summary.resolved}`),s.info(`Unresolved: ${o.summary.unresolved}`),s.debug(`Framework packages: ${o.summary.bySource.framework}`),s.debug(`Local imports: ${o.summary.bySource.local}`),!this.options.ignoreUnresolvedImports&&o.imports.errors.length>0)throw new Error(`${o.imports.errors.length} imports could not be resolved`)}catch(t){throw s.error(`Import resolution failed: ${t.message}`),new Error(`Import resolution failed: ${t.message}`)}this.timings.analyzeImports=Date.now()-e}async loadSource(){const e=Date.now(),s=this.log;if(this.options.sourceCode)this.results.source=this.options.sourceCode,s.debug("Using provided source code");else if(this.options.sourceFile)try{this.results.source=d.readFileSync(this.options.sourceFile,"utf-8"),s.debug(`Loaded from file: ${this.options.sourceFile}`),s.trace("Source file size",this.results.source.length)}catch(t){throw s.error(`Cannot read file "${this.options.sourceFile}"`),new Error(`Cannot read file "${this.options.sourceFile}": ${t.message}`)}else throw s.error("No source code or source file provided"),new Error("No source code or source file provided");this.timings.loadSource=Date.now()-e}lex(){const e=Date.now(),s=this.log;try{const t=new S(this.results.source);this.results.tokens=t.tokenize(),t.getErrors().length>0&&(s.warn(`Lexer produced ${t.getErrors().length} warnings`),t.getErrors().forEach(o=>{s.debug(`Lexer: ${o.message}`)}))}catch(t){throw s.error(`Lexing failed: ${t.message}`),new Error(`Lexing failed: ${t.message}`)}this.timings.lex=Date.now()-e}parse(){const e=Date.now(),s=this.log;try{const t=new w(this.results.tokens);if(this.results.ast=t.parse(),t.getErrors().length>0&&(s.warn(`Parser produced ${t.getErrors().length} errors`),t.getErrors().forEach(o=>{s.debug(`Parser: ${o.message}`)}),this.options.strict))throw new Error(`${t.getErrors().length} parser errors found`)}catch(t){throw s.error(`Parsing failed: ${t.message}`),new Error(`Parsing failed: ${t.message}`)}this.timings.parse=Date.now()-e}analyzeWidgets(){const e=Date.now(),s=this.log;try{const t=new x(this.results.ast);this.results.widgets=t.analyze(),this.results.widgets.errors.length>0&&(s.warn(`Widget analysis produced ${this.results.widgets.errors.length} errors`),this.results.widgets.errors.forEach(o=>{s.debug(`Widget: ${o.message}`)}))}catch(t){throw s.error(`Widget analysis failed: ${t.message}`),new Error(`Widget analysis failed: ${t.message}`)}this.timings.analyzeWidgets=Date.now()-e}analyzeState(){const e=Date.now(),s=this.log;try{const t=new z(this.results.ast,this.results.widgets.widgets,{strict:this.options.strict});this.results.state=t.analyze(),this.results.state.errors.length>0&&(s.warn(`State analysis produced ${this.results.state.errors.length} errors`),this.results.state.errors.forEach(o=>{s.debug(`State: ${o.message}`)}))}catch(t){throw s.error(`State analysis failed: ${t.message}`),new Error(`State analysis failed: ${t.message}`)}this.timings.analyzeState=Date.now()-e}analyzeContext(){const e=Date.now(),s=this.log;try{const t=new E(this.results.ast,this.results.widgets.widgets,{strict:this.options.strict});this.results.context=t.analyze(),this.results.context.errors&&this.results.context.errors.length>0&&(s.warn(`Context analysis produced ${this.results.context.errors.length} errors`),this.results.context.errors.forEach(o=>{s.debug(`Context: ${o.message}`)}))}catch(t){throw s.error(`Context analysis failed: ${t.message}`),new Error(`Context analysis failed: ${t.message}`)}this.timings.analyzeContext=Date.now()-e}analyzeSsr(){const e=Date.now(),s=this.log;try{const t=new R(this.results.context,this.results.state,{strict:this.options.strict});this.results.ssr=t.analyze(),this.results.ssr.errors&&this.results.ssr.errors.length>0&&(s.warn(`SSR analysis produced ${this.results.ssr.errors.length} errors`),this.results.ssr.errors.forEach(o=>{s.debug(`SSR: ${o.message}`)}))}catch(t){throw s.error(`SSR analysis failed: ${t.message}`),new Error(`SSR analysis failed: ${t.message}`)}this.timings.analyzeSsr=Date.now()-e}generateReport(){const e=Date.now(),s=this.log;try{const t=new v(this.results.widgets,this.results.state,this.results.context,this.results.ssr,{format:this.options.outputFormat,includeMetrics:this.options.includeMetrics,includeTree:this.options.includeTree,includeValidation:this.options.includeValidation,includeSuggestions:this.options.includeSuggestions,includeContext:this.options.includeContext,includeSsr:this.options.includeSsr,prettyPrint:this.options.prettyPrint});this.results.report=t.generate()}catch(t){throw s.error(`Report generation failed: ${t.message}`),new Error(`Report generation failed: ${t.message}`)}this.timings.generateReport=Date.now()-e}output(){const e=this.log;if(this.options.outputFile)try{d.writeFileSync(this.options.outputFile,this.results.report,"utf-8"),e.success(`Report saved to: ${this.options.outputFile}`)}catch(s){throw e.error(`Cannot write to file "${this.options.outputFile}"`),new Error(`Cannot write to file "${this.options.outputFile}": ${s.message}`)}else this.options.outputFormat!=="console"&&console.log(this.results.report)}getResults(){const e=this.results.widgets?.widgets||[],s=e.filter(r=>r.type==="stateless"),t=e.filter(r=>r.type==="stateful"),o=e.filter(r=>r.type==="state"),a=s.map(r=>r.name),c=t.map(r=>r.name),l={};o.forEach(r=>{const h=r.name.replace(/^_/,"").replace(/State$/,""),f=r.fields||[];l[r.name]=f.map(y=>y.name)}),t.forEach(r=>{const h=`_${r.name}State`;l[h]&&(l[r.name]=l[h])});const u=this.results.importResolution?.parsed||[],n={};return u.forEach(r=>{n[r.source]=r.items}),{source:{length:this.results.source?.length||0,file:this.options.sourceFile},tokens:{count:this.results.tokens?.length||0},ast:{items:this.results.ast?.body?.length||0},widgets:{stateless:a,stateful:c,count:e.length,all:e,stateClasses:l,total:{stateless:s.length,stateful:t.length,state:o.length}},imports:this.options.includeImports?n:null,importResolution:this.options.includeImports?{parsed:u,summary:this.results.importResolution?.summary||{total:u.length,resolved:this.results.importResolution?.summary?.resolved||0,unresolved:this.results.importResolution?.summary?.unresolved||0,errors:this.results.importResolution?.summary?.errors||0,resolutionRate:this.results.importResolution?.summary?.resolutionRate||"N/A",bySource:this.results.importResolution?.summary?.bySource||{framework:0,local:0,cache:0}}}:null,state:{stateClasses:this.results.state?.stateClasses?.length||0,stateFields:this.results.state?.stateFields?.length||0,setStateCalls:this.results.state?.setStateCalls?.length||0,lifecycleMethods:this.results.state?.lifecycleMethods?.length||0,eventHandlers:this.results.state?.eventHandlers?.length||0,validationIssues:this.results.state?.validationResults?.length||0},context:this.options.includeContext?{inheritedWidgets:this.results.context?.inheritedWidgets?.length||0,changeNotifiers:this.results.context?.changeNotifiers?.length||0,providers:this.results.context?.providers?.length||0,contextAccessPoints:this.results.context?.contextAccessPoints?.length||0}:null,ssr:this.options.includeSsr?{compatibility:this.results.ssr?.overallCompatibility||"unknown",compatibilityScore:this.results.ssr?.ssrCompatibilityScore||0,safePatterns:this.results.ssr?.ssrSafePatterns?.length||0,unsafePatterns:this.results.ssr?.ssrUnsafePatterns?.length||0,hydrationNeeded:this.results.ssr?.hydrationCount||0,migrationSteps:this.results.ssr?.ssrMigrationPath?.length||0,estimatedEffort:this.results.ssr?.estimatedEffort||"unknown"}:null,timings:this.timings,report:this.results.report,logger:this.logger.getReport(),debugFiles:this.logger.readDebugFiles()}}}async function P(i,e={}){return new g({sourceCode:i,...e}).analyze()}async function F(i,e={}){return new g({sourceFile:i,...e}).analyze()}async function A(i,e,s={}){return new g({sourceFile:i,outputFile:e,...s}).analyze()}async function p(){const i=process.argv.slice(2);i.length===0&&(m(),process.exit(0));const e=i[0];let s=null,t="json",o=!0,a=!0,c=!0,l=!0,u="info";for(let n=1;n<i.length;n++){const r=i[n];r==="-o"||r==="--output"?s=i[++n]:r==="-f"||r==="--format"?t=i[++n]:r==="-q"||r==="--quiet"?o=!1:r==="--debug"?u=i[++n]||"debug":r==="--no-imports"?a=!1:r==="--no-context"?c=!1:r==="--no-ssr"?l=!1:r==="--phase1"?(a=!1,c=!1,l=!1):(r==="-h"||r==="--help")&&(m(),process.exit(0))}["json","markdown","console"].includes(t)||(console.error(`Invalid format: ${t}`),process.exit(1));try{const r=await new g({sourceFile:e,outputFile:s,outputFormat:t,verbose:o,includeImports:a,includeContext:c,includeSsr:l,debugLevel:u}).analyze();u!=="info"&&(console.log(`
\u{1F4CA} Debug logs saved to: .debug/`),console.log(`   View with: node debug_viewer.js
`)),process.exit(0)}catch(n){console.error(`
\u274C Error: ${n.message}
`),process.exit(1)}}function m(){console.log(`
FlutterJS Analyzer (Phase 1 + Import Resolution + Phase 2 + 3)

Usage:
  node analyzer.js <source-file> [options]

Options:
  -o, --output <file>      Output file (default: print to console)
  -f, --format <format>    Output format: json, markdown, console (default: json)
  -q, --quiet              Suppress verbose output
  --debug <level>          Enable debug logging: trace, debug, info (default: info)
  --no-imports             Skip import resolution
  --no-context             Skip Phase 3 context analysis
  --no-ssr                 Skip Phase 3 SSR analysis
  --phase1                 Only Phase 1 (widgets + imports)
  -h, --help               Show this help message

Examples:
  node analyzer.js test.fjs
  node analyzer.js test.fjs -o report.json
  node analyzer.js test.fjs --debug trace
  node analyzer.js test.fjs -f markdown
  node analyzer.js test.fjs --phase1
`)}import.meta.url===`file://${process.argv[1]}`&&p();export{g as Analyzer,A as analyzeAndSave,P as analyzeCode,F as analyzeFile,p as runCLI};
//# sourceMappingURL=analyzer.js.map
