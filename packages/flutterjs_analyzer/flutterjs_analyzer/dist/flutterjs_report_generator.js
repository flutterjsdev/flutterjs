// Copyright 2025 The FlutterJS Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

import{getLogger as y}from"./flutterjs_logger.js";class S{constructor(t,e,s=null,a=null,i={}){this.widgetResults=t,this.stateResults=e,this.contextResults=s,this.ssrResults=a,this.options={format:"json",includeMetrics:!0,includeTree:!0,includeValidation:!0,includeSuggestions:!0,includeContext:!0,includeSsr:!0,prettyPrint:!0,...i},this.logger=y().createComponentLogger("ReportGenerator"),this.metadata={},this.report={}}generate(){this.logger.startSession("ReportGeneration"),this.logger.info("Generating report");try{this.calculateMetrics(),this.buildReport();let t;switch(this.options.format){case"json":t=this.toJSON();break;case"markdown":t=this.toMarkdown();break;case"console":t=this.toConsole();break;default:t=this.toJSON()}return this.logger.success("Report generation complete"),this.logger.endSession("ReportGeneration"),t}catch(t){throw this.logger.failure("Report generation failed",t.message),this.logger.endSession("ReportGeneration"),t}}calculateMetrics(){const t=this.widgetResults.widgets||[],e=this.widgetResults.functions||[],s=this.widgetResults.imports||[],a=this.stateResults.stateClasses||[],i=this.stateResults.stateFields||[],o=this.stateResults.setStateCalls||[],h=this.stateResults.lifecycleMethods||[],l=this.stateResults.eventHandlers||[],d=this.contextResults?.inheritedWidgets||[],u=this.contextResults?.changeNotifiers||[],c=this.contextResults?.providers||[],m=this.contextResults?.contextAccessPoints||[],p=this.ssrResults?.ssrCompatibilityScore||0,g=this.ssrResults?.ssrSafePatterns||[],f=this.ssrResults?.ssrUnsafePatterns||[],r=this.ssrResults?.hydrationRequirements||[];this.metadata={totalWidgets:t.length,statelessWidgets:t.filter(n=>n.type==="stateless").length,statefulWidgets:t.filter(n=>n.type==="stateful").length,componentWidgets:t.filter(n=>n.type==="component").length,stateClasses:a.length,totalStateFields:i.length,setStateCallCount:o.length,lifecycleMethodCount:h.length,eventHandlerCount:l.length,inheritedWidgets:d.length,changeNotifiers:u.length,providers:c.length,contextAccessPoints:m.length,ssrCompatibilityScore:p,ssrCompatibility:this.ssrResults?.overallCompatibility||"unknown",ssrSafePatterns:g.length,ssrUnsafePatterns:f.length,hydrationRequired:r.length>0,hydrationCount:r.length,totalFunctions:e.length,entryPoint:this.widgetResults.entryPoint,rootWidget:this.widgetResults.rootWidget,totalImports:s.length,externalPackages:new Set(s.map(n=>n.source)).size,treeDepth:this.calculateTreeDepth(this.widgetResults.widgetTree),errorCount:this.countValidationIssues(this.stateResults.validationResults,"error"),warningCount:this.countValidationIssues(this.stateResults.validationResults,"warning"),infoCount:this.countValidationIssues(this.stateResults.validationResults,"info")},this.metadata.healthScore=this.calculateHealthScore(),this.metadata.complexityScore=this.calculateComplexityScore()}calculateTreeDepth(t,e=1){return!t||!t.children||t.children.length===0?e:1+Math.max(...t.children.map(s=>this.calculateTreeDepth(s,e+1)))}countValidationIssues(t,e){return t?t.filter(s=>s.severity===e).length:0}calculateHealthScore(){let t=100;return t-=this.metadata.errorCount*10,t-=this.metadata.warningCount*2,this.metadata.entryPoint&&(t+=5),this.metadata.statefulWidgets>this.metadata.statelessWidgets&&(t-=10),this.metadata.treeDepth>5&&(t-=5),this.metadata.ssrCompatibilityScore<50&&(t-=15),Math.max(0,Math.min(100,t))}calculateComplexityScore(){let t=0;return t+=Math.min(this.metadata.totalStateFields*10,40),t+=Math.min(this.metadata.setStateCallCount*5,30),t+=Math.min(this.metadata.eventHandlerCount*2,20),this.metadata.treeDepth>5&&(t+=10),t+=Math.min(this.metadata.contextAccessPoints*3,15),Math.min(100,t)}buildReport(){const t=this.widgetResults.widgets||[],e=this.stateResults.stateClasses||[],s=this.stateResults.validationResults||[];this.report={analysis:{file:this.widgetResults.file||"analysis",timestamp:new Date().toISOString(),status:s.some(a=>a.severity==="error")?"warning":"success",phase:"phase1+phase2+phase3"},summary:{widgets:{total:this.metadata.totalWidgets,stateless:this.metadata.statelessWidgets,stateful:this.metadata.statefulWidgets,components:this.metadata.componentWidgets},state:{stateClasses:this.metadata.stateClasses,stateFields:this.metadata.totalStateFields,setStateCalls:this.metadata.setStateCallCount,lifecycleMethods:this.metadata.lifecycleMethodCount,eventHandlers:this.metadata.eventHandlerCount},context:this.options.includeContext?{inheritedWidgets:this.metadata.inheritedWidgets,changeNotifiers:this.metadata.changeNotifiers,providers:this.metadata.providers,contextAccessPoints:this.metadata.contextAccessPoints}:null,ssr:this.options.includeSsr?{compatibility:this.metadata.ssrCompatibility,compatibilityScore:this.metadata.ssrCompatibilityScore,safePatterns:this.metadata.ssrSafePatterns,unsafePatterns:this.metadata.ssrUnsafePatterns,hydrationRequired:this.metadata.hydrationRequired,hydrationCount:this.metadata.hydrationCount}:null,functions:this.metadata.totalFunctions,imports:this.metadata.totalImports,externalPackages:this.metadata.externalPackages,entryPoint:this.metadata.entryPoint,rootWidget:this.metadata.rootWidget,treeDepth:this.metadata.treeDepth,healthScore:this.metadata.healthScore,complexityScore:this.metadata.complexityScore},widgets:this.formatWidgets(),stateClasses:this.formatStateClasses(),imports:this.formatImports(),functions:this.formatFunctions(),context:this.options.includeContext?this.formatContext():null,ssr:this.options.includeSsr?this.formatSsr():null,widgetTree:this.options.includeTree?this.formatWidgetTree():null,dependencyGraph:this.formatDependencyGraph(),validation:this.options.includeValidation?this.formatValidation():null,suggestions:this.options.includeSuggestions?this.generateSuggestions():null,metrics:this.options.includeMetrics?this.getDetailedMetrics():null}}formatContext(){return this.contextResults?{inheritedWidgets:this.contextResults.inheritedWidgets?.map(t=>({name:t.name,properties:t.properties,staticAccessors:t.staticAccessors?.map(e=>e.name),updateShouldNotifyImplemented:t.updateShouldNotifyImplemented,usedIn:t.usedIn,usageCount:t.usageCount}))||[],changeNotifiers:this.contextResults.changeNotifiers?.map(t=>({name:t.name,properties:t.properties?.length||0,getters:t.getters?.map(e=>e.name)||[],methods:t.methods?.map(e=>({name:e.name,callsNotifyListeners:e.callsNotifyListeners,mutations:e.mutations}))||[],consumers:t.consumers||[]}))||[],providers:this.contextResults.providers?.map(t=>({type:t.providerType,valueType:t.valueType,consumers:t.consumers||[],accessPatterns:t.accessPatterns||[]}))||[],contextFlow:{inheritedWidgetGraph:this.contextResults.inheritedWidgetGraph||{},providerGraph:this.contextResults.providerGraph||{}},contextAccessPoints:this.contextResults.contextAccessPoints?.map(t=>({pattern:t.pattern,type:t.type,location:t.location,ssrSafe:t.ssrSafe,reason:t.reason}))||[]}:{inheritedWidgets:[],changeNotifiers:[],providers:[],contextFlow:{}}}formatSsr(){return this.ssrResults?{overallCompatibility:this.ssrResults.overallCompatibility,compatibilityScore:this.ssrResults.ssrCompatibilityScore,readinessScore:this.ssrResults.ssrReadinessScore||this.ssrResults.ssrCompatibilityScore,estimatedEffort:this.ssrResults.estimatedEffort,patterns:{safe:this.ssrResults.ssrSafePatterns?.map(t=>({pattern:t.pattern,example:t.example,why:t.why,confidence:t.confidence}))||[],unsafe:this.ssrResults.ssrUnsafePatterns?.map(t=>({pattern:t.pattern,example:t.example,why:t.why,severity:t.severity,suggestion:t.suggestion,location:t.location}))||[]},hydration:{required:this.ssrResults.hydrationCount>0,count:this.ssrResults.hydrationCount,requirements:this.ssrResults.hydrationRequirements?.map(t=>({dependency:t.dependency,reason:t.reason,order:t.order,requiredProviders:t.requiredProviders,requiredState:t.requiredState}))||[]},lazyLoadingOpportunities:this.ssrResults.lazyLoadOpportunities?.map(t=>({target:t.target,reason:t.reason,estimatedSize:t.estimatedSize,priority:t.priority,recommendation:t.recommendation}))||[],migrationPath:this.ssrResults.ssrMigrationPath?.map(t=>({step:t.step,action:t.action,description:t.description,example:t.example,effort:t.effort,priority:t.priority,locations:t.locations}))||[],validationIssues:{critical:this.ssrResults.criticalIssues?.map(t=>({type:t.type,message:t.message,suggestion:t.suggestion,location:t.location}))||[],warnings:this.ssrResults.warningIssues?.map(t=>({type:t.type,message:t.message,suggestion:t.suggestion}))||[]}}:{compatibility:"unknown",score:0,patterns:{safe:[],unsafe:[]},hydration:[],migration:[]}}formatWidgets(){const t={};return(this.widgetResults.widgets||[]).forEach(e=>{t[e.name]={type:e.type,superClass:e.superClass||null,location:e.location,constructor:e.constructor?{params:e.constructor.params||[]}:null,methods:e.methods.map(s=>({name:s.name,params:s.params||[]})),properties:e.properties||[],linkedStateClass:e.linkedStateClass||null,imports:e.imports||[]}}),t}formatStateClasses(){const t={};return(this.stateResults.stateClasses||[]).forEach(e=>{const s=e.metadata||e;t[s.name]={name:s.name,linkedStatefulWidget:s.linkedStatefulWidget,location:s.location,stateFields:(s.stateFields||[]).map(a=>{const i=typeof a.isUsed=="function"?a.isUsed():a.usedInMethods&&a.usedInMethods.length>0;return{name:a.name,type:a.type||"any",initialValue:a.initialValueString||a.initialValue?.toString()||"undefined",isUsed:i,usedInMethods:a.usedInMethods||[],mutatedInMethods:a.mutatedInMethods||[],mutationCount:a.mutations&&a.mutations.length||0}}),lifecycleMethods:(s.lifecycleMethods||[]).map(a=>{const i=typeof a.isValid=="function"?a.isValid():!0;return{name:a.name,callsSuper:a.callsSuper||!1,hasSideEffects:a.hasSideEffects||!1,isValid:i,issues:a.validationIssues||[]}}),otherMethods:(s.otherMethods||[]).map(a=>({name:a.name,params:a.params||[]}))}}),t}formatImports(){const t={};return(this.widgetResults.imports||[]).forEach(e=>{t[e.source]=e.items||[]}),t}formatFunctions(){const t={};return(this.widgetResults.functions||[]).forEach(e=>{t[e.name]={type:e.type,location:e.location,params:(e.params||[]).map(s=>({name:s.name,optional:s.optional})),isEntryPoint:e.isEntryPoint||!1}}),t}formatWidgetTree(){return this.widgetResults.widgetTree?this.treeNodeToObject(this.widgetResults.widgetTree):null}treeNodeToObject(t){return t?{name:t.widget?.name||"Unknown",type:t.widget?.type||"unknown",depth:t.depth||0,children:(t.children||[]).map(e=>this.treeNodeToObject(e))}:null}formatDependencyGraph(){const t=this.stateResults.dependencyGraph;return t?{stateToMethods:Object.fromEntries(t.stateToMethods||[]),methodToState:Object.fromEntries(t.methodToState||[]),eventToState:Object.fromEntries(t.eventToState||[])}:null}formatValidation(){const t=this.stateResults.validationResults||[];return{totalIssues:t.length,errors:t.filter(e=>e.severity==="error"),warnings:t.filter(e=>e.severity==="warning"),info:t.filter(e=>e.severity==="info")}}generateSuggestions(){const t=[];return this.metadata.statefulWidgets>this.metadata.statelessWidgets&&t.push({type:"structure",severity:"info",message:"More stateful than stateless widgets",suggestion:"Consider using stateless widgets where possible for better performance"}),this.metadata.treeDepth>5&&t.push({type:"structure",severity:"warning",message:"Deep widget tree detected",suggestion:"Consider refactoring to reduce nesting depth (aim for < 5 levels)"}),this.options.includeSsr&&this.ssrResults&&(this.metadata.ssrCompatibilityScore<50&&t.push({type:"ssr-compatibility",severity:"warning",message:`Low SSR compatibility score (${this.metadata.ssrCompatibilityScore}/100)`,suggestion:`Follow the ${this.ssrResults.ssrMigrationPath?.length||0} migration steps to improve SSR support`,migrationSteps:this.ssrResults.ssrMigrationPath?.length||0}),this.metadata.ssrUnsafePatterns>5&&t.push({type:"ssr-patterns",severity:"warning",message:`Found ${this.metadata.ssrUnsafePatterns} SSR-unsafe patterns`,suggestion:"Refactor unsafe patterns to enable server-side rendering",unsafePatterns:this.metadata.ssrUnsafePatterns}),this.metadata.hydrationRequired&&t.push({type:"hydration",severity:"info",message:`App requires hydration for ${this.metadata.hydrationCount} dependencies`,suggestion:"Implement hydration layer to re-attach listeners after server render",hydrationDependencies:this.metadata.hydrationCount}),this.ssrResults.lazyLoadOpportunities?.length>0&&t.push({type:"optimization",severity:"info",message:`Found ${this.ssrResults.lazyLoadOpportunities.length} lazy-load opportunities`,suggestion:"Implement code splitting to reduce initial bundle size",opportunities:this.ssrResults.lazyLoadOpportunities.length})),this.options.includeContext&&this.contextResults&&(this.metadata.inheritedWidgets>3&&t.push({type:"context-hierarchy",severity:"info",message:`Multiple InheritedWidgets detected (${this.metadata.inheritedWidgets})`,suggestion:"Consider consolidating context providers to reduce nesting",inheritedWidgets:this.metadata.inheritedWidgets}),this.metadata.providers>0&&t.push({type:"state-management",severity:"info",message:`Using Provider pattern (${this.metadata.providers} providers)`,suggestion:"Ensure providers are properly organized and lazy-initialized where possible",providers:this.metadata.providers})),t}getDetailedMetrics(){return{widgetMetrics:{total:this.metadata.totalWidgets,byType:{stateless:this.metadata.statelessWidgets,stateful:this.metadata.statefulWidgets,component:this.metadata.componentWidgets,state:this.metadata.stateClasses}},stateMetrics:{stateClasses:this.metadata.stateClasses,totalFields:this.metadata.totalStateFields,setStateCalls:this.metadata.setStateCallCount,lifecycleMethods:this.metadata.lifecycleMethodCount,eventHandlers:this.metadata.eventHandlerCount},contextMetrics:this.options.includeContext?{inheritedWidgets:this.metadata.inheritedWidgets,changeNotifiers:this.metadata.changeNotifiers,providers:this.metadata.providers,contextAccessPoints:this.metadata.contextAccessPoints}:null,ssrMetrics:this.options.includeSsr?{compatibilityScore:this.metadata.ssrCompatibilityScore,compatibility:this.metadata.ssrCompatibility,safePatterns:this.metadata.ssrSafePatterns,unsafePatterns:this.metadata.ssrUnsafePatterns,hydrationRequired:this.metadata.hydrationRequired,hydrationCount:this.metadata.hydrationCount}:null,functionMetrics:{total:this.metadata.totalFunctions,entryPoint:this.metadata.entryPoint||"none"},dependencyMetrics:{totalImports:this.metadata.totalImports,externalPackages:this.metadata.externalPackages},structureMetrics:{widgetTreeDepth:this.metadata.treeDepth,rootWidget:this.metadata.rootWidget||"none"},healthMetrics:{healthScore:this.metadata.healthScore,complexityScore:this.metadata.complexityScore,errors:this.metadata.errorCount,warnings:this.metadata.warningCount}}}toJSON(){return this.options.prettyPrint?JSON.stringify(this.report,null,2):JSON.stringify(this.report)}toMarkdown(){let t=`# FlutterJS Code Analysis Report (Phase 1 + 2 + 3)

`;if(t+=`**Generated:** ${new Date().toISOString()}

`,t+=`## Summary

`,t+=`| Metric | Count |
`,t+=`|--------|-------|
`,t+=`| Total Widgets | ${this.metadata.totalWidgets} |
`,t+=`| Stateless | ${this.metadata.statelessWidgets} |
`,t+=`| Stateful | ${this.metadata.statefulWidgets} |
`,t+=`| State Classes | ${this.metadata.stateClasses} |
`,t+=`| State Fields | ${this.metadata.totalStateFields} |
`,t+=`| Health Score | ${this.metadata.healthScore}/100 |
`,t+=`| Complexity Score | ${this.metadata.complexityScore}/100 |
`,this.options.includeContext&&(t+=`| InheritedWidgets | ${this.metadata.inheritedWidgets} |
`,t+=`| ChangeNotifiers | ${this.metadata.changeNotifiers} |
`,t+=`| Providers | ${this.metadata.providers} |
`),this.options.includeSsr&&(t+=`| SSR Compatibility | ${this.metadata.ssrCompatibility} |
`,t+=`| SSR Score | ${this.metadata.ssrCompatibilityScore}/100 |
`,t+=`| Hydration Required | ${this.metadata.hydrationRequired?"Yes":"No"} |
`),t+=`
`,this.options.includeContext&&this.contextResults&&(t+=`## Context Analysis (Phase 3)

`,this.metadata.inheritedWidgets>0&&(t+=`### InheritedWidgets

`,(this.contextResults.inheritedWidgets||[]).forEach(e=>{t+=`- **${e.name}**
`,e.properties&&e.properties.length>0&&(t+=`  - Properties: ${e.properties.map(s=>s.name).join(", ")}
`),e.usedIn&&e.usedIn.length>0&&(t+=`  - Used in: ${e.usedIn.join(", ")}
`)}),t+=`
`),this.metadata.changeNotifiers>0&&(t+=`### ChangeNotifiers

`,(this.contextResults.changeNotifiers||[]).forEach(e=>{t+=`- **${e.name}**
`,e.consumers&&e.consumers.length>0&&(t+=`  - Consumed by: ${e.consumers.join(", ")}
`)}),t+=`
`)),this.options.includeSsr&&this.ssrResults&&(t+=`## SSR Compatibility Analysis (Phase 3)

`,t+=`**Overall Compatibility:** ${this.metadata.ssrCompatibility}
`,t+=`**Score:** ${this.metadata.ssrCompatibilityScore}/100
`,t+=`**Effort to fix:** ${this.ssrResults.estimatedEffort}

`,this.metadata.ssrUnsafePatterns>0&&(t+=`### Unsafe Patterns (${this.metadata.ssrUnsafePatterns})

`,(this.ssrResults.ssrUnsafePatterns||[]).slice(0,10).forEach(e=>{t+=`- **${e.pattern}**: ${e.why}
`}),this.metadata.ssrUnsafePatterns>10&&(t+=`- ... and ${this.metadata.ssrUnsafePatterns-10} more
`),t+=`
`),this.ssrResults.hydrationCount>0&&(t+=`### Hydration Requirements (${this.ssrResults.hydrationCount})

`,(this.ssrResults.hydrationRequirements||[]).forEach(e=>{t+=`- **${e.dependency}**: ${e.reason}
`}),t+=`
`),this.ssrResults.ssrMigrationPath&&this.ssrResults.ssrMigrationPath.length>0&&(t+=`### Migration Path (${this.ssrResults.ssrMigrationPath.length} steps)

`,(this.ssrResults.ssrMigrationPath||[]).forEach(e=>{t+=`**Step ${e.step}: ${e.action}**
`,e.description&&(t+=`${e.description}
`),e.effort&&(t+=`- Effort: ${e.effort}
`),t+=`
`}))),t+=`
`,this.options.includeSuggestions){const e=this.generateSuggestions();e.length>0&&(t+=`## Suggestions

`,e.forEach(s=>{t+=`- **${s.message}**: ${s.suggestion}
`}),t+=`
`)}return t}toConsole(){const t=[];return t.push(`
`+"=".repeat(80)),t.push("FlutterJS CODE ANALYSIS REPORT (Phase 1 + 2 + 3)"),t.push("=".repeat(80)+`
`),t.push("SUMMARY"),t.push("-".repeat(80)),t.push(`  Widgets: ${this.metadata.totalWidgets} (${this.metadata.statelessWidgets} stateless, ${this.metadata.statefulWidgets} stateful)`),t.push(`  State Classes: ${this.metadata.stateClasses}`),t.push(`  State Fields: ${this.metadata.totalStateFields}`),t.push(`  Health Score: ${this.metadata.healthScore}/100`),t.push(`  Complexity: ${this.metadata.complexityScore}/100`),this.options.includeContext&&(t.push(`  InheritedWidgets: ${this.metadata.inheritedWidgets}`),t.push(`  ChangeNotifiers: ${this.metadata.changeNotifiers}`),t.push(`  Providers: ${this.metadata.providers}`)),this.options.includeSsr&&(t.push(`  SSR Compatibility: ${this.metadata.ssrCompatibility}`),t.push(`  SSR Score: ${this.metadata.ssrCompatibilityScore}/100`),t.push(`  Migration Steps: ${this.ssrResults?.ssrMigrationPath?.length||0}`)),t.push(""),this.options.includeContext&&this.contextResults&&this.metadata.inheritedWidgets>0&&(t.push("CONTEXT ANALYSIS (Phase 3)"),t.push("-".repeat(80)),this.metadata.inheritedWidgets>0&&(t.push("  InheritedWidgets:"),(this.contextResults.inheritedWidgets||[]).forEach(e=>{t.push(`    - ${e.name}`),e.usedIn&&e.usedIn.length>0&&t.push(`      Used in: ${e.usedIn.join(", ")}`)})),this.metadata.changeNotifiers>0&&(t.push("  ChangeNotifiers:"),(this.contextResults.changeNotifiers||[]).forEach(e=>{t.push(`    - ${e.name}`),e.consumers&&e.consumers.length>0&&t.push(`      Consumers: ${e.consumers.join(", ")}`)})),t.push("")),this.options.includeSsr&&this.ssrResults&&(t.push("SSR COMPATIBILITY ANALYSIS (Phase 3)"),t.push("-".repeat(80)),t.push(`  Overall: ${this.metadata.ssrCompatibility} (${this.metadata.ssrCompatibilityScore}/100)`),t.push(`  Safe Patterns: ${this.metadata.ssrSafePatterns}`),t.push(`  Unsafe Patterns: ${this.metadata.ssrUnsafePatterns}`),this.ssrResults.hydrationCount>0&&t.push(`  Hydration Required: Yes (${this.ssrResults.hydrationCount} dependencies)`),this.ssrResults.ssrMigrationPath&&this.ssrResults.ssrMigrationPath.length>0&&(t.push(`  Migration Steps: ${this.ssrResults.ssrMigrationPath.length}`),t.push(`  Estimated Effort: ${this.ssrResults.estimatedEffort}`)),t.push("")),this.stateResults&&this.stateResults.validationResults&&this.stateResults.validationResults.length>0&&(t.push("VALIDATION ISSUES"),t.push("-".repeat(80)),(this.stateResults.validationResults||[]).forEach(e=>{const s=e.severity==="error"?"\u274C":e.severity==="warning"?"\u26A0\uFE0F ":"\u2139\uFE0F ";t.push(`  ${s} [${e.severity.toUpperCase()}] ${e.message}`),e.suggestion&&t.push(`     \u2192 ${e.suggestion}`)}),t.push("")),t.push("=".repeat(80)+`
`),t.join(`
`)}saveToFile(t,e){const s=this.generate();return e.writeFileSync(t,s,"utf-8"),t}}export{S as ReportGenerator};
//# sourceMappingURL=flutterjs_report_generator.js.map
