import u from"fs";import c from"path";class h{constructor(e={}){this.options={projectRoot:process.cwd(),frameworkType:"flutter-js",ignoreUnresolved:!1,cacheEnabled:!1,...e},this.frameworkPackages={"@flutterjs/runtime":"file:../../../../../src/runtime","@flutterjs/vdom":"file:../../../../../src/vdom","@flutterjs/analyzer":"file:../../../../analyzer","@flutterjs/material":"file:../../../../../package/material","@flutterjs/cupertino":"file:../../../../../package/cupertino","@flutterjs/foundation":"file:../../../../../package/foundation"},this.customPackageMappings={},this.resolvedCache=new Map,this.unresolvedCache=new Map,this.localSearchPaths=["src","lib","packages","modules","."],this.results={resolved:[],unresolved:[],errors:[]}}parseImportsFromSource(e,a=null){const r=[];a&&(a.info("[ImportResolver] Starting import parsing..."),a.debug(`[ImportResolver] Source code length: ${e.length} characters`));const t=/import\s+([\s\S]*?)\s+from\s+['"`]([^'"`]+)['"`]/g;let s,o=0;for(;(s=t.exec(e))!==null;){o++;const n=s[1],i=s[2];a&&(a.debug(`[ImportResolver] Match #${o} found`),a.debug(`  Module path: '${i}'`),a.trace(`  Raw clause length: ${n.length} chars`));const l=this.parseImportClause(n,i,a);l?(a&&(a.debug("  \u2713 Successfully parsed"),a.debug(`    Items: ${l.items.join(", ")}`)),r.push(l)):a&&a.warn(`  \u2717 Parse returned null - clause: ${n.substring(0,100)}`)}return a&&(a.info(`[ImportResolver] FINAL RESULT: Found ${o} imports, parsed ${r.length}`),r.length===0&&o===0&&(a.warn("[ImportResolver] \u26A0\uFE0F NO IMPORTS FOUND - Check regex or source code!"),a.warn(`[ImportResolver] Source starts with: ${e.substring(0,200)}`)),r.forEach((n,i)=>{a.info(`[ImportResolver]   [${i}] ${n.source} \u2192 [${n.items.join(", ")}]`)})),r}parseImportClause(e,a,r=null){if(!e||typeof e!="string")return null;let t=e.replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,"").replace(/\n/g," ").replace(/\t/g," ").replace(/\s+/g," ").trim();r&&(r.trace(`[ImportResolver]   Original: ${e.substring(0,100).replace(/\n/g,"\\n")}`),r.trace(`[ImportResolver]   Cleaned: "${t}"`));const s={source:a,items:[],default:null,namespace:null,raw:e},o=t.match(/^\*\s+as\s+(\w+)$/);if(o)return s.namespace=o[1],s.items.push(o[1]),r&&r.trace(`[ImportResolver]   \u2192 Namespace import: ${o[1]}`),s;const n=t.match(/\{(.+?)\}/);if(n){r&&r.trace("[ImportResolver]   \u2192 Found braces, extracting named imports");const i=n[1];if(this.extractNamedItems(i,s,r),s.items.length>0)return s}if(!t.includes("{")&&t.includes(",")&&(r&&r.trace("[ImportResolver]   \u2192 No braces but has commas, treating as named imports"),this.extractNamedItems(t,s,r),s.items.length>0))return s;if(!t.includes("{")&&!t.includes(",")&&t.length>0&&/^[\w$]+$/.test(t))return s.default=t,s.items.push(t),r&&r.trace(`[ImportResolver]   \u2192 Default import: ${t}`),s;if(t.includes("{")&&t.includes(",")){const i=t.split("{")[0].trim();if(i&&i!==","&&/^[\w$]+$/.test(i)){s.default=i;const l=t.match(/\{(.+?)\}/);return l&&this.extractNamedItems(l[1],s,r),s.items.length>0?s:null}}return r&&(r.warn("[ImportResolver]   \u26A0\uFE0F No valid import pattern detected"),r.debug(`[ImportResolver]   Cleaned was: "${t}"`)),null}extractNamedItems(e,a,r=null){const t=e.split(",");r&&r.trace(`[ImportResolver]     Found ${t.length} comma-separated items`),t.forEach(s=>{const o=s.trim();if(!o||o.length===0||o.startsWith("//")||o.startsWith("*"))return;const n=o.match(/^(\w+)\s+as\s+(\w+)$/);let i;n?(i=n[2],r&&r.trace(`[ImportResolver]       "${n[1]} as ${n[2]}" \u2192 ${i}`)):(i=o,r&&r.trace(`[ImportResolver]       "${o}"`)),/^[\w$]+$/.test(i)&&!a.items.includes(i)&&a.items.push(i)})}resolveFromSource(e,a=null){const r=this.parseImportsFromSource(e,a);a&&(a.info(`[ImportResolver] Parsed ${r.length} import statements`),r.forEach((s,o)=>{a.debug(`[ImportResolver]   [${o}] ${s.source} \u2192 [${s.items.join(", ")}]`)}));const t={};return r.forEach(s=>{t[s.source]||(t[s.source]=[]),t[s.source]=t[s.source].concat(s.items)}),this.results={resolved:[],unresolved:[],errors:[]},Object.entries(t).forEach(([s,o])=>{this.resolve(s,o)}),{imports:this.results,summary:this.getSummary(),parsed:r}}resolve(e,a=[],r={}){const t=`${e}:${JSON.stringify(a)}`;if(this.resolvedCache.has(t))return this.resolvedCache.get(t);if(this.unresolvedCache.has(t))return this.unresolvedCache.get(t);const s={original:e,items:a,resolved:null,actualPath:null,type:null,source:null,isValid:!1,reason:null,fallbacks:[]};if(this.isFrameworkPackage(e)){const o=this.resolveFrameworkPackage(e,a);if(o.isValid)return s.resolved=o.resolved,s.actualPath=o.actualPath,s.type="framework",s.source="framework",s.isValid=!0,s.reason="Resolved from framework mappings",this.resolvedCache.set(t,s),this.results.resolved.push(s),s;s.fallbacks.push({step:1,tried:"framework-package",found:!1,reason:o.reason})}if(!this.isScopedPackage(e)){const o=this.resolveLocalImport(e,a);if(o.isValid)return s.resolved=o.resolved,s.actualPath=o.actualPath,s.type="local",s.source="local",s.isValid=!0,s.reason=`Found in local project at ${o.actualPath}`,this.resolvedCache.set(t,s),this.results.resolved.push(s),s;s.fallbacks.push({step:2,tried:"local-code",locations:o.searchedLocations,found:!1,reason:o.reason})}if(this.options.cacheEnabled){const o=this.resolveFromCache(e,a);if(o.isValid)return s.resolved=o.resolved,s.actualPath=o.actualPath,s.type="cache",s.source="cache",s.isValid=!0,s.reason=`Found in package cache at ${o.actualPath}`,this.resolvedCache.set(t,s),this.results.resolved.push(s),s;s.fallbacks.push({step:3,tried:"package-cache",found:!1,reason:o.reason})}return s.isValid=!1,s.source="error",s.reason=this.generateErrorMessage(e,s.fallbacks),this.options.ignoreUnresolved||this.results.errors.push(s),this.unresolvedCache.set(t,s),this.results.unresolved.push(s),s}isFrameworkPackage(e){return e.startsWith("@flutterjs/")||e.startsWith("@package:")}isScopedPackage(e){return e.startsWith("@")}resolveFrameworkPackage(e,a){return this.frameworkPackages[e]?{isValid:!0,resolved:this.frameworkPackages[e],actualPath:this.frameworkPackages[e],reason:"Found in framework package mappings"}:this.customPackageMappings[e]?{isValid:!0,resolved:this.customPackageMappings[e],actualPath:this.customPackageMappings[e],reason:"Found in custom package mappings"}:{isValid:!1,reason:`Framework package "${e}" not found in mappings`}}resolveLocalImport(e,a){const r=[];if(e.startsWith("./")||e.startsWith("../")){const t=c.resolve(this.options.projectRoot,e);return r.push(t),this.fileExists(t)?{isValid:!0,resolved:e,actualPath:t,reason:"Relative import found"}:this.fileExists(`${t}.js`)?{isValid:!0,resolved:e,actualPath:`${t}.js`,reason:"Relative import found (with .js)"}:{isValid:!1,searchedLocations:r,reason:`Relative import not found: ${e}`}}for(const t of this.localSearchPaths){const s=c.resolve(this.options.projectRoot,t,e);r.push(s);const o=c.join(s,"index.js");if(this.fileExists(o))return{isValid:!0,resolved:e,actualPath:o,reason:`Found in ${t}/${e}/index.js`};if(this.fileExists(`${s}.js`))return{isValid:!0,resolved:e,actualPath:`${s}.js`,reason:`Found in ${t}/${e}.js`};if(this.fileExists(`${s}.fjs`))return{isValid:!0,resolved:e,actualPath:`${s}.fjs`,reason:`Found in ${t}/${e}.fjs`}}return{isValid:!1,searchedLocations:r,reason:`Local import not found in: ${this.localSearchPaths.join(", ")}`}}resolveFromCache(e,a){return{isValid:!1,reason:"Package cache resolution not yet implemented"}}fileExists(e){try{return u.existsSync(e)}catch{return!1}}generateErrorMessage(e,a){let r=`\u274C Import not found: "${e}"

Resolution chain:
`;return a.forEach(t=>{r+=`  ${t.step}. Checked ${t.tried}: NOT FOUND
`,t.locations&&(r+=`     Locations searched:
`,t.locations.forEach(s=>{r+=`       - ${s}
`})),t.reason&&(r+=`     (${t.reason})
`)}),r+=`
Suggestions:
`,r+=`  \u2022 Verify the import path is correct
`,r+=`  \u2022 Check that the file exists in your project
`,r+=`  \u2022 Add a custom package mapping if needed: addPackageMapping()
`,r}resolveImports(e){return this.results={resolved:[],unresolved:[],errors:[]},e.forEach(a=>{this.resolve(a.source,a.items)}),{imports:this.results,summary:this.getSummary()}}addPackageMapping(e,a){e.startsWith("@flutterjs/")||e.startsWith("@package:")?(this.customPackageMappings[e]=a,console.log(`\u2713 Added mapping: ${e} \u2192 ${a}`)):console.warn("\u26A0 Framework mappings should start with @flutterjs/ or @package:")}addPackageMappings(e){Object.entries(e).forEach(([a,r])=>{this.addPackageMapping(a,r)})}getPackageMappings(){return{framework:this.frameworkPackages,custom:this.customPackageMappings}}setLocalSearchPaths(e){this.localSearchPaths=e,console.log(`\u2713 Set local search paths: ${e.join(", ")}`)}getSummary(){const e=this.results.resolved.length+this.results.unresolved.length,a=this.results.resolved.length,r=this.results.unresolved.length;return{total:e,resolved:a,unresolved:r,errors:this.results.errors.length,resolutionRate:e>0?(a/e*100).toFixed(2)+"%":"N/A",bySource:{framework:this.results.resolved.filter(t=>t.source==="framework").length,local:this.results.resolved.filter(t=>t.source==="local").length,cache:this.results.resolved.filter(t=>t.source==="cache").length}}}generateReport(){const e=this.getSummary();return`
\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557
\u2551         IMPORT RESOLUTION REPORT                                          \u2551
\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D

\u{1F4CA} Summary
\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  Total Imports:    ${e.total}
  \u2713 Resolved:       ${e.resolved} (${e.resolutionRate})
  \u2717 Unresolved:     ${e.unresolved}
  \u26A0 Errors:         ${e.errors}

\u{1F4CD} Resolution Sources
\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  Framework:        ${e.bySource.framework}
  Local Code:       ${e.bySource.local}
  Package Cache:    ${e.bySource.cache}

${this.results.unresolved.length>0?`
\u26A0\uFE0F  UNRESOLVED IMPORTS
\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
${this.results.unresolved.map(r=>`  \u2717 ${r.original}
     Reason: ${r.reason}`).join(`
`)}
`:""}

${this.results.errors.length>0?`
\u{1F534} ERRORS
\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
${this.results.errors.map(r=>`  \u2022 ${r.reason}`).join(`
`)}
`:""}
`}clearCache(){this.resolvedCache.clear(),this.unresolvedCache.clear(),console.log("\u2713 Resolution cache cleared")}}export{h as ImportResolver};
//# sourceMappingURL=flutter_import_resolver.js.map
