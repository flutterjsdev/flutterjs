import{getLogger as d}from"./flutterjs_logger.js";import{InheritedWidgetMetadata as h,ChangeNotifierAnalysis as u,ProviderAnalysis as l,ContextUsagePattern as o}from"./context_analyzer_data.js";class f{constructor(e,i=[],t={}){this.ast=e,this.widgets=i,this.logger=d().createComponentLogger("ContextAnalyzer"),this.options={strict:!1,...t},this.inheritedWidgets=new Map,this.changeNotifiers=new Map,this.providers=new Map,this.contextAccessPoints=[],this.inheritedWidgetGraph={},this.providerGraph={},this.errors=[]}analyze(){this.logger.startSession("ContextAnalysis"),this.logger.trace(`[ContextAnalyzer] Starting analysis...
`),this.logger.startSession("WidgetAnalyzer"),this.logger.trace(`[ContextAnalyzer] Starting analysis...
`);try{return this.detectInheritedWidgets(),this.logger.trace(`[ContextAnalyzer] Found ${this.inheritedWidgets.size} InheritedWidgets
`),this.detectChangeNotifiers(),this.logger.trace(`[ContextAnalyzer] Found ${this.changeNotifiers.size} ChangeNotifiers
`),this.detectProviders(),this.logger.trace(`[ContextAnalyzer] Found ${this.providers.size} Providers
`),this.findContextAccessPoints(),this.logger.trace(`[ContextAnalyzer] Found ${this.contextAccessPoints.length} context usage points
`),this.buildInheritedWidgetGraph(),this.buildProviderGraph(),this.logger.trace(`[ContextAnalyzer] Built dependency graphs
`),this.getResults()}catch(e){return this.errors.push(e),console.error("[ContextAnalyzer] Error:",e.message),this.getResults()}}detectInheritedWidgets(){!this.ast||!this.ast.body||this.ast.body.forEach(e=>{if(e.type!=="ClassDeclaration")return;const i=e.id?.name,t=e.superClass?.name;if(!t||!t.includes("InheritedWidget"))return;this.logger.trace(`[ContextAnalyzer.detectInheritedWidgets] Found: ${i}`);const s=new h(i,e.location,t);e.body?.fields&&e.body.fields.forEach(n=>{const r=n.key?.name;s.properties.push({name:r,type:this.inferType(n.initialValue),required:!this.hasDefaultValue(n)})}),e.body?.methods&&e.body.methods.forEach(n=>{const r=n.key?.name;r==="of"&&this.isStaticAccessor(n)&&s.staticAccessors.push({name:r,signature:`static ${r}(BuildContext context)`,usesInheritedWidgetLookup:this.checksInheritedWidgetLookup(n),location:n.location}),r==="updateShouldNotify"&&(s.updateShouldNotifyImplemented=!0)}),this.inheritedWidgets.set(i,s)})}isStaticAccessor(e){return e.key?.name==="of"}checksInheritedWidgetLookup(e){if(!e.body)return!1;const i=JSON.stringify(e.body);return i.includes("dependOnInheritedWidgetOfExactType")||i.includes("inheritedWidgetOfExactType")}detectChangeNotifiers(){!this.ast||!this.ast.body||this.ast.body.forEach(e=>{if(e.type!=="ClassDeclaration")return;const i=e.id?.name,t=e.superClass?.name;if(!t||t!=="ChangeNotifier")return;this.logger.trace(`[ContextAnalyzer.detectChangeNotifiers] Found: ${i}`);const s=new u(i,e.location);e.body?.fields&&e.body.fields.forEach(n=>{const r=n.key?.name;s.properties.push({name:r,type:this.inferType(n.initialValue),initialValue:this.expressionToString(n.initialValue)})}),e.body?.methods&&e.body.methods.forEach(n=>{const r=n.key?.name;r&&!n.params?.length&&n.body&&JSON.stringify(n).includes("return")&&s.getters.push({name:r,returnType:this.inferReturnType(n.body),location:n.location});const a=this.callsNotifyListeners(n.body);if(a||r==="increment"||r==="decrement"){const c=this.extractMutationsInMethod(n.body);s.methods.push({name:r,callsNotifyListeners:a,location:n.location,mutations:c})}}),this.changeNotifiers.set(i,s)})}callsNotifyListeners(e){return e?JSON.stringify(e).includes("notifyListeners"):!1}extractMutationsInMethod(e){const i=[];if(!e)return i;const t=JSON.stringify(e);return[/this\._(\w+)\s*[=+\-*]/g,/this\.(\w+)\s*[=+\-*]/g].forEach(n=>{let r;for(;(r=n.exec(t))!==null;)i.push(r[1])}),[...new Set(i)]}detectProviders(){!this.ast||!this.ast.body||this.ast.body.forEach(e=>{if(e.type==="ClassDeclaration"){const i=e.body?.methods?.find(t=>t.key?.name==="build");i&&this.findProvidersInMethod(i,e)}e.type==="FunctionDeclaration"&&this.findProvidersInMethod(e,null)})}findProvidersInMethod(e,i){if(!e.body)return;(e.body.type==="BlockStatement"?e.body.body:[e.body]).forEach(s=>{this.findProvidersInStatement(s)})}findProvidersInStatement(e){e&&(e.type==="ExpressionStatement"&&e.expression&&this.findProvidersInExpression(e.expression),e.type==="ReturnStatement"&&e.argument&&this.findProvidersInExpression(e.argument),e.type==="BlockStatement"&&e.body&&e.body.forEach(i=>this.findProvidersInStatement(i)))}findProvidersInExpression(e){if(e){if(e.type==="NewExpression"){const i=e.callee?.name;if(i==="Provider"||i?.startsWith("Provider")){const t=this.extractGenericType(e);if(t){this.logger.trace(`[ContextAnalyzer.detectProviders] Found Provider<${t}>`);const s=new l(`Provider<${t}>`,e.location,t);e.args&&e.args.forEach(n=>{n.type==="ObjectLiteral"&&n.properties?.forEach(r=>{r.key?.name==="create"&&(s.createFunction=this.expressionToString(r.value)),r.key?.name})}),this.identifyAccessPatterns(t,s),this.providers.set(`Provider<${t}>`,s)}}}e.type==="CallExpression"&&e.args&&e.args.forEach(i=>{this.findProvidersInExpression(i)}),e.type==="ObjectLiteral"&&e.properties&&e.properties.forEach(i=>{this.findProvidersInExpression(i.value)})}}extractGenericType(e){if(JSON.stringify(e.callee).includes("Provider")){const s=this.expressionToString(e.callee).match(/Provider<(\w+)>/);return s?s[1]:null}return null}identifyAccessPatterns(e,i){!this.ast||!this.ast.body||this.ast.body.forEach(t=>{if(t.type==="ClassDeclaration"){const s=t.body?.methods?.find(n=>n.key?.name==="build");s&&this.scanForAccessPatterns(s,e,i)}})}scanForAccessPatterns(e,i,t){if(!e.body)return;const s=JSON.stringify(e.body);s.includes("context.watch")&&t.accessPatterns.push("watch"),s.includes("context.read")&&t.accessPatterns.push("read"),s.includes("context.select")&&t.accessPatterns.push("select"),s.includes("Consumer")&&t.accessPatterns.push("Consumer")}findContextAccessPoints(){!this.ast||!this.ast.body||this.ast.body.forEach(e=>{if(e.type!=="ClassDeclaration")return;const i=e.id?.name,t=e.body?.methods?.find(s=>s.key?.name==="build");if(t){const s=this.extractContextUsageInMethod(t,i);this.contextAccessPoints.push(...s)}})}extractContextUsageInMethod(e,i){const t=[];return e.body&&(e.body.type==="BlockStatement"?e.body.body:[e.body]).forEach(n=>{const r=this.findContextUsageInStatement(n,i);t.push(...r)}),t}findContextUsageInStatement(e,i){const t=[];if(!e)return t;if(e.type==="ExpressionStatement"&&e.expression){const s=this.findContextUsageInExpression(e.expression,i);t.push(...s)}if(e.type==="ReturnStatement"&&e.argument){const s=this.findContextUsageInExpression(e.argument,i);t.push(...s)}return e.type==="BlockStatement"&&e.body&&e.body.forEach(s=>{const n=this.findContextUsageInStatement(s,i);t.push(...n)}),t}findContextUsageInExpression(e,i){const t=[];if(!e)return t;const s=JSON.stringify(e);if(s.includes("Theme.of")&&s.includes("context")&&t.push(new o("Theme.of(context)","inherited-widget-lookup",e.location,"ThemeData",!0,"Pure value access, no subscription required")),s.includes("context.theme")&&t.push(new o("context.theme()","context-service",e.location,"ThemeData",!0,"Service access during build")),s.includes("context.watch")&&t.push(new o("context.watch<T>()","provider-watch",e.location,"T",!1,"Requires reactive subscription - not SSR safe")),s.includes("context.read")&&t.push(new o("context.read<T>()","provider-read",e.location,"T",!0,"Single read at render time - SSR safe")),(s.includes("context.mediaQuery")||s.includes("MediaQuery.of"))&&t.push(new o("context.mediaQuery()","context-service",e.location,"MediaQueryData",!0,"Read-only responsive info")),(s.includes("notifyListeners")||s.includes("increment"))&&t.push(new o("notifyListeners()","global-state-mutation",e.location,"void",!1,"Mutations do not trigger re-render in SSR")),e.type==="CallExpression"&&e.args&&e.args.forEach(n=>{const r=this.findContextUsageInExpression(n,i);t.push(...r)}),e.type==="ObjectLiteral"&&e.properties&&e.properties.forEach(n=>{const r=this.findContextUsageInExpression(n.value,i);t.push(...r)}),e.type==="MemberExpression"){const n=this.findContextUsageInExpression(e.object,i);t.push(...n)}return t}buildInheritedWidgetGraph(){this.inheritedWidgets.forEach(e=>{this.inheritedWidgetGraph[e.name]={providedBy:this.findWhoProvides(e.name),consumedBy:this.findWhoConsumes(e.name),providedValue:e.properties[0]?.type||"unknown",flowPath:this.traceContextFlow(e.name)}})}buildProviderGraph(){this.providers.forEach(e=>{const i=e.providerType;this.providerGraph[i]={providedBy:this.findWhoCreatesProvider(e.providerType),providedType:e.valueType,consumedBy:this.findWhoConsumesProvider(e.providerType),accessPatterns:e.accessPatterns,flowPath:this.traceProviderFlow(e.providerType)}})}findWhoProvides(e){return"MyApp"}findWhoConsumes(e){const i=[];return this.contextAccessPoints.forEach(t=>{t.pattern.includes(e)&&i.push(t.dependent)}),i}traceContextFlow(e){return`${this.findWhoProvides(e)} -> ${e} -> ${this.findWhoConsumes(e).join(", ")}`}findWhoCreatesProvider(e){return"MyApp"}findWhoConsumesProvider(e){const i=[];return this.contextAccessPoints.forEach(t=>{(t.pattern.includes("watch")||t.pattern.includes("read"))&&i.push(t.dependent)}),i}traceProviderFlow(e){return"MyApp -> Provider -> MaterialApp -> [consumers]"}inferType(e){if(!e)return"any";if(e.type==="Literal"){const i=e.value;if(typeof i=="string")return"string";if(typeof i=="number")return"number";if(typeof i=="boolean")return"boolean"}return"any"}inferReturnType(e){return"any"}hasDefaultValue(e){return e.initialValue!==null&&e.initialValue!==void 0}expressionToString(e){return e?e.type==="Identifier"?e.name:e.type==="Literal"?String(e.value):JSON.stringify(e).substring(0,50):"null"}getResults(){return{inheritedWidgets:Array.from(this.inheritedWidgets.values()),changeNotifiers:Array.from(this.changeNotifiers.values()),providers:Array.from(this.providers.values()),contextAccessPoints:this.contextAccessPoints,inheritedWidgetGraph:this.inheritedWidgetGraph,providerGraph:this.providerGraph,errors:this.errors}}}export{f as ContextAnalyzer};
//# sourceMappingURL=context_analyzer.js.map
