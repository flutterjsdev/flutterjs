import{HydrationRequirement as a,LazyLoadOpportunity as o}from"./context_analyzer_data.js";import{getLogger as c}from"./flutterjs_logger.js";class l{constructor(t,e=null,s={}){this.contextResults=t,this.stateResults=e,this.options={strict:!1,targetPlatform:"node",...s},this.logger=c().createComponentLogger("SSRAnalyzer"),this.ssrSafePatterns=[],this.ssrUnsafePatterns=[],this.hydrationRequirements=[],this.lazyLoadOpportunities=[],this.ssrMigrationPath=[],this.validationIssues=[],this.ssrCompatibilityScore=0,this.hydrationCount=0,this.errors=[]}analyze(){this.logger.startSession("SSRAnalysis"),this.logger.info("Starting SSR compatibility analysis");try{return this.detectSsrSafePatterns(),this.logger.count("SSR-safe patterns found",this.ssrSafePatterns.length),this.detectSsrUnsafePatterns(),this.logger.count("SSR-unsafe patterns found",this.ssrUnsafePatterns.length),this.identifyHydrationNeeds(),this.logger.count("Hydration dependencies",this.hydrationRequirements.length),this.detectLazyLoadOpportunities(),this.logger.count("Lazy load opportunities",this.lazyLoadOpportunities.length),this.generateMigrationPath(),this.logger.count("Migration steps",this.ssrMigrationPath.length),this.validateSsrRequirements(),this.calculateCompatibilityScore(),this.logger.count("SSR Compatibility Score",this.ssrCompatibilityScore),this.logger.success("SSR analysis complete"),this.logger.endSession("SSRAnalysis"),this.getResults()}catch(t){return this.logger.failure("SSR analysis failed",t.message),this.errors.push(t),this.logger.endSession("SSRAnalysis"),this.getResults()}}detectSsrSafePatterns(){const t=[];t.push({pattern:"InheritedWidget static accessors",example:"ThemeProvider.of(context)",safeFor:"SSR",why:"Pure value access, no subscription required",confidence:1,category:"context-access",frequency:0}),t.push({pattern:"context.read<T>() in build()",example:"context.read<CounterNotifier>()",safeFor:"SSR",why:"Single read at render time, no re-subscription needed",confidence:.95,category:"provider-access",frequency:0}),t.push({pattern:"Theme data access",example:"theme.primaryColor",safeFor:"SSR",why:"Read-only during rendering",confidence:1,category:"value-access",frequency:0}),t.push({pattern:"MediaQuery.of() for responsive layout",example:"MediaQuery.of(context).size.width",safeFor:"SSR",why:"Server can set default viewport; client hydrates with actual size",confidence:.85,category:"responsive-design",frequency:0}),t.push({pattern:"Async data in FutureBuilder (with cached data)",example:"FutureBuilder with pre-fetched data",safeFor:"SSR",why:"Server can execute async, pass pre-rendered HTML to client",confidence:.8,category:"async-operation",frequency:0}),this.contextResults&&this.contextResults.contextAccessPoints&&this.contextResults.contextAccessPoints.forEach(e=>{if(e.ssrSafe){const s=t.find(i=>i.example.includes(e.pattern.split("(")[0]));s&&s.frequency++,this.ssrSafePatterns.push({pattern:e.pattern,type:e.type,location:e.location,example:e.pattern,why:e.reason,confidence:.95})}}),this.ssrSafePatterns.push(...t)}detectSsrUnsafePatterns(){const t=[{pattern:"context.watch<T>() subscriptions",example:"context.watch<CounterNotifier>()",unsafeFor:"SSR",why:"Requires reactive subscription & listeners on client, not available during server render",confidence:1,category:"provider-subscription",severity:"error",frequency:0},{pattern:"State mutations in event handlers",example:"counter.increment() in onPressed",unsafeFor:"SSR",why:"Event handlers don't exist on server, mutations have no effect",confidence:1,category:"state-mutation",severity:"error",frequency:0},{pattern:"ChangeNotifier.notifyListeners() calls",example:"notifyListeners() in method",unsafeFor:"SSR",why:"Listeners don't exist during initial SSR render",confidence:.95,category:"notification",severity:"error",frequency:0},{pattern:"Browser APIs",example:"window.localStorage, document.getElementById()",unsafeFor:"SSR",why:"window and document objects don't exist on Node.js server",confidence:1,category:"browser-api",severity:"critical",frequency:0},{pattern:"Timers and intervals",example:"setTimeout, setInterval, setImmediate",unsafeFor:"SSR",why:"Can cause unexpected behavior and performance issues during server render",confidence:.9,category:"async-operation",severity:"warning",frequency:0},{pattern:"Random values without seeding",example:"Math.random()",unsafeFor:"SSR",why:"Different values on server vs client cause hydration mismatch",confidence:.99,category:"determinism",severity:"error",frequency:0},{pattern:"Navigator and route access",example:"Navigator.of(context).push()",unsafeFor:"SSR",why:"Navigation happens on client, not on server",confidence:1,category:"navigation",severity:"warning",frequency:0},{pattern:"GestureDetector and event handlers",example:"GestureDetector, onTap, onLongPress",unsafeFor:"SSR",why:"User interactions don't exist on server",confidence:1,category:"user-interaction",severity:"warning",frequency:0},{pattern:"setState in initState or build",example:"this.setState(() => {...}) in build()",unsafeFor:"SSR",why:"Triggers re-render during render cycle, can cause infinite loops",confidence:.95,category:"state-management",severity:"critical",frequency:0}];this.contextResults&&this.contextResults.contextAccessPoints&&this.contextResults.contextAccessPoints.forEach(e=>{if(!e.ssrSafe){const s=t.find(i=>i.example.includes(e.pattern.split("(")[0]));s&&s.frequency++,this.ssrUnsafePatterns.push({pattern:e.pattern,type:e.type,location:e.location,example:e.pattern,why:e.reason,confidence:.95,severity:"error",suggestion:e.getMigrationAdvice?.()||"Refactor to SSR-safe pattern"})}}),this.ssrUnsafePatterns.push(...t)}identifyHydrationNeeds(){const t=[];this.contextResults&&this.contextResults.changeNotifiers&&this.contextResults.changeNotifiers.forEach(e=>{if(e.consumers&&e.consumers.length>0){const s=new a(e.name,`State needs to be re-created and listeners re-attached post-hydration for ${e.consumers.length} consumer(s)`,0);e.consumers.forEach(i=>{s.requiredState.push(`${i}.state`)}),t.push(s),this.hydrationCount++}}),this.contextResults&&this.contextResults.providers&&this.contextResults.providers.forEach(e=>{if(e.accessPatterns&&e.accessPatterns.includes("watch")){const s=new a(`Provider<${e.valueType}>`,"context.watch() subscriptions need to be re-established on client for reactive updates",1);s.requiresProvider(e.providerType),t.push(s),this.hydrationCount++}}),this.stateResults&&this.stateResults.eventHandlers&&this.stateResults.eventHandlers.forEach(e=>{if(!t.some(s=>s.dependency===e.handler)){const s=new a(e.handler,`Event handler "${e.handler}" must be attached to DOM after hydration`,2);t.push(s),this.hydrationCount++}}),t.sort((e,s)=>e.order-s.order),this.hydrationRequirements=t}detectLazyLoadOpportunities(){const t=[];this.contextResults&&this.contextResults.inheritedWidgets&&this.contextResults.inheritedWidgets.forEach(e=>{if(e.usageCount===0||e.usageCount&&e.usageCount<=1){const s=new o(e.name,`${e.name} is not needed until user navigates to it`,"15KB","widget");s.setRecommendation("Use LazyRoute or dynamic import: import(widgetPath)"),s.calculatePriority(15),t.push(s)}}),this.contextResults&&this.contextResults.changeNotifiers&&this.contextResults.changeNotifiers.forEach(e=>{if(e.methods&&e.methods.length>10){const s=new o(e.name,`${e.name} is complex and only needed if feature is used`,"8KB","notifier");s.setRecommendation("Lazy create in Provider: create: (context) => Provider.lazy(() => import(...))"),s.calculatePriority(8),t.push(s)}}),this.lazyLoadOpportunities=t}generateMigrationPath(){const t=[],e=this.ssrUnsafePatterns.filter(r=>r.pattern?.includes("watch"));e.length>0&&t.push({step:1,action:"Replace context.watch() with context.read() for SSR",locations:e.map(r=>r.location),description:`Found ${e.length} context.watch() calls that need refactoring`,example:`
// Before (not SSR safe):
final counter = context.watch<CounterNotifier>();

// After (SSR safe):
final counter = context.read<CounterNotifier>();
// Subscribe to changes in didChangeDependencies() instead (client-only)`,effort:"medium",priority:"high",files:e.length});const s=this.ssrUnsafePatterns.filter(r=>r.pattern?.includes("mutation"));s.length>0&&t.push({step:2,action:"Move notifyListeners() calls to client-only code",locations:s.map(r=>r.location),description:`Found ${s.length} state mutations that don't work in SSR`,example:`
// Before (not SSR safe):
counter.increment();

// After (SSR safe):
if (kIsWeb) {  // Only on client
  counter.increment();
}`,effort:"low",priority:"high",files:s.length}),this.hydrationRequirements.length>0&&t.push({step:3,action:"Create hydration layer to re-subscribe listeners post-render",description:`App requires hydration for ${this.hydrationRequirements.length} dependencies`,example:`
// In main.js or app.dart after runApp():
if (kIsWeb) {
  // Re-create listeners, reattach subscriptions
  hydrate(flutterApp);
}`,effort:"high",priority:"critical",dependencies:this.hydrationRequirements.length});const i=this.ssrUnsafePatterns.filter(r=>r.category==="browser-api");i.length>0&&t.push({step:4,action:"Wrap browser-specific APIs in kIsWeb checks",description:`Found ${i.length} browser API calls`,example:`
// Before:
final stored = window.localStorage.getItem('key');

// After:
final stored = kIsWeb ? window.localStorage.getItem('key') : null;`,effort:"low",priority:"medium",files:i.length}),this.lazyLoadOpportunities.length>0&&t.push({step:5,action:"Implement code splitting for lazy-loaded widgets",description:`${this.lazyLoadOpportunities.length} opportunities identified`,example:`
// Use dynamic routes
final route = await LazyRoute.create(
  () => import('pages/DetailPage.dart')
);`,effort:"medium",priority:"low",opportunities:this.lazyLoadOpportunities.length}),t.push({step:t.length+1,action:"Set up SSR testing pipeline",description:"Render app on server, verify HTML structure",example:`
// Test SSR output matches CSR:
const serverHtml = await renderAppOnServer();
const clientHtml = await renderAppOnClient();
assert(serverHtml === clientHtml, 'SSR/CSR mismatch');`,effort:"medium",priority:"critical"}),this.ssrMigrationPath=t}validateSsrRequirements(){this.ssrUnsafePatterns.forEach(e=>{e.category==="browser-api"&&this.validationIssues.push({type:"browser-api-usage",severity:"critical",pattern:e.pattern,location:e.location,message:`Browser API "${e.pattern}" is not available on server`,suggestion:"Wrap in kIsWeb check or use platform-agnostic alternative"})}),this.ssrUnsafePatterns.forEach(e=>{e.category==="determinism"&&this.validationIssues.push({type:"non-deterministic",severity:"error",pattern:e.pattern,location:e.location,message:`Non-deterministic operation "${e.pattern}" causes hydration mismatch`,suggestion:"Use seeded random or remove randomness from render path"})});const t=this.ssrUnsafePatterns.filter(e=>e.category==="user-interaction");t.length>0&&this.validationIssues.push({type:"event-handlers-in-build",severity:"warning",count:t.length,message:`${t.length} event handlers defined in build() - they'll be recreated on every render`,suggestion:"Move event handler definitions to initState or class level"}),this.hydrationRequirements.length>0&&this.ssrMigrationPath.length===0&&this.validationIssues.push({type:"incomplete-hydration",severity:"error",message:`App has ${this.hydrationRequirements.length} hydration needs but no hydration layer implemented`,suggestion:"Add hydration step to migration path"})}calculateCompatibilityScore(){let t=100;const e=this.ssrUnsafePatterns.length;t-=Math.min(e*5,40);const s=this.validationIssues.filter(n=>n.severity==="critical");t-=s.length*15;const i=this.validationIssues.filter(n=>n.type==="browser-api-usage");t-=i.length*10;const r=this.ssrSafePatterns.length;r>0&&(t+=Math.min(r*2,15)),this.ssrMigrationPath.length>3&&(t+=10),this.ssrCompatibilityScore=Math.max(0,Math.min(100,t))}getOverallCompatibility(){return this.ssrCompatibilityScore>=85?"full":this.ssrCompatibilityScore>=60?"partial":this.ssrCompatibilityScore>=30?"limited":"none"}getEstimatedEffort(){const t=this.ssrMigrationPath.reduce((e,s)=>e+({low:1,medium:2,high:3}[s.effort]||0),0);return t<=3?"minimal":t<=6?"moderate":t<=9?"significant":"major-rewrite"}getResults(){const t=this.validationIssues.filter(e=>e.severity==="critical");return{overallCompatibility:this.getOverallCompatibility(),ssrCompatibilityScore:this.ssrCompatibilityScore,ssrReadinessScore:this.ssrCompatibilityScore,ssrSafePatterns:this.ssrSafePatterns,ssrUnsafePatterns:this.ssrUnsafePatterns,hydrationRequirements:this.hydrationRequirements,hydrationCount:this.hydrationCount,lazyLoadOpportunities:this.lazyLoadOpportunities,ssrMigrationPath:this.ssrMigrationPath,estimatedEffort:this.getEstimatedEffort(),validationIssues:this.validationIssues,criticalIssues:t,warningIssues:this.validationIssues.filter(e=>e.severity==="warning"),summary:{compatibility:this.getOverallCompatibility(),score:this.ssrCompatibilityScore,safePatterns:this.ssrSafePatterns.length,unsafePatterns:this.ssrUnsafePatterns.length,hydrationNeeded:this.hydrationCount,migrationSteps:this.ssrMigrationPath.length,criticalIssues:t.length,effort:this.getEstimatedEffort()},errors:this.errors}}}export{l as SSRAnalyzer};
//# sourceMappingURL=ssr_analyzer.js.map
