import{getLogger as u}from"./flutterjs_logger.js";class d{constructor(t,e={}){this.ast=t,this.options={strict:!1,...e},this.logger=u().createComponentLogger("WidgetAnalyzer"),this.widgets=new Map,this.functions=new Map,this.imports=[],this.externalDependencies=new Set,this.entryPoint=null,this.rootWidget=null,this.widgetTree=null,this.errors=[]}analyze(){if(this.logger.startSession("WidgetAnalyzer"),!this.ast||!this.ast.body)throw new Error("Invalid AST provided");this.logger.trace("[WidgetAnalyzer] Starting analysis...");try{return this.logger.trace("[WidgetAnalyzer] Phase 1: Extracting classes and functions..."),this.extractClassesAndFunctions(),this.logger.trace(`[WidgetAnalyzer]   Found ${this.widgets.size} classes in total`),this.logger.trace("[WidgetAnalyzer] Phase 2: Detecting widgets..."),this.detectWidgets(),this.logger.trace(`[WidgetAnalyzer]   Detected widgets: ${Array.from(this.widgets.values()).filter(t=>t.type!=="class").length}`),this.logger.trace("[WidgetAnalyzer] Phase 3: Extracting imports..."),this.extractImports(),this.logger.trace(`[WidgetAnalyzer]   Found ${this.imports.length} imports`),this.logger.trace("[WidgetAnalyzer] Phase 4: Finding entry point..."),this.findEntryPoint(),this.logger.trace(`[WidgetAnalyzer]   Entry point: ${this.entryPoint||"NOT FOUND"}`),this.logger.trace("[WidgetAnalyzer] Phase 5: Building widget tree..."),this.buildWidgetTree(),this.logger.trace(`[WidgetAnalyzer]   Tree root: ${this.rootWidget||"NOT FOUND"}`),this.logger.trace(`[WidgetAnalyzer] Analysis complete
`),this.getResults()}catch(t){return this.errors.push({type:"analysis-error",message:t.message,stack:t.stack}),this.getResults()}}extractClassesAndFunctions(){if(this.ast.body)for(const t of this.ast.body)t.type==="ClassDeclaration"?this.extractClassDeclaration(t):t.type==="FunctionDeclaration"&&this.extractFunctionDeclaration(t)}extractClassDeclaration(t){const e=t.id?.name;if(!e)return;const i=t.superClass?.name||null,r=t.location,s={name:e,type:"class",location:r,superClass:i,constructor:null,properties:[],methods:[],fieldReferences:{},imports:[],children:[],linkedStateClass:null};if(t.body?.fields&&t.body.fields.forEach(a=>{const n=a.key?.name,o=a.initialValue?this.expressionToString(a.initialValue):null;s.properties.push({name:n,initialValue:o,type:this.inferFieldType(a.initialValue)}),s.fieldReferences[n]||(s.fieldReferences[n]=[])}),t.body?.methods){const a=t.body.methods.find(n=>n.key?.name==="constructor");a&&(s.constructor={name:"constructor",params:a.params||[],location:a.location}),t.body.methods.forEach(n=>{if(n.key?.name!=="constructor"){const o=n.key?.name,l={name:o,params:n.params||[],location:n.location,hasBody:n.body!==null,usesFields:[]};if(n.body){const c=this.findFieldReferencesInBody(n.body);l.usesFields=c,c.forEach(g=>{s.fieldReferences[g]&&s.fieldReferences[g].push(o)})}s.methods.push(l)}})}this.widgets.set(e,s),this.logger.trace(`[WidgetAnalyzer]     Extracted class: ${e} extends ${i}`),s.properties.length>0&&this.logger.trace(`[WidgetAnalyzer]       Fields: ${s.properties.map(a=>`${a.name}=${a.initialValue}`).join(", ")}`)}findFieldReferencesInBody(t){const e=[],i=r=>{if(r){r.type==="MemberExpression"&&r.object?.name==="this"&&r.property?.name&&e.push(r.property.name);for(const s in r)s!=="location"&&typeof r[s]=="object"&&(Array.isArray(r[s])?r[s].forEach(i):i(r[s]))}};return i(t),[...new Set(e)]}inferFieldType(t){if(!t)return"any";if(t.type==="Literal"){const e=t.value;if(typeof e=="number")return"int"|"double";if(typeof e=="boolean")return"bool";if(typeof e=="string")return"String";if(e===null)return"null"}return t.type==="Identifier"?t.name:t.type==="ArrayExpression"?"List":t.type==="ObjectExpression"?"Map":"dynamic"}extractFunctionDeclaration(t){const e=t.id?.name||"anonymous",i=t.location,r={name:e,type:"function",location:i,params:t.params?.map(s=>({name:s.name?.name||"param",optional:s.optional||!1}))||[],isAsync:t.isAsync||!1,isEntryPoint:!1};this.functions.set(e,r)}detectWidgets(){this.widgets.forEach(t=>{if(!t.superClass){t.type="class";return}const e=t.superClass;e==="StatelessWidget"?(t.type="stateless",this.logger.trace(`[WidgetAnalyzer]     ${t.name} is StatelessWidget`)):e==="StatefulWidget"?(t.type="stateful",this.logger.trace(`[WidgetAnalyzer]     ${t.name} is StatefulWidget`)):e?.startsWith("State")?(t.type="state",this.logger.trace(`[WidgetAnalyzer]     ${t.name} is State class`)):t.type="component"})}extractImports(){this.ast.body&&this.ast.body.forEach(t=>{if(t.type==="ImportDeclaration"){const e=t.source?.value,i=t.specifiers?.map(r=>r.local?.name||r.imported?.name)||[];this.imports.push({source:e,items:i,specifiers:t.specifiers}),this.externalDependencies.add(e)}})}findEntryPoint(){if(this.functions.has("main")){this.entryPoint="main";const t=this.functions.get("main");t.isEntryPoint=!0;const e=this.ast.body.find(i=>i.type==="FunctionDeclaration"&&i.id?.name==="main");e?.body?.body&&(this.rootWidget=this.findRunAppWidget(e.body.body))}}findRunAppWidget(t){for(const e of t){if(e.type==="ExpressionStatement"&&e.expression?.type==="CallExpression"){const i=e.expression;if(i.callee?.name==="runApp"&&i.args?.length>0)return this.getWidgetNameFromExpression(i.args[0])}if(e.type==="ReturnStatement"&&e.argument?.type==="CallExpression"){const i=e.argument;if(i.callee?.name==="runApp"&&i.args?.length>0)return this.getWidgetNameFromExpression(i.args[0])}}return null}getWidgetNameFromExpression(t){return t?t.type==="NewExpression"||t.type==="CallExpression"?t.callee?.name:t.type==="Identifier"?t.name:null:null}buildWidgetTree(){if(!this.rootWidget||!this.widgets.has(this.rootWidget))return;const t=this.widgets.get(this.rootWidget);this.widgetTree={widget:t,depth:0,children:[]}}expressionToString(t){if(!t)return null;if(t.type==="Literal")return t.value;if(t.type==="Identifier"){const e=t.name;return e==="true"||e==="false"?e==="true":e==="null"?null:e==="undefined"?void 0:e}}getResults(){const t=Array.from(this.widgets.values()).filter(e=>e.type==="stateless"||e.type==="stateful"||e.type==="state"||e.type==="component");return this.logger.trace(`[WidgetAnalyzer] getResults() returning ${t.length} widgets`),{widgets:t,functions:Array.from(this.functions.values()),imports:this.imports,externalDependencies:Array.from(this.externalDependencies),entryPoint:this.entryPoint,rootWidget:this.rootWidget,widgetTree:this.widgetTree,errors:this.errors}}getSummary(){const t=Array.from(this.widgets.values()),e=t.filter(s=>s.type==="stateless").length,i=t.filter(s=>s.type==="stateful").length,r=t.filter(s=>s.type==="state").length;return{totalWidgets:t.length,statelessWidgets:e,statefulWidgets:i,stateClasses:r,totalFunctions:this.functions.size,totalImports:this.imports.length,externalPackages:this.externalDependencies.size,entryPoint:this.entryPoint,rootWidget:this.rootWidget}}getErrors(){return this.errors}}export{d as WidgetAnalyzer};
//# sourceMappingURL=flutterjs_widget_analyzer.js.map
