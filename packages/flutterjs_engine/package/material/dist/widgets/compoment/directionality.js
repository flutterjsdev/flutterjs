import{InheritedWidget as g}from"../../core/widget_element.js";import{InheritedElement as f}from"@flutterjs/runtime/element";import{BlendMode as u}from"./opacity.js";import{VNode as p}from"@flutterjs/vdom/vnode";class c extends f{constructor(e){super(e),this._dependencies=new Map}setDependencies(e,t){}getDependencies(e){return null}notifyDependents(e=null){const t=e||this.widget;this._recurseChildren(i=>{this._doesDependOnInheritedElement(i)&&this._notifyDependent(t,i)})}_recurseChildren(e){this.visitChildren(t=>{this._recurseChildrenHelper(t,e)}),e(this)}_recurseChildrenHelper(e,t){e&&(e.visitChildren&&e.visitChildren(i=>{this._recurseChildrenHelper(i,t)}),t(e))}_doesDependOnInheritedElement(e){return this._dependents.has(e)}_notifyDependent(e,t){t&&t._mounted&&!t._deactivated&&(t.didChangeDependencies?t.didChangeDependencies():t.state&&t.state.didChangeDependencies&&t.state.didChangeDependencies())}performRebuild(){const e=!this._child||this.widget.updateShouldNotify(this._child.widget),t=super.performRebuild();return e&&this.notifyDependents(),t}debugFillProperties(e){super.debugFillProperties(e),e.push({name:"dependentCount",value:this._dependents.size})}}class d extends g{constructor({key:e=null,child:t=null}={}){if(super({key:e,child:t}),new.target===d)throw new Error("UbiquitousInheritedWidget is abstract")}createElement(){return new c(this)}updateShouldNotify(e){throw new Error(`${this.constructor.name}.updateShouldNotify() must be implemented`)}}class o extends d{constructor({key:e=null,shaderCallback:t=null,blendMode:i=u.modulate,child:n=null}={}){if(super({key:e,child:n}),t&&typeof t!="function")throw new Error(`ShaderMaskProvider requires a shaderCallback function, got: ${typeof t}`);if(i&&!Object.values(u).includes(i))throw new Error(`Invalid blendMode: ${i}`);this.shaderCallback=t,this.blendMode=i,this._containerElement=null,this._maskImageUrl=null}static of(e){const t=e.dependOnInheritedWidgetOfExactType(o);if(!t)throw new Error("ShaderMaskProvider.of() called with a context that does not contain a ShaderMaskProvider widget. Make sure to wrap your widget tree with a ShaderMaskProvider widget.");return t}static maybeOf(e){return e.getInheritedWidgetOfExactType(o)||null}updateShouldNotify(e){return this.shaderCallback!==e.shaderCallback||this.blendMode!==e.blendMode}build(e){const t=e.element.getElementId(),i=e.element.getWidgetPath();let n=null;if(this.child)if(this.child.createElement){const r=this.child.createElement();r.mount(e.element),n=r.performRebuild()}else n=this.child;return new p({tag:"div",props:{style:{position:"relative",overflow:"hidden",display:"inline-block"},"data-element-id":t,"data-widget-path":i,"data-widget":"ShaderMaskProvider","data-blend-mode":this.blendMode,ref:r=>this._onContainerMount(r,e)},children:[new p({tag:"div",props:{style:{position:"relative",width:"100%",height:"100%"},"data-widget":"ShaderMaskContent"},children:n?[n]:[]})],key:this.key})}_onContainerMount(e,t){if(!e)return;this._containerElement=e,this.shaderCallback&&this._containerElement&&this._generateAndApplyShaderMask();const i=()=>{this.shaderCallback&&this._containerElement&&this._generateAndApplyShaderMask()};window.addEventListener("resize",i),e._cleanupResize=()=>{window.removeEventListener("resize",i)}}_generateAndApplyShaderMask(){if(!(!this._containerElement||!this.shaderCallback))try{const e=this._containerElement.getBoundingClientRect(),t={width:Math.ceil(e.width)||200,height:Math.ceil(e.height)||200},i=this.shaderCallback(t);this._applyShaderToContainer(i,t)}catch(e){console.error("Error rendering shader mask:",e)}}_applyShaderToContainer(e,t){if(!(!this._containerElement||!e)){if(e.type==="gradient"&&e.gradient){const i=this._createGradientMask(e.gradient,t);this._applyMaskImage(i)}e.type==="svg"&&e.svgContent&&this._applyMaskImage(`url('data:image/svg+xml;utf8,${encodeURIComponent(e.svgContent)}')`),e.type==="url"&&e.url&&this._applyMaskImage(`url('${e.url}')`),e.maskImage&&this._applyMaskImage(e.maskImage),this.blendMode&&(this._containerElement.style.mixBlendMode=this.blendMode)}}_applyMaskImage(e){!this._containerElement||!e||(this._containerElement.style.WebkitMaskImage=e,this._containerElement.style.WebkitMaskSize="100% 100%",this._containerElement.style.WebkitMaskRepeat="no-repeat",this._containerElement.style.WebkitMaskPosition="0 0",this._containerElement.style.maskImage=e,this._containerElement.style.maskSize="100% 100%",this._containerElement.style.maskRepeat="no-repeat",this._containerElement.style.maskPosition="0 0",this._maskImageUrl=e)}_createGradientMask(e,t){const i="http://www.w3.org/2000/svg",n=document.createElementNS(i,"svg");n.setAttribute("width",t.width),n.setAttribute("height",t.height),n.setAttribute("viewBox",`0 0 ${t.width} ${t.height}`);const r=document.createElementNS(i,"defs"),s=document.createElementNS(i,"linearGradient");s.setAttribute("id","maskGradient"),s.setAttribute("x1","0%"),s.setAttribute("y1","0%"),s.setAttribute("x2","100%"),s.setAttribute("y2","0%"),[{offset:"0%",color:"#000000",opacity:"1"},{offset:"100%",color:"#000000",opacity:"0"}].forEach(h=>{const l=document.createElementNS(i,"stop");l.setAttribute("offset",h.offset),l.setAttribute("stop-color",h.color),l.setAttribute("stop-opacity",h.opacity),s.appendChild(l)}),r.appendChild(s),n.appendChild(r);const a=document.createElementNS(i,"rect");a.setAttribute("width",t.width),a.setAttribute("height",t.height),a.setAttribute("fill","url(#maskGradient)"),n.appendChild(a);const m=new XMLSerializer().serializeToString(n);return`url('data:image/svg+xml;utf8,${encodeURIComponent(m)}')`}debugFillProperties(e){super.debugFillProperties(e),e.push({name:"blendMode",value:this.blendMode}),this.shaderCallback&&e.push({name:"shaderCallback",value:"function"}),this._maskImageUrl&&e.push({name:"maskApplied",value:"true"})}createElement(){return new c(this)}}export{o as ShaderMaskProvider,c as UbiquitousInheritedElement,d as UbiquitousInheritedWidget};
//# sourceMappingURL=directionality.js.map
