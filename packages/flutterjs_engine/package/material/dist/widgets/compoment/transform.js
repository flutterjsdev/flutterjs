import{ProxyWidget as u}from"../../core/widget_element.js";import{VNode as g}from"@flutterjs/vdom/vnode";import{Offset as w,Alignment as c}from"../../utils/utils.js";class a{constructor(t=null){t?this.storage=t:(this.storage=new Array(16).fill(0),this.storage[0]=1,this.storage[5]=1,this.storage[10]=1,this.storage[15]=1)}static identity(){return new a}static translationValues(t,e,n=0){const r=new a;return r.storage[12]=t,r.storage[13]=e,r.storage[14]=n,r}static diagonal3Values(t,e,n){const r=new a;return r.storage[0]=t,r.storage[5]=e,r.storage[10]=n,r}static rotationZ(t){const e=Math.sin(t),n=Math.cos(t),r=new a;return r.storage[0]=n,r.storage[1]=e,r.storage[4]=-e,r.storage[5]=n,r}toCSSMatrix(){const t=this.storage;return`matrix3d(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}, ${t[4]}, ${t[5]}, ${t[6]}, ${t[7]}, ${t[8]}, ${t[9]}, ${t[10]}, ${t[11]}, ${t[12]}, ${t[13]}, ${t[14]}, ${t[15]})`}toString(){return`Matrix4(${this.storage.join(", ")})`}}const o={low:"low",medium:"medium",high:"high"};class d extends u{constructor({key:t=null,transform:e=null,origin:n=null,alignment:r=null,transformHitTests:i=!0,filterQuality:s=o.low,child:l=null}={}){if(super({key:t,child:l}),!e)throw new Error("Transform requires a transform (Matrix4)");this.transform=e,this.origin=n,this.alignment=r,this.transformHitTests=i,this.filterQuality=s,this._renderObject=null}static rotate({key:t=null,angle:e=0,origin:n=null,alignment:r=c.center,transformHitTests:i=!0,filterQuality:s=o.low,child:l=null}={}){return new d({key:t,transform:a.rotationZ(e),origin:n,alignment:r,transformHitTests:i,filterQuality:s,child:l})}static translate({key:t=null,offset:e=null,transformHitTests:n=!0,filterQuality:r=o.low,child:i=null}={}){if(!e)throw new Error("Transform.translate requires an offset");return new d({key:t,transform:a.translationValues(e.dx,e.dy,0),origin:null,alignment:null,transformHitTests:n,filterQuality:r,child:i})}static scale({key:t=null,scale:e=null,scaleX:n=null,scaleY:r=null,origin:i=null,alignment:s=c.center,transformHitTests:l=!0,filterQuality:m=o.low,child:f=null}={}){if(e===null&&n===null&&r===null)throw new Error("At least one of 'scale', 'scaleX' and 'scaleY' is required to be non-null");if(e!==null&&(n!==null||r!==null))throw new Error("If 'scale' is non-null then 'scaleX' and 'scaleY' must be left null");const b=e??n??1,_=e??r??1;return new d({key:t,transform:a.diagonal3Values(b,_,1),origin:i,alignment:s,transformHitTests:l,filterQuality:m,child:f})}static flip({key:t=null,flipX:e=!1,flipY:n=!1,origin:r=null,transformHitTests:i=!0,filterQuality:s=o.low,child:l=null}={}){return new d({key:t,transform:a.diagonal3Values(e?-1:1,n?-1:1,1),origin:r,alignment:c.center,transformHitTests:i,filterQuality:s,child:l})}createRenderObject(t){return new p({transform:this.transform,origin:this.origin,alignment:this.alignment,transformHitTests:this.transformHitTests,filterQuality:this.filterQuality})}updateRenderObject(t,e){e.transform=this.transform,e.origin=this.origin,e.alignment=this.alignment,e.transformHitTests=this.transformHitTests,e.filterQuality=this.filterQuality}build(t){this._renderObject?this.updateRenderObject(t,this._renderObject):this._renderObject=this.createRenderObject(t);let e=null;if(this.child){const f=this.child.createElement(t.element,t.element.runtime);f.mount(t.element),e=f.performRebuild()}const n=t.element.getElementId(),r=t.element.getWidgetPath(),i=this._generateTransformCSS(),s=this._generateTransformOrigin(),l=this._getFilterCSS(),m={transform:i,transformOrigin:s,position:"relative",filter:l};return new g({tag:"div",props:{style:m,"data-element-id":n,"data-widget-path":r,"data-widget":"Transform","data-filter-quality":this.filterQuality,"data-transform-hit-tests":this.transformHitTests},children:e?[e]:[],key:this.key})}_generateTransformCSS(){return this.transform?this.transform.toCSSMatrix():"none"}_generateTransformOrigin(){if(this.origin)return`${this.origin.dx}px ${this.origin.dy}px`;if(this.alignment){const t=(this.alignment.x+1)/2*100,e=(this.alignment.y+1)/2*100;return`${t}% ${e}%`}return"50% 50%"}_getFilterCSS(){switch(this.filterQuality){case o.high:return"blur(0px)";case o.medium:return"blur(0.5px)";case o.low:default:return"none"}}debugFillProperties(t){super.debugFillProperties(t),t.push({name:"transform",value:this.transform.toString()}),this.origin&&t.push({name:"origin",value:this.origin.toString()}),this.alignment&&t.push({name:"alignment",value:this.alignment.toString()}),t.push({name:"transformHitTests",value:this.transformHitTests}),t.push({name:"filterQuality",value:this.filterQuality})}createElement(t,e){return new E(this,t,e)}}class p{constructor({transform:t=null,origin:e=null,alignment:n=null,transformHitTests:r=!0,filterQuality:i=o.low}={}){this.transform=t,this.origin=e,this.alignment=n,this.transformHitTests=r,this.filterQuality=i}debugInfo(){return{type:"RenderTransform",transform:this.transform?.toString(),origin:this.origin?.toString(),alignment:this.alignment?.toString(),transformHitTests:this.transformHitTests,filterQuality:this.filterQuality}}}class E extends u.constructor.prototype.constructor{performRebuild(){return this.widget.build(this.context)}}class T{constructor(){this._target=null,this._followers=new Set}get target(){return this._target}set target(t){this._target=t}addFollower(t){this._followers.add(t)}removeFollower(t){this._followers.delete(t)}getFollowers(){return Array.from(this._followers)}}class A extends u{constructor({key:t=null,link:e=null,child:n=null}={}){if(super({key:t,child:n}),!e)throw new Error("CompositedTransformTarget requires a LayerLink");this.link=e,this._renderObject=null,this._targetElement=null}createRenderObject(t){return new y({link:this.link})}updateRenderObject(t,e){e.link=this.link}build(t){this._renderObject?this.updateRenderObject(t,this._renderObject):this._renderObject=this.createRenderObject(t);let e=null;if(this.child){const i=this.child.createElement(t.element,t.element.runtime);i.mount(t.element),e=i.performRebuild()}const n=t.element.getElementId(),r=t.element.getWidgetPath();return new g({tag:"div",props:{style:{position:"relative"},"data-element-id":n,"data-widget-path":r,"data-widget":"CompositedTransformTarget","data-layer-link":this.link.constructor.name,ref:i=>this._onMount(i)},children:e?[e]:[],key:this.key})}_onMount(t){if(!t||!this.link)return;this._targetElement=t,this.link.target=t,this.link.getFollowers().forEach(n=>{n._updatePosition&&n._updatePosition()})}debugFillProperties(t){super.debugFillProperties(t),t.push({name:"link",value:"LayerLink"})}createElement(t,e){return new R(this,t,e)}}class y{constructor({link:t=null}={}){this.link=t}debugInfo(){return{type:"RenderLeaderLayer",hasLink:!!this.link}}}class R extends u.constructor.prototype.constructor{performRebuild(){return this.widget.build(this.context)}}class S extends u{constructor({key:t=null,link:e=null,showWhenUnlinked:n=!0,offset:r=null,targetAnchor:i=c.topLeft,followerAnchor:s=c.topLeft,child:l=null}={}){if(super({key:t,child:l}),!e)throw new Error("CompositedTransformFollower requires a LayerLink");this.link=e,this.showWhenUnlinked=n,this.offset=r||w.zero,this.targetAnchor=i,this.followerAnchor=s,this._renderObject=null,this._followerElement=null}createRenderObject(t){return new k({link:this.link,showWhenUnlinked:this.showWhenUnlinked,offset:this.offset,leaderAnchor:this.targetAnchor,followerAnchor:this.followerAnchor})}updateRenderObject(t,e){e.link=this.link,e.showWhenUnlinked=this.showWhenUnlinked,e.offset=this.offset,e.leaderAnchor=this.targetAnchor,e.followerAnchor=this.followerAnchor}build(t){this._renderObject?this.updateRenderObject(t,this._renderObject):this._renderObject=this.createRenderObject(t);let e=null;if(this.child){const s=this.child.createElement(t.element,t.element.runtime);s.mount(t.element),e=s.performRebuild()}const n=t.element.getElementId(),r=t.element.getWidgetPath(),i={position:"absolute",visibility:this.showWhenUnlinked?"visible":"hidden"};return new g({tag:"div",props:{style:i,"data-element-id":n,"data-widget-path":r,"data-widget":"CompositedTransformFollower","data-layer-link":this.link.constructor.name,ref:s=>this._onMount(s)},children:e?[e]:[],key:this.key})}_onMount(t){!t||!this.link||(this._followerElement=t,this.link.addFollower(this),this._updatePosition())}_updatePosition(){if(!(!this._followerElement||!this.link.target))try{const t=this.link.target.getBoundingClientRect(),e=this._followerElement.getBoundingClientRect(),n=(this.targetAnchor.x+1)/2*t.width,r=(this.targetAnchor.y+1)/2*t.height,i=(this.followerAnchor.x+1)/2*e.width,s=(this.followerAnchor.y+1)/2*e.height;let l=t.left+n-i+this.offset.dx,m=t.top+r-s+this.offset.dy;this._followerElement.style.left=`${l}px`,this._followerElement.style.top=`${m}px`}catch(t){console.error("Error updating follower position:",t)}}debugFillProperties(t){super.debugFillProperties(t),t.push({name:"link",value:"LayerLink"}),t.push({name:"showWhenUnlinked",value:this.showWhenUnlinked}),t.push({name:"offset",value:this.offset.toString()}),t.push({name:"targetAnchor",value:this.targetAnchor.toString()}),t.push({name:"followerAnchor",value:this.followerAnchor.toString()})}createElement(t,e){return new $(this,t,e)}}class k{constructor({link:t=null,showWhenUnlinked:e=!0,offset:n=null,leaderAnchor:r=null,followerAnchor:i=null}={}){this.link=t,this.showWhenUnlinked=e,this.offset=n||w.zero,this.leaderAnchor=r,this.followerAnchor=i}debugInfo(){return{type:"RenderFollowerLayer",hasLink:!!this.link,showWhenUnlinked:this.showWhenUnlinked}}}class $ extends u.constructor.prototype.constructor{performRebuild(){return this.widget.build(this.context)}detach(){this.widget.link&&this.widget._followerElement&&this.widget.link.removeFollower(this.widget),super.detach()}}export{S as CompositedTransformFollower,A as CompositedTransformTarget,o as FilterQuality,T as LayerLink,a as Matrix4,k as RenderFollowerLayer,y as RenderLeaderLayer,p as RenderTransform,d as Transform};
//# sourceMappingURL=transform.js.map
