import{Widget as E,InheritedWidget as F,Element as L}from"../../core/widget_element.js";import{VNode as r}from"@flutterjs/vdom/vnode";import{TextDirection as o,Alignment as R}from"../../utils/utils.js";const D={fill:"fill",contain:"contain",cover:"cover",fitWidth:"fitWidth",fitHeight:"fitHeight",none:"none",scaleDown:"scaleDown"},d={noRepeat:"noRepeat",repeat:"repeat",repeatX:"repeatX",repeatY:"repeatY"},P={multiply:"multiply",screen:"screen",overlay:"overlay",darken:"darken",lighten:"lighten",colorDodge:"colorDodge",colorBurn:"colorBurn",hardLight:"hardLight",softLight:"softLight",difference:"difference",exclusion:"exclusion",hue:"hue",saturation:"saturation",color:"color",luminosity:"luminosity",srcOver:"srcOver",srcIn:"srcIn",srcOut:"srcOut",srcATop:"srcATop",dstOver:"dstOver",dstIn:"dstIn",dstOut:"dstOut",dstATop:"dstATop",plus:"plus",modulate:"modulate"},h={none:"none",low:"low",medium:"medium",high:"high"};class l{constructor({src:t=null,width:e=0,height:i=0,scale:a=1,dataUrl:s=null}={}){this.src=t,this.width=e,this.height=i,this.scale=a,this.dataUrl=s,this._image=null,this._isLoaded=!1,this._loadPromise=null,this._openHandles=[]}static fromUrl(t,{width:e=null,height:i=null,scale:a=1}={}){const s=new l({src:t,width:e,height:i,scale:a});return s.load(),s}static fromDataUrl(t,{width:e=null,height:i=null,scale:a=1}={}){const s=new l({dataUrl:t,width:e,height:i,scale:a});return s.load(),s}load(){return this._loadPromise?this._loadPromise:(this._loadPromise=new Promise((t,e)=>{const i=new window.Image;i.onload=()=>{(!this.width||this.width===0)&&(this.width=i.naturalWidth),(!this.height||this.height===0)&&(this.height=i.naturalHeight),this._image=i,this._isLoaded=!0,this._openHandles.push(new Error("Image loaded").stack),t(this)},i.onerror=()=>{e(new Error(`Failed to load image: ${this.src||this.dataUrl}`))},this.src?i.src=this.src:this.dataUrl&&(i.src=this.dataUrl)}),this._loadPromise)}getDOMImage(){return this._image}get isLoaded(){return this._isLoaded}clone(){const t=new l({src:this.src,width:this.width,height:this.height,scale:this.scale,dataUrl:this.dataUrl});return t._image=this._image,t._isLoaded=this._isLoaded,t}dispose(){this._image=null,this._isLoaded=!1,this._openHandles=[]}debugGetOpenHandleStackTraces(){return this._openHandles}get naturalWidth(){return this._image?.naturalWidth||this.width}get naturalHeight(){return this._image?.naturalHeight||this.height}}class A{constructor({image:t=null,debugImageLabel:e=null,width:i=null,height:a=null,scale:s=1,color:c=null,opacity:u=null,colorBlendMode:g=null,fit:m=D.contain,alignment:p=R.center,repeat:f=d.noRepeat,centerSlice:w=null,matchTextDirection:b=!1,textDirection:y=o.ltr,invertColors:x=!1,isAntiAlias:_=!1,filterQuality:I=h.medium}={}){this.image=t,this.debugImageLabel=e,this.width=i,this.height=a,this.scale=s,this.color=c,this.opacity=u,this.colorBlendMode=g,this.fit=m,this.alignment=p,this.repeat=f,this.centerSlice=w,this.matchTextDirection=b,this.textDirection=y,this.invertColors=x,this.isAntiAlias=_,this.filterQuality=I}getImageStyle(){const t={display:"block",width:this.width?`${this.width}px`:"100%",height:this.height?`${this.height}px`:"auto",objectFit:this._mapBoxFit(),objectPosition:this._mapAlignment(),filter:this._getFilterStyle()};if(this.repeat!==d.noRepeat&&(t.backgroundRepeat=this._mapImageRepeat()),this.colorBlendMode&&(t.mixBlendMode=this.colorBlendMode),this.opacity!==null&&this.opacity!==void 0){const e=typeof this.opacity=="number"?this.opacity:this.opacity.value;t.opacity=e}return t}_mapBoxFit(){return{fill:"fill",contain:"contain",cover:"cover",fitWidth:"cover",fitHeight:"cover",none:"none",scaleDown:"scale-down"}[this.fit]||"contain"}_mapAlignment(){const t={topLeft:"top left",topCenter:"top center",topRight:"top right",centerLeft:"center left",center:"center center",centerRight:"center right",bottomLeft:"bottom left",bottomCenter:"bottom center",bottomRight:"bottom right"};if(this.matchTextDirection&&this.textDirection){const e=this.textDirection===o.rtl,i=this.alignment;if(i.includes&&i.includes("start"))return e?i.replace("start","right"):i.replace("start","left");if(i.includes&&i.includes("end"))return e?i.replace("end","left"):i.replace("end","right")}return t[this.alignment]||"center"}_mapImageRepeat(){return{noRepeat:"no-repeat",repeat:"repeat",repeatX:"repeat-x",repeatY:"repeat-y"}[this.repeat]||"no-repeat"}_getFilterStyle(){const t=[];switch(this.invertColors&&t.push("invert(1)"),this.filterQuality){case h.high:t.push("blur(0px)");break;case h.none:t.push("blur(1px)");break}return t.length>0?t.join(" "):"none"}debugInfo(){return{type:"RenderImage",debugImageLabel:this.debugImageLabel,width:this.width,height:this.height,fit:this.fit,repeat:this.repeat,hasImage:!!this.image,imageLoaded:this.image?.isLoaded}}}class C extends E{constructor({key:t=null,image:e=null,debugImageLabel:i=null,width:a=null,height:s=null,scale:c=1,color:u=null,opacity:g=null,colorBlendMode:m=null,fit:p=null,alignment:f=R.center,repeat:w=d.noRepeat,centerSlice:b=null,matchTextDirection:y=!1,invertColors:x=!1,filterQuality:_=h.medium,isAntiAlias:I=!1}={}){super(t),this.image=e,this.debugImageLabel=i,this.width=a,this.height=s,this.scale=c,this.color=u,this.opacity=g,this.colorBlendMode=m,this.fit=p,this.alignment=f,this.repeat=w,this.centerSlice=b,this.matchTextDirection=y,this.invertColors=x,this.filterQuality=_,this.isAntiAlias=I,this._renderObject=null}createRenderObject(t){return new A({image:this.image?.clone?.()||this.image,debugImageLabel:this.debugImageLabel,width:this.width,height:this.height,scale:this.scale,color:this.color,opacity:this.opacity,colorBlendMode:this.colorBlendMode,fit:this.fit,alignment:this.alignment,repeat:this.repeat,centerSlice:this.centerSlice,matchTextDirection:this.matchTextDirection,textDirection:this.matchTextDirection||typeof this.alignment=="object"?t?.textDirection||o.ltr:null,invertColors:this.invertColors,isAntiAlias:this.isAntiAlias,filterQuality:this.filterQuality})}updateRenderObject(t,e){e.image=this.image?.clone?.()||this.image,e.debugImageLabel=this.debugImageLabel,e.width=this.width,e.height=this.height,e.scale=this.scale,e.color=this.color,e.opacity=this.opacity,e.colorBlendMode=this.colorBlendMode,e.fit=this.fit,e.alignment=this.alignment,e.repeat=this.repeat,e.centerSlice=this.centerSlice,e.matchTextDirection=this.matchTextDirection,e.textDirection=this.matchTextDirection||typeof this.alignment=="object"?t?.textDirection||o.ltr:null,e.invertColors=this.invertColors,e.isAntiAlias=this.isAntiAlias,e.filterQuality=this.filterQuality}didUnmountRenderObject(t){t.image=null}build(t){this._renderObject?this.updateRenderObject(t,this._renderObject):this._renderObject=this.createRenderObject(t);const e=t.element.getElementId(),i=t.element.getWidgetPath();if(!this.image||!this.image.isLoaded)return new r({tag:"div",props:{style:{width:this.width?`${this.width}px`:"100%",height:this.height?`${this.height}px`:"100px",backgroundColor:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center"},"data-element-id":e,"data-widget-path":i,"data-widget":"RawImage","data-loading":"true"},children:[new r({tag:"span",children:["Loading image..."]})]});const a=this.image.getDOMImage();if(!a)return new r({tag:"div",props:{style:{width:this.width?`${this.width}px`:"100%",height:this.height?`${this.height}px`:"100px",backgroundColor:"#ffe0e0"}},children:[]});const s=this._renderObject.getImageStyle();return new r({tag:"img",props:{src:a.src,style:s,alt:this.debugImageLabel||"image","data-element-id":e,"data-widget-path":i,"data-widget":"RawImage","data-width":this.width,"data-height":this.height,"data-fit":this.fit,"data-repeat":this.repeat,"data-scale":this.scale},key:this.key})}debugFillProperties(t){super.debugFillProperties(t),t.push({name:"image",value:this.image?"Image":"null"}),t.push({name:"debugImageLabel",value:this.debugImageLabel}),this.width&&t.push({name:"width",value:this.width}),this.height&&t.push({name:"height",value:this.height}),t.push({name:"scale",value:this.scale}),this.color&&t.push({name:"color",value:this.color}),this.fit&&t.push({name:"fit",value:this.fit}),t.push({name:"repeat",value:this.repeat}),t.push({name:"filterQuality",value:this.filterQuality})}createElement(){return new B(this)}}class B extends L{performRebuild(){return this.widget.build(this.context)}unmount(){this.widget._renderObject&&this.widget.didUnmountRenderObject(this.widget._renderObject),super.unmount()}}class T{constructor(){this._cache=new Map,this._loadedAssets=new Set}async loadString(t){if(this._cache.has(t))return this._cache.get(t);try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load asset: ${t}`);const i=await e.text();return this._cache.set(t,i),this._loadedAssets.add(t),i}catch(e){throw console.error("Asset bundle load error:",e),e}}async loadImage(t){const e=l.fromUrl(t);return await e.load(),e}clear(){this._cache.clear(),this._loadedAssets.clear()}}const S=new T;class v extends F{constructor({key:t=null,bundle:e=null,child:i=null}={}){if(super({key:t,child:i}),!e)throw new Error("DefaultAssetBundle requires a bundle");this.bundle=e}static of(t){return t?.dependOnInheritedWidgetOfExactType?.(v)?.bundle||S}updateShouldNotify(t){return this.bundle!==t.bundle}debugFillProperties(t){super.debugFillProperties(t),t.push({name:"bundle",value:this.bundle.constructor.name})}createElement(){return new M(this)}}class M extends L{performRebuild(){return this.widget.build(this.context)}}export{T as AssetBundle,P as BlendMode,D as BoxFit,v as DefaultAssetBundle,M as DefaultAssetBundleElement,h as FilterQuality,l as Image,d as ImageRepeat,C as RawImage,B as RawImageElement,A as RenderImage,S as rootBundle};
//# sourceMappingURL=raw_image.js.map
