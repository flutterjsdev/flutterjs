import{ProxyWidget as c}from"../../core/widget_element.js";import{VNode as u}from"@flutterjs/vdom/vnode";import{BlendMode as d}from"./opacity.js";class b extends c{constructor({key:e=null,shaderCallback:t=null,blendMode:n=d.modulate,child:i=null}={}){if(super({key:e,child:i}),typeof t!="function")throw new Error(`ShaderMask requires a shaderCallback function, got: ${typeof t}`);if(!Object.values(d).includes(n))throw new Error(`Invalid blendMode: ${n}`);this.shaderCallback=t,this.blendMode=n,this._renderObject=null,this._containerElement=null,this._maskImageUrl=null}createRenderObject(e){return new m({shaderCallback:this.shaderCallback,blendMode:this.blendMode})}updateRenderObject(e,t){t.shaderCallback=this.shaderCallback,t.blendMode=this.blendMode}build(e){this._renderObject?this.updateRenderObject(e,this._renderObject):this._renderObject=this.createRenderObject(e);let t=null;if(this.child)if(this.child.createElement){const r=this.child.createElement();r.mount(e.element),t=r.performRebuild()}else t=this.child;const n=e.element.getElementId(),i=e.element.getWidgetPath();return new u({tag:"div",props:{style:{position:"relative",overflow:"hidden",display:"inline-block"},"data-element-id":n,"data-widget-path":i,"data-widget":"ShaderMask","data-blend-mode":this.blendMode,ref:r=>this._onContainerMount(r,e)},children:[new u({tag:"div",props:{style:{position:"relative",width:"100%",height:"100%"},"data-widget":"ShaderMaskContent",ref:r=>this._onContentMount(r)},children:t?[t]:[]})],key:this.key})}_onContainerMount(e,t){if(!e)return;this._containerElement=e,this._containerElement&&this._generateAndApplyShaderMask();const n=()=>this._generateAndApplyShaderMask();window.addEventListener("resize",n),e._cleanupResize=()=>{window.removeEventListener("resize",n)}}_onContentMount(e){e&&this._containerElement&&this._generateAndApplyShaderMask()}_generateAndApplyShaderMask(){if(this._containerElement)try{const e=this._containerElement.getBoundingClientRect(),t={width:Math.ceil(e.width)||200,height:Math.ceil(e.height)||200},n=this.shaderCallback(t);this._applyShaderToContainer(n,t)}catch(e){console.error("Error rendering shader mask:",e)}}_applyShaderToContainer(e,t){if(!(!this._containerElement||!e)){if(e.type==="gradient"&&e.gradient){const n=this._createGradientMask(e.gradient,t);this._applyMaskImage(n)}e.type==="svg"&&e.svgContent&&this._applyMaskImage(`url('data:image/svg+xml;utf8,${encodeURIComponent(e.svgContent)}')`),e.type==="url"&&e.url&&this._applyMaskImage(`url('${e.url}')`),e.maskImage&&this._applyMaskImage(e.maskImage),this.blendMode&&(this._containerElement.style.mixBlendMode=this.blendMode)}}_applyMaskImage(e){!this._containerElement||!e||(this._containerElement.style.WebkitMaskImage=e,this._containerElement.style.WebkitMaskSize="100% 100%",this._containerElement.style.WebkitMaskRepeat="no-repeat",this._containerElement.style.WebkitMaskPosition="0 0",this._containerElement.style.maskImage=e,this._containerElement.style.maskSize="100% 100%",this._containerElement.style.maskRepeat="no-repeat",this._containerElement.style.maskPosition="0 0",this._maskImageUrl=e)}_createGradientMask(e,t){const n="http://www.w3.org/2000/svg",i=document.createElementNS(n,"svg");i.setAttribute("width",t.width),i.setAttribute("height",t.height),i.setAttribute("viewBox",`0 0 ${t.width} ${t.height}`);const r=document.createElementNS(n,"defs"),a=document.createElementNS(n,"linearGradient");a.setAttribute("id","maskGradient"),a.setAttribute("x1","0%"),a.setAttribute("y1","0%"),a.setAttribute("x2","100%"),a.setAttribute("y2","0%"),[{offset:"0%",color:"#000000",opacity:"1"},{offset:"100%",color:"#000000",opacity:"0"}].forEach(o=>{const l=document.createElementNS(n,"stop");l.setAttribute("offset",o.offset),l.setAttribute("stop-color",o.color),l.setAttribute("stop-opacity",o.opacity),a.appendChild(l)}),r.appendChild(a),i.appendChild(r);const s=document.createElementNS(n,"rect");s.setAttribute("width",t.width),s.setAttribute("height",t.height),s.setAttribute("fill","url(#maskGradient)"),i.appendChild(s);const p=new XMLSerializer().serializeToString(i);return`url('data:image/svg+xml;utf8,${encodeURIComponent(p)}')`}debugFillProperties(e){super.debugFillProperties(e),e.push({name:"blendMode",value:this.blendMode}),e.push({name:"shaderCallback",value:"function"}),this._maskImageUrl&&e.push({name:"maskApplied",value:"true"})}createElement(){return new g(this)}}class m{constructor({shaderCallback:e=null,blendMode:t=d.modulate}={}){this.shaderCallback=e,this.blendMode=t}applyToElement(e){e&&(e.style.position="relative",e.style.overflow="hidden")}generateShader(e){try{return this.shaderCallback(e)}catch(t){return console.error("Error in shaderCallback:",t),null}}debugInfo(){return{type:"RenderShaderMask",blendMode:this.blendMode,hasShaderCallback:typeof this.shaderCallback=="function"}}}class g extends c.constructor.prototype.constructor{performRebuild(){return this.widget.build(this.context)}detach(){this.widget._containerElement&&this.widget._containerElement._cleanupResize&&this.widget._containerElement._cleanupResize(),super.detach()}}export{m as RenderShaderMask,b as ShaderMask};
//# sourceMappingURL=shader_mask.js.map
