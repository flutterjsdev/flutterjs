import{ProxyWidget as y,Widget as u}from"../../core/widget_element.js";import{VNode as c}from"@flutterjs/vdom/vnode";import{Size as a}from"../../utils/size.js";import{BoxConstraints as f}from"../../utils/box_constraints.js";class m{constructor(){if(new.target===m)throw new Error("SingleChildLayoutDelegate is abstract")}getConstraintsForChild(e){throw new Error("getConstraintsForChild() must be implemented")}positionChild(e,t){throw new Error("positionChild() must be implemented")}getSize(e){return e.constrain(new a(300,300))}shouldRelayout(e){return!0}}class b extends y{constructor({key:e=null,delegate:t=null,child:n=null}={}){if(super({key:e,child:n}),!t)throw new Error("CustomSingleChildLayout requires a delegate");if(!(t instanceof m))throw new Error(`CustomSingleChildLayout requires a SingleChildLayoutDelegate instance, got: ${typeof t}`);this.delegate=t,this._renderObject=null,this._containerElement=null,this._childElement=null,this._resizeObserver=null}createRenderObject(e){return new _({delegate:this.delegate})}updateRenderObject(e,t){this.delegate.shouldRelayout(t.delegate)&&(t.delegate=this.delegate)}build(e){this._renderObject?this.updateRenderObject(e,this._renderObject):this._renderObject=this.createRenderObject(e);let t=null;if(this.child){const i=this.child.createElement(e.element,e.element.runtime);i.mount(e.element),t=i.performRebuild()}const n=e.element.getElementId(),d=e.element.getWidgetPath();return new c({tag:"div",props:{style:{position:"relative",display:"inline-block"},"data-element-id":n,"data-widget-path":d,"data-widget":"CustomSingleChildLayout",ref:i=>this._onContainerMount(i)},children:[new c({tag:"div",props:{style:{position:"absolute"},ref:i=>this._onChildMount(i)},children:t?[t]:[]})],key:this.key})}_onContainerMount(e){if(!e)return;this._containerElement=e,window.ResizeObserver&&(this._resizeObserver=new ResizeObserver(()=>{this._performLayout()}),this._resizeObserver.observe(e));const t=()=>this._performLayout();window.addEventListener("resize",t),e._cleanupResize=()=>{window.removeEventListener("resize",t),this._resizeObserver&&this._resizeObserver.disconnect()},this._performLayout()}_onChildMount(e){e&&(this._childElement=e,this._performLayout())}_performLayout(){if(!(!this._containerElement||!this._childElement||!this.delegate))try{const e=this._containerElement.getBoundingClientRect(),t=new a(e.width||300,e.height||300),n=f.expand({width:t.width,height:t.height}),d=this.delegate.getConstraintsForChild(n),i=this._childElement.getBoundingClientRect(),l=new a(i.width||100,i.height||100),s=d.constrain(l),r=this.delegate.positionChild(t,s);this._childElement.style.left=`${r.x}px`,this._childElement.style.top=`${r.y}px`,this._childElement.style.width=`${s.width}px`,this._childElement.style.height=`${s.height}px`;const o=this.delegate.getSize(n);this._containerElement.style.width=`${o.width}px`,this._containerElement.style.height=`${o.height}px`}catch(e){console.error("Error performing custom single child layout:",e)}}debugFillProperties(e){super.debugFillProperties(e),e.push({name:"delegate",value:this.delegate.constructor.name})}createElement(e,t){return new z(this,e,t)}}class _{constructor({delegate:e=null}={}){this.delegate=e}debugInfo(){return{type:"RenderCustomSingleChildLayoutBox",delegateType:this.delegate?.constructor.name}}}class z extends y.constructor.prototype.constructor{performRebuild(){return this.widget.build(this.context)}detach(){this.widget._containerElement&&this.widget._containerElement._cleanupResize&&this.widget._containerElement._cleanupResize(),super.detach()}}class g{constructor(){if(new.target===g)throw new Error("MultiChildLayoutDelegate is abstract")}performLayout(e,t){throw new Error("performLayout() must be implemented")}getSize(e){return e.constrain(new a(300,300))}shouldRelayout(e){return!0}}class p extends u{constructor({key:e=null,id:t=null,child:n=null}={}){if(super(e||{id:t}),!t)throw new Error("LayoutId requires an id");this.id=t,this.child=n}applyParentData(e){e.parentData||(e.parentData={}),e.parentData.id=this.id}build(e){return this.child}debugFillProperties(e){super.debugFillProperties(e),e.push({name:"id",value:this.id})}createElement(e,t){return new L(this,e,t)}}class L extends u.constructor.prototype.constructor{performRebuild(){return this.widget.build(this.context)}}class R extends u{constructor({key:e=null,delegate:t=null,children:n=[]}={}){if(super(e),!t)throw new Error("CustomMultiChildLayout requires a delegate");if(!(t instanceof g))throw new Error(`CustomMultiChildLayout requires a MultiChildLayoutDelegate instance, got: ${typeof t}`);this.delegate=t,this.children=n||[],this._renderObject=null,this._containerElement=null,this._childElements=new Map,this._resizeObserver=null}createRenderObject(e){return new C({delegate:this.delegate})}updateRenderObject(e,t){this.delegate.shouldRelayout(t.delegate)&&(t.delegate=this.delegate)}build(e){this._renderObject?this.updateRenderObject(e,this._renderObject):this._renderObject=this.createRenderObject(e);const t=e.element.getElementId(),n=e.element.getWidgetPath(),d=this.children.map((i,l)=>{let s=i;i instanceof p||(s=new p({id:l,child:i}));const r=s.createElement(e.element,e.element.runtime);return r.mount(e.element),r.performRebuild()});return new c({tag:"div",props:{style:{position:"relative",display:"inline-block"},"data-element-id":t,"data-widget-path":n,"data-widget":"CustomMultiChildLayout",ref:i=>this._onContainerMount(i)},children:d.map((i,l)=>new c({tag:"div",props:{style:{position:"absolute"},"data-layout-id":l,ref:s=>this._onChildMount(s,l)},children:[i]})),key:this.key})}_onContainerMount(e){if(!e)return;this._containerElement=e,window.ResizeObserver&&(this._resizeObserver=new ResizeObserver(()=>{this._performLayout()}),this._resizeObserver.observe(e));const t=()=>this._performLayout();window.addEventListener("resize",t),e._cleanupResize=()=>{window.removeEventListener("resize",t),this._resizeObserver&&this._resizeObserver.disconnect()},this._performLayout()}_onChildMount(e,t){e&&(this._childElements.set(t,e),this._performLayout())}_performLayout(){if(!(!this._containerElement||!this.delegate))try{const e=this._containerElement.getBoundingClientRect(),t=new a(e.width||300,e.height||300),n=f.expand({width:t.width,height:t.height}),d=(s,r)=>{const o=this._childElements.get(s);if(!o)return console.warn(`LayoutId ${s} not found`),new a(0,0);const w=o.getBoundingClientRect(),E=new a(w.width||100,w.height||100);return r.constrain(E)},i=this.delegate.performLayout(t,d);if(i&&typeof i=="object")for(const[s,r]of Object.entries(i)){const o=this._childElements.get(parseInt(s));o&&(o.style.left=`${r.x||0}px`,o.style.top=`${r.y||0}px`,r.width&&(o.style.width=`${r.width}px`),r.height&&(o.style.height=`${r.height}px`))}const l=this.delegate.getSize(n);this._containerElement.style.width=`${l.width}px`,this._containerElement.style.height=`${l.height}px`}catch(e){console.error("Error performing custom multi child layout:",e)}}debugFillProperties(e){super.debugFillProperties(e),e.push({name:"delegate",value:this.delegate.constructor.name}),e.push({name:"childCount",value:this.children.length})}createElement(e,t){return new v(this,e,t)}}class C{constructor({delegate:e=null}={}){this.delegate=e}debugInfo(){return{type:"RenderCustomMultiChildLayoutBox",delegateType:this.delegate?.constructor.name}}}class v extends u.constructor.prototype.constructor{performRebuild(){return this.widget.build(this.context)}detach(){this.widget._containerElement&&this.widget._containerElement._cleanupResize&&this.widget._containerElement._cleanupResize(),super.detach()}}export{R as CustomMultiChildLayout,b as CustomSingleChildLayout,p as LayoutId,g as MultiChildLayoutDelegate,C as RenderCustomMultiChildLayoutBox,_ as RenderCustomSingleChildLayoutBox,m as SingleChildLayoutDelegate};
//# sourceMappingURL=custom_single_child_layout.js.map
