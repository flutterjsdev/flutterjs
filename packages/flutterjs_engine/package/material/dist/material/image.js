import{StatefulWidget as H}from"../core/widget_element.js";import{VNode as f}from"@flutterjs/vdom/vnode";import{BoxFit as d,BlendMode as a,FilterQuality as w,Clip as $}from"../utils/utils.js";const m={network:"network",asset:"asset",memory:"memory",file:"file"},p={[a.normal]:"normal",[a.multiply]:"multiply",[a.screen]:"screen",[a.overlay]:"overlay",[a.darken]:"darken",[a.lighten]:"lighten",[a.colorDodge]:"color-dodge",[a.colorBurn]:"color-burn",[a.hardLight]:"hard-light",[a.softLight]:"soft-light",[a.difference]:"difference",[a.exclusion]:"exclusion",[a.hue]:"hue",[a.saturation]:"saturation",[a.color]:"color",[a.luminosity]:"luminosity"},U={[d.fill]:"fill",[d.contain]:"contain",[d.cover]:"cover",[d.fitWidth]:"scale-down",[d.fitHeight]:"scale-down",[d.none]:"none",[d.scaleDown]:"scale-down"},y={none:"visible",hardEdge:"hidden",antiAlias:"hidden",antiAliasWithSaveLayer:"hidden"};class N{constructor(e){this.completer=e,this.isAlive=!0}dispose(){this.isAlive=!1}keepAlive(){return this}}class u{constructor(e){this.imageProvider=e,this.listeners=new Set,this.imageInfo=null,this.error=null,this.completer=null}addListener(e){this.listeners.add(e),this.imageInfo&&e.onImage(this.imageInfo)}removeListener(e){this.listeners.delete(e)}notifyListeners(e){this.imageInfo=e,this.listeners.forEach(t=>{t.onImage&&t.onImage(e)})}notifyError(e,t){this.error=e,this.listeners.forEach(i=>{i.onError&&i.onError(e,t)})}notifyChunk(e){this.listeners.forEach(t=>{t.onChunk&&t.onChunk(e)})}}class R{constructor({cumulativeBytesLoaded:e=0,expectedTotalBytes:t=null}={}){this.cumulativeBytesLoaded=e,this.expectedTotalBytes=t}get progress(){return this.expectedTotalBytes?this.cumulativeBytesLoaded/this.expectedTotalBytes:0}}class g{constructor(e=m.network){this.sourceType=e,this.key=Math.random().toString(36).substr(2,9)}resolve(e={}){return new u(this)}async load(){throw new Error("load() must be implemented")}getUrl(){throw new Error("getUrl() must be implemented")}}class I extends g{constructor(e,{scale:t=1,headers:i=null,timeout:s=1e4,onProgress:r=null}={}){super(m.network),this.src=e,this.scale=t,this.headers=i||{},this.timeout=s,this.onProgress=r}resolve(e={}){const t=new u(this);return this._loadWithStream(t,e),t}async _loadWithStream(e,t){try{const i=await this._loadImage();e.notifyListeners({image:i.element,width:i.width,height:i.height,scale:this.scale,src:this.src})}catch(i){e.notifyError(i,new Error().stack)}}_loadImage(){return new Promise((e,t)=>{const i=setTimeout(()=>{t(new Error(`Network image timeout: ${this.src}`))},this.timeout),s=new XMLHttpRequest;s.addEventListener("progress",r=>{r.lengthComputable&&this.onProgress&&this.onProgress({cumulativeBytesLoaded:r.loaded,expectedTotalBytes:r.total})}),s.addEventListener("load",()=>{if(clearTimeout(i),s.status>=200&&s.status<300){const r=s.response,n=new l;n.onload=()=>{e({element:n,width:n.naturalWidth,height:n.naturalHeight,scale:this.scale})},n.onerror=()=>{t(new Error(`Failed to load network image: ${this.src}`))},n.src=URL.createObjectURL(r)}else t(new Error(`HTTP ${s.status}: ${this.src}`))}),s.addEventListener("error",()=>{clearTimeout(i),t(new Error(`Network error loading: ${this.src}`))}),s.responseType="blob",s.open("GET",this.src,!0),Object.entries(this.headers).forEach(([r,n])=>{s.setRequestHeader(r,n)}),s.send()})}async load(){return this._loadImage()}getUrl(){return this.src}}class S extends g{constructor(e,{packages:t=null,scale:i=1}={}){super(m.asset),this.assetPath=e,this.packages=t,this.scale=i,this.key=`asset:${t}:${e}:${i}`}resolve(e={}){const t=new u(this);return this._loadWithStream(t,e),t}async _loadWithStream(e,t){try{const i=await this.load();e.notifyListeners({image:i.element,width:i.width,height:i.height,scale:this.scale,src:i.src})}catch(i){e.notifyError(i,new Error().stack)}}async load(){return new Promise((e,t)=>{const i=this._resolveAssetPath(),s=new l;s.onload=()=>{e({element:s,src:i,width:s.naturalWidth,height:s.naturalHeight,scale:this.scale})},s.onerror=()=>{t(new Error(`Failed to load asset image: ${this.assetPath}`))},s.src=i})}_resolveAssetPath(){return`${this.packages?`/packages/${this.packages}`:"/assets"}/${this.assetPath}`}getUrl(){return this._resolveAssetPath()}}class b extends g{constructor(e,{scale:t=1}={}){super(m.memory),this.bytes=e,this.scale=t,this.key=`memory:${this.bytes.length}:${t}`}resolve(e={}){const t=new u(this);return this._loadWithStream(t,e),t}async _loadWithStream(e,t){try{const i=await this.load();e.notifyListeners({image:i.element,width:i.width,height:i.height,scale:this.scale,src:i.src})}catch(i){e.notifyError(i,new Error().stack)}}async load(){return new Promise((e,t)=>{try{let i;if(this.bytes instanceof Uint8Array){const r=String.fromCharCode.apply(null,this.bytes);i="data:image/png;base64,"+btoa(r)}else if(typeof this.bytes=="string")i=this.bytes.startsWith("data:")?this.bytes:`data:image/png;base64,${this.bytes}`;else throw new Error("Invalid image data");const s=new l;s.onload=()=>{e({element:s,src:i,width:s.naturalWidth,height:s.naturalHeight,scale:this.scale})},s.onerror=()=>{t(new Error("Failed to load memory image"))},s.src=i}catch(i){t(i)}})}getUrl(){if(this.bytes instanceof Uint8Array){const e=String.fromCharCode.apply(null,this.bytes);return"data:image/png;base64,"+btoa(e)}return this.bytes}}class v extends g{constructor(e,{scale:t=1}={}){super(m.file),this.filePath=e,this.scale=t}async load(){throw typeof window<"u"?new Error("FileImage is not supported in web environments. Use Image.asset or Image.network instead."):new Error("FileImage requires Node.js file system implementation")}getUrl(){return this.filePath}}class l extends H{constructor({key:e=null,image:t=null,width:i=null,height:s=null,color:r=null,opacity:n=null,colorBlendMode:o=a.normal,fit:c=d.contain,alignment:_="center",repeat:L="no-repeat",centerSlice:k=null,matchTextDirection:E=!1,gaplessPlayback:P=!1,isAntiAlias:B=!1,filterQuality:T=w.medium,frameBuilder:C=null,loadingBuilder:A=null,errorBuilder:F=null,semanticLabel:x=null,excludeFromSemantics:M=!1,clipBehavior:W=$.hardEdge}={}){if(super(e),!t||!(t instanceof g))throw new Error("Image requires a valid ImageProvider");this.image=t,this.width=i,this.height=s,this.color=r,this.opacity=n,this.colorBlendMode=o,this.fit=c,this.alignment=_,this.repeat=L,this.centerSlice=k,this.matchTextDirection=E,this.gaplessPlayback=P,this.isAntiAlias=B,this.filterQuality=T,this.frameBuilder=C,this.loadingBuilder=A,this.errorBuilder=F,this.semanticLabel=x,this.excludeFromSemantics=M,this.clipBehavior=W}static network(e,{key:t=null,scale:i=1,headers:s=null,cacheWidth:r=null,cacheHeight:n=null,...o}={}){const c=new I(e,{scale:i,headers:s});return new l({key:t,image:c,...o})}static asset(e,{key:t=null,scale:i=null,packages:s=null,cacheWidth:r=null,cacheHeight:n=null,...o}={}){const c=new S(e,{packages:s,scale:i||1});return new l({key:t,image:c,...o})}static memory(e,{key:t=null,scale:i=1,cacheWidth:s=null,cacheHeight:r=null,...n}={}){const o=new b(e,{scale:i});return new l({key:t,image:o,...n})}static file(e,{key:t=null,scale:i=1,cacheWidth:s=null,cacheHeight:r=null,...n}={}){if(typeof window<"u")throw new Error("Image.file is not supported on Flutter Web. Consider using either Image.asset or Image.network instead.");const o=new v(e,{scale:i});return new l({key:t,image:o,...n})}createState(){return new D}debugFillProperties(e){super.debugFillProperties(e),e.push({name:"image",value:this.image}),e.push({name:"width",value:this.width}),e.push({name:"height",value:this.height}),e.push({name:"color",value:this.color}),e.push({name:"colorBlendMode",value:this.colorBlendMode}),e.push({name:"fit",value:this.fit}),e.push({name:"alignment",value:this.alignment}),e.push({name:"gaplessPlayback",value:this.gaplessPlayback}),e.push({name:"filterQuality",value:this.filterQuality})}}class D{constructor(e){this.widget=e,this.imageStream=null,this.imageInfo=null,this.loadingProgress=null,this.isListeningToStream=!1,this.error=null,this.errorStack=null,this.frameNumber=null,this.wasSynchronouslyLoaded=!1,this.completerHandle=null,this.lastImageProvider=null}initState(){}didChangeDependencies(){this._resolveImage(),this._listenToStream()}didUpdateWidget(e){this.isListeningToStream&&this.widget.loadingBuilder==null!=(e.loadingBuilder==null)&&this._updateStreamListener(),this.widget.image!==e.image&&this._resolveImage()}dispose(){this._stopListeningToStream(),this.completerHandle?.dispose()}_resolveImage(){const e=this.widget.image.resolve({});e.imageProvider.key!==this.lastImageProvider?.key&&(this._updateSourceStream(e),this.lastImageProvider=e.imageProvider)}_updateSourceStream(e){this.imageStream?.imageProvider.key!==e.imageProvider.key&&(this.isListeningToStream&&this._removeImageStreamListener(),this.widget.gaplessPlayback||this._replaceImage(null),this.loadingProgress=null,this.frameNumber=null,this.wasSynchronouslyLoaded=!1,this.imageStream=e,this.isListeningToStream&&this._addImageStreamListener())}_listenToStream(){this.isListeningToStream||(this._addImageStreamListener(),this.isListeningToStream=!0)}_stopListeningToStream(){this.isListeningToStream&&(this.completerHandle==null&&this.imageStream?.completer&&(this.completerHandle=this.imageStream.completer.keepAlive()),this._removeImageStreamListener(),this.isListeningToStream=!1)}_addImageStreamListener(){this.imageStream?.addListener({onImage:e=>this._handleImageFrame(e),onError:(e,t)=>this._handleImageError(e,t),onChunk:e=>this._handleImageChunk(e)})}_removeImageStreamListener(){this.imageStream?.removeListener({onImage:e=>this._handleImageFrame(e),onError:(e,t)=>this._handleImageError(e,t),onChunk:e=>this._handleImageChunk(e)})}_updateStreamListener(){this._removeImageStreamListener(),this._addImageStreamListener()}_handleImageFrame(e){this.imageInfo=e,this.loadingProgress=null,this.error=null,this.errorStack=null,this.frameNumber=(this.frameNumber||0)+1,this.wasSynchronouslyLoaded=!0}_handleImageChunk(e){this.widget.loadingBuilder&&(this.loadingProgress=e)}_handleImageError(e,t){this.error=e,this.errorStack=t,this.widget.errorBuilder}_replaceImage(e){this.imageInfo=e}build(e){const t=e.element.getElementId(),i=e.element.getWidgetPath(),s=this._getInlineStyles();if(this.error)return this.widget.errorBuilder?this.widget.errorBuilder(e,this.error,this.errorStack):new f({tag:"div",props:{className:"fjs-image-error",style:{...s,backgroundColor:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center",color:"#999",overflow:y[this.widget.clipBehavior]||"hidden"},"data-element-id":t,"data-widget-path":i,title:this.error.message},children:["\u26A0 Image failed to load"]});if(!this.imageInfo&&this.widget.loadingBuilder)return this.widget.loadingBuilder(e,null,this.loadingProgress);let r=this._buildImageElement(t,i,s);return this.widget.frameBuilder&&(r=this.widget.frameBuilder(e,r,this.frameNumber,this.wasSynchronouslyLoaded)),this.widget.loadingBuilder&&(r=this.widget.loadingBuilder(e,r,this.loadingProgress)),this.widget.excludeFromSemantics||(r=new f({tag:"figure",props:{role:"img","aria-label":this.widget.semanticLabel||"Image",style:{margin:0}},children:[r]})),r}_buildImageElement(e,t,i){const s={className:"fjs-image",style:i,"data-element-id":e,"data-widget-path":t,"data-widget":"Image","data-source-type":this.widget.image.sourceType,alt:this.widget.semanticLabel||"Image"};return this.imageInfo&&(s.src=this.imageInfo.src),new f({tag:"img",props:s,key:this.widget.key})}_getInlineStyles(){const e={width:this.widget.width?`${this.widget.width}px`:"auto",height:this.widget.height?`${this.widget.height}px`:"auto",objectFit:U[this.widget.fit]||"contain",objectPosition:this._mapAlignment(),backgroundRepeat:this.widget.repeat,overflow:y[this.widget.clipBehavior]||"hidden",filter:this._buildFilterStyles()};return this.widget.color&&this.widget.colorBlendMode&&(e.mixBlendMode=p[this.widget.colorBlendMode]||"normal",e.backgroundColor=this.widget.color,e.backgroundBlendMode=p[this.widget.colorBlendMode]),this.widget.opacity!==null&&this.widget.opacity!==void 0&&(e.opacity=this.widget.opacity),this.widget.isAntiAlias?e.imageRendering="smooth":e.imageRendering="pixelated",this.widget.matchTextDirection&&(e.direction=document.dir||"ltr"),e}_mapAlignment(){return{center:"center",topLeft:"top left",topCenter:"top center",topRight:"top right",centerLeft:"center left",centerRight:"center right",bottomLeft:"bottom left",bottomCenter:"bottom center",bottomRight:"bottom right"}[this.widget.alignment]||"center"}_buildFilterStyles(){const e=[];return this.widget.filterQuality===w.high?e.push("contrast(1.1) saturate(1.05)"):this.widget.filterQuality===w.low&&e.push("blur(0.5px)"),e.length>0?e.join(" "):"none"}}export{S as AssetImage,v as FileImage,m as IMAGE_SOURCE_TYPES,l as Image,R as ImageChunkEvent,g as ImageProvider,u as ImageStream,N as ImageStreamCompleterHandle,b as MemoryImage,I as NetworkImage};
//# sourceMappingURL=image.js.map
