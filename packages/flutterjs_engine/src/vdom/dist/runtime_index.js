import"./vnode.js";import{VNodeBuilder as c}from"./vnode_builder.js";import"./style_converter.js";import{VNodeRenderer as g}from"./vnode_renderer.js";import"./ssr_renderer.js";import{RenderEngine as h}from"./render_engine.js";import{Hydrator as R}from"./hydrator.js";class u{constructor(){this.app=null,this.rootElement=null,this.rootVNode=null,this.isHydrated=!1,this.hotReloadEnabled=!1,this.renderer=null,this.stateRegistry=new Map,this.performanceMetrics={initialRender:0,updates:0,totalRenderTime:0,averageRenderTime:0}}clearMetrics(){this.performanceMetrics={initialRender:0,updates:0,totalRenderTime:0,averageRenderTime:0}}runApp(e,t={}){const{target:o="#root",mode:r="auto",enableHotReload:i=!1,enablePerformanceTracking:d=!0,onError:l=null}=t;try{console.log(`  [RUNTIME] runApp called with target: ${o}`),this.app=e,this.hotReloadEnabled=i,this.rootElement=this.getTargetElement(o),console.log("  [RUNTIME] Target element found"),this.renderer=new g({debugMode:!0}),console.log("  [RUNTIME] VNodeRenderer instance created");const a=this.hasSSRContent(this.rootElement);return console.log(`  [RUNTIME] Has SSR content: ${a}`),a?(console.log("  [RUNTIME] Entering hydration mode"),this.hydrateApp(e,t)):(console.log("  [RUNTIME] Entering CSR mode"),this.renderApp(e,t)),i&&(console.log("  [RUNTIME] Setting up hot reload"),this.setupHotReload()),d&&(console.log("  [RUNTIME] Starting performance tracking"),this.startPerformanceTracking()),this}catch(a){throw l?l(a):console.error("FlutterJS Runtime Error:",a),a}}renderApp(e,t={}){console.log("  [RENDERAPP] Starting client-side render");const o=performance.now(),r=this.createBuildContext(t);console.log("  [RENDERAPP] Build context created");const i=e.build?e.build(r):e;console.log("  [RENDERAPP] Widget tree built"),console.log("  [RENDERAPP] Widget tree:",JSON.stringify(i,null,2).substring(0,200)),this.rootVNode=c.build(i,r),console.log("  [RENDERAPP] VNode created"),console.log(`  [RENDERAPP] VNode tag: ${this.rootVNode.tag}`),console.log(`  [RENDERAPP] VNode children count: ${this.rootVNode.children?this.rootVNode.children.length:0}`),console.log("  [RENDERAPP] VNode props:",this.rootVNode.props),console.log("  [RENDERAPP] Full VNode:",JSON.stringify(this.rootVNode,null,2).substring(0,300)),console.log("  [RENDERAPP] Root element before render:",this.rootElement.innerHTML.substring(0,100)),console.log("  [RENDERAPP] Root element classes:",this.rootElement.className),this.renderer||(this.renderer=new g({debugMode:!0})),this.renderer.render(this.rootVNode,this.rootElement,{clear:!0}),console.log("  [RENDERAPP] Rendered to DOM"),console.log("  [RENDERAPP] Root element after render:",this.rootElement.innerHTML.substring(0,200)),console.log("  [RENDERAPP] Root element child count:",this.rootElement.children.length),console.log("  [RENDERAPP] Root element children:",Array.from(this.rootElement.children).map(l=>({tag:l.tagName,class:l.className,text:l.textContent.substring(0,50)})));const d=performance.now();this.performanceMetrics.initialRender=d-o,console.log(`\u2713 App rendered in ${this.performanceMetrics.initialRender.toFixed(2)}ms`)}hydrateApp(e,t={}){console.log("  [HYDRATEAPP] Starting hydration");const o=performance.now(),r=this.createBuildContext(t);console.log("  [HYDRATEAPP] Build context created");const i=e.build?e.build(r):e;console.log("  [HYDRATEAPP] Widget tree built"),this.rootVNode=c.build(i,r),console.log("  [HYDRATEAPP] VNode created");const d=R.loadHydrationData();console.log("  [HYDRATEAPP] Hydration data loaded"),R.hydrate(this.rootElement,this.rootVNode,d),console.log("  [HYDRATEAPP] Hydration complete"),this.isHydrated=!0;const l=performance.now();this.performanceMetrics.initialRender=l-o,console.log(`\u2713 App hydrated in ${this.performanceMetrics.initialRender.toFixed(2)}ms`)}update(e){if(console.log("  [UPDATE] Update called"),!this.app||!this.rootElement)throw console.log("  [UPDATE] ERROR: App not initialized"),new Error("App not initialized. Call runApp() first.");const t=performance.now();e&&(console.log("  [UPDATE] Executing update function"),e());const o=this.createBuildContext();console.log("  [UPDATE] Build context created");const r=this.app.build?this.app.build(o):this.app;console.log("  [UPDATE] Widget tree rebuilt");const i=c.build(r,o);console.log("  [UPDATE] New VNode created"),this.renderer||(this.renderer=new g({debugMode:!0})),this.renderer.render(i,this.rootElement,{clear:!0}),this.rootVNode=i;const l=performance.now()-t,a=l>0?l:.01;this.performanceMetrics.updates++,this.performanceMetrics.totalRenderTime+=a,this.performanceMetrics.averageRenderTime=this.performanceMetrics.totalRenderTime/this.performanceMetrics.updates,console.log(`  [UPDATE] Update metrics: updates=${this.performanceMetrics.updates}, renderTime=${l.toFixed(2)}ms`),this.hotReloadEnabled&&console.log(`\u267B Updated in ${l.toFixed(2)}ms`)}registerState(e,t){console.log(`  [REGISTRY] Registering state for ${e}`),this.stateRegistry.set(e,t);const o=t.setState.bind(t);t.setState=r=>{console.log(`  [REGISTRY] setState called for ${e}`),o(r),this.update()}}unregisterState(e){console.log(`  [REGISTRY] Unregistering state for ${e}`),this.stateRegistry.delete(e)}getState(e){return console.log(`  [REGISTRY] Getting state for ${e}`),this.stateRegistry.get(e)||null}hotReload(){if(console.log("  [HOTRELOAD] hotReload called"),!this.hotReloadEnabled){console.warn("Hot reload is not enabled");return}if(console.log("\u{1F525} Hot reloading..."),!this.app||!this.rootElement){console.warn("No app running. Cannot hot reload.");return}this.update()}createBuildContext(e={}){return console.log("  [CONTEXT] Creating build context"),{runtime:this,mediaQuery:this.getMediaQuery(),theme:e.theme||this.getDefaultTheme(),navigator:this.createNavigator(),...e.context}}getMediaQuery(){if(typeof window>"u")return console.log("  [MEDIAQUERY] Server-side - returning default"),{width:1920,height:1080,devicePixelRatio:1};const e={width:window.innerWidth,height:window.innerHeight,devicePixelRatio:window.devicePixelRatio||1,orientation:window.innerWidth>window.innerHeight?"landscape":"portrait"};return console.log("  [MEDIAQUERY] Client-side:",e),e}getDefaultTheme(){return console.log("  [THEME] Creating default Material Design theme"),{primaryColor:"#6750a4",onPrimary:"#ffffff",primaryContainer:"#eaddff",onPrimaryContainer:"#21005e",surface:"#fffbfe",onSurface:"#1c1b1f",outline:"#79747e",outlineVariant:"#cac7cf"}}createNavigator(){return console.log("  [NAVIGATOR] Creating navigator"),{push:e=>{console.log("Navigation not yet implemented:",e)},pop:()=>{console.log("Navigation not yet implemented")}}}getTargetElement(e){if(console.log(`  [TARGET] Getting target element: ${e}`),typeof e=="string"){const t=document.querySelector(e);if(!t)throw console.log(`  [TARGET] ERROR: Element not found for selector: ${e}`),new Error(`Target element "${e}" not found`);return console.log("  [TARGET] Found element by selector"),t}if(e instanceof HTMLElement)return console.log("  [TARGET] Using HTMLElement target"),e;throw console.log("  [TARGET] ERROR: Invalid target type"),new Error("Invalid target: must be a selector string or HTMLElement")}hasSSRContent(e){console.log("  [SSRCHECK] Checking for SSR content");const t=document.getElementById("__FLUTTERJS_HYDRATION_DATA__"),o=t&&e.children.length>0;return console.log(`  [SSRCHECK] Hydration script found: ${t!==null}, Element has children: ${e.children.length>0}`),o}setupHotReload(){if(typeof window>"u"){console.log("  [HOTRELOAD] Server-side environment, skipping");return}console.log("  [HOTRELOAD] Setting up hot reload listeners"),window.addEventListener("flutterjs:hotreload",()=>{console.log("  [HOTRELOAD] Received hot reload event"),this.hotReload()}),window.__flutterjs_hot_reload=()=>{console.log("  [HOTRELOAD] Called via global function"),this.hotReload()},console.log("\u{1F525} Hot reload enabled")}startPerformanceTracking(){if(typeof window>"u"){console.log("  [PERFTRACK] Server-side environment, skipping");return}console.log("  [PERFTRACK] Starting FPS tracking");let e=performance.now(),t=0;const o=()=>{t++;const r=performance.now();if(r>=e+1e3){const i=Math.round(t*1e3/(r-e));this.performanceMetrics.fps=i,console.log(`  [PERFTRACK] FPS: ${i}`),t=0,e=r}requestAnimationFrame(o)};requestAnimationFrame(o)}getMetrics(){if(console.log(`  [METRICS] Getting metrics - app exists: ${this.app!==null}`),!this.app)return console.log("  [METRICS] No app, returning null"),null;const e={...this.performanceMetrics,isHydrated:this.isHydrated,stateCount:this.stateRegistry.size,vnodeStats:this.rootVNode?h.getStats(this.rootVNode):null};return console.log("  [METRICS] Returning metrics:",e),e}destroy(){console.log("  [DESTROY] Destroying runtime"),this.rootElement&&this.renderer&&(console.log("  [DESTROY] Cleaning up event listeners"),this.renderer.cleanupEventListeners(this.rootElement)),console.log(`  [DESTROY] Clearing state registry (size: ${this.stateRegistry.size})`),this.stateRegistry.clear(),typeof window<"u"&&(console.log("  [DESTROY] Removing hot reload listener"),window.removeEventListener("flutterjs:hotreload",this.hotReload),delete window.__flutterjs_hot_reload),this.app=null,this.rootElement=null,this.rootVNode=null,this.renderer=null,console.log("\u2713 Runtime destroyed")}}let n=null;function m(s,e={}){return console.log("[GLOBAL] runApp called"),n||(console.log("[GLOBAL] Creating new global runtime"),n=new u),n.runApp(s,e)}function f(){return console.log(`[GLOBAL] getRuntime called, exists: ${n!==null}`),n}function p(s){if(console.log("[GLOBAL] updateApp called"),!n)throw console.log("[GLOBAL] ERROR: No runtime"),new Error("No app running. Call runApp() first.");n.update(s)}function E(){return console.log("[GLOBAL] getMetrics called"),n?n.getMetrics():(console.log("[GLOBAL] No runtime, returning null"),null)}function T(){if(console.log("[GLOBAL] hotReload called"),!n){console.warn("No app running");return}n.hotReload()}function A(s,e={}){console.log("[GLOBAL] renderToString called");const t={mediaQuery:{width:1920,height:1080,devicePixelRatio:1},theme:e.theme||{},...e.context};console.log("[GLOBAL] SSR: Creating build context");const o=s.build?s.build(t):s;console.log("[GLOBAL] SSR: Building VNode");const r=c.build(o,t);return console.log("[GLOBAL] SSR: Rendering to string"),h.renderServer(r,{title:e.title||"FlutterJS App",meta:e.meta||{},styles:e.styles||[],scripts:e.scripts||[],includeHydration:e.includeHydration!==!1,includeCriticalCSS:e.includeCriticalCSS!==!1,includeRuntime:e.includeRuntime!==!1})}function S(s,e={}){console.log("[GLOBAL] hydrate called"),n||(console.log("[GLOBAL] Creating new global runtime for hydration"),n=new u);const t=e.target||"#root";console.log(`[GLOBAL] Getting target: ${t}`);const o=typeof t=="string"?document.querySelector(t):t;if(!o)throw console.log("[GLOBAL] ERROR: Target not found"),new Error(`Target element "${t}" not found`);return console.log("[GLOBAL] Setting up hydration"),n.rootElement=o,n.app=s,n.hydrateApp(s,e),n}var H={runApp:m,getRuntime:f,updateApp:p,getMetrics:E,hotReload:T,renderToString:A,hydrate:S,VNodeRuntime:u};typeof window<"u"&&(console.log("[GLOBAL] Setting up window.FlutterJS"),window.FlutterJS={runApp:m,getRuntime:f,updateApp:p,getMetrics:E,hotReload:T,renderToString:A,hydrate:S},console.log("[GLOBAL] window.FlutterJS ready"));function x(){n&&n.clearMetrics()}export{u as VNodeRuntime,x as clearMetrics,H as default,E as getMetrics,f as getRuntime,T as hotReload,S as hydrate,A as renderToString,m as runApp,p as updateApp};
//# sourceMappingURL=runtime_index.js.map
