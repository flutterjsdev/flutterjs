class h{static apply(e,t,r={}){if(!e||!Array.isArray(t)||t.length===0)return{success:!0,patchesApplied:0,totalPatches:0};let s=0;const n=[];try{return this.orderPatches(t).forEach(a=>{try{this.applyPatch(e,a),s++}catch(c){n.push(`Patch ${a.type} at ${a.index}: ${c.message}`)}}),{success:n.length===0,patchesApplied:s,totalPatches:t.length,errors:n.length>0?n:void 0}}catch(i){return{success:!1,patchesApplied:s,error:i.message}}}static orderPatches(e){const t={REMOVE:[],CREATE:[],REPLACE:[],UPDATE:[]};return e.forEach(r=>{r.type==="REMOVE"?t.REMOVE.push(r):r.type==="CREATE"?t.CREATE.push(r):r.type==="REPLACE"?t.REPLACE.push(r):t.UPDATE.push(r)}),t.REMOVE.sort((r,s)=>{const n=String(r.index||"0").split(".").length;return String(s.index||"0").split(".").length-n}),[...t.REMOVE,...t.CREATE,...t.REPLACE,...t.UPDATE]}static applyPatch(e,t){const{type:r,index:s}=t;switch(r){case"CREATE":return this._create(e,t);case"REMOVE":return this._remove(e,t);case"REPLACE":return this._replace(e,t);case"UPDATE_PROPS":return this._updateProps(e,t);case"UPDATE_STYLE":return this._updateStyle(e,t);case"UPDATE_TEXT":return this._updateText(e,t);case"UPDATE_EVENTS":return this._updateEvents(e,t);default:throw new Error(`Unknown patch type: ${r}`)}}static _findElement(e,t){if(!t)return e;let r=e;const s=String(t).split(".").map(n=>parseInt(n,10));for(const n of s){if(!r||!r.childNodes||n>=r.childNodes.length)return console.warn(`_findElement: Cannot navigate to index ${t}, at part ${n}, current has ${r?.childNodes?.length||0} children`),null;r=r.childNodes[n]}return r}static _getChildIndex(e){const r=String(e||"0").split(".");return parseInt(r[r.length-1],10)}static _getParentIndex(e){const r=String(e||"0").split(".");return r.length===1?null:(r.pop(),r.join("."))}static _create(e,t){const{index:r,newNode:s}=t;if(!s)throw new Error("CREATE patch requires newNode");const n=this._getParentIndex(r);let i;if(n===null||n===""?i=e:i=this._findElement(e,n),!i)throw new Error(`Parent element not found at index ${n}`);const a=this._createDOMNode(s);if(!a)throw new Error("Failed to create DOM node");const c=this._getChildIndex(r);return c>=i.childNodes.length?i.appendChild(a):i.insertBefore(a,i.childNodes[c]),a}static _remove(e,t){const{index:r}=t,s=this._findElement(e,r);if(!s)throw new Error(`Element not found at index ${r}`);this._cleanup(s),s.parentNode&&s.parentNode.removeChild(s)}static _replace(e,t){const{index:r,newNode:s}=t;if(!s)throw new Error("REPLACE patch requires newNode");const n=this._findElement(e,r);if(!n)throw new Error(`Element not found at index ${r}`);if(n===e)throw new Error("Cannot replace root element (no parent)");const i=this._createDOMNode(s);if(!i)throw new Error("Failed to create replacement DOM node");if(this._cleanup(n),n.parentNode)return n.parentNode.replaceChild(i,n),i;throw new Error("Element has no parent node")}static _updateProps(e,t){const{index:r,value:s}=t;if(!s||!s.changes)return;const n=this._findElement(e,r);if(!n){console.warn(`_updateProps: Element not found at index ${r}`);return}const{changes:i}=s;i.removed&&Object.keys(i.removed).forEach(a=>{this._removeProp(n,a)}),i.updated&&Object.entries(i.updated).forEach(([a,c])=>{this._setProp(n,a,c)}),i.added&&Object.entries(i.added).forEach(([a,c])=>{this._setProp(n,a,c)})}static _updateStyle(e,t){const{index:r,value:s}=t;if(!s||!s.changes)return;const n=this._findElement(e,r);if(!n){console.warn(`_updateStyle: Element not found at index ${r}`);return}const{changes:i}=s;i.removed&&Object.keys(i.removed).forEach(a=>{n.style[a]=""}),i.updated&&Object.entries(i.updated).forEach(([a,c])=>{try{n.style[a]=c}catch{console.warn(`Failed to set style ${a}`)}}),i.added&&Object.entries(i.added).forEach(([a,c])=>{try{n.style[a]=c}catch{console.warn(`Failed to set style ${a}`)}})}static _updateText(e,t){const{index:r,value:s}=t,n=this._findElement(e,r);if(!n){console.warn(`_updateText: Element not found at index ${r}`);return}n.nodeType===3?n.nodeValue=String(s!==void 0?s:""):n.textContent=String(s!==void 0?s:"")}static _updateEvents(e,t){const{index:r,value:s}=t;if(!s||!s.changes)return;const n=this._findElement(e,r);if(!n){console.warn(`_updateEvents: Element not found at index ${r}`);return}const{changes:i}=s;i.removed&&Object.keys(i.removed).forEach(a=>{this._removeEventListener(n,a)}),i.updated&&Object.entries(i.updated).forEach(([a,c])=>{this._removeEventListener(n,a),c&&this._addEventListener(n,a,c)}),i.added&&Object.entries(i.added).forEach(([a,c])=>{c&&this._addEventListener(n,a,c)})}static _createDOMNode(e){if(typeof e=="string")return document.createTextNode(e);if(!e||typeof e!="object")return document.createTextNode("");const t=e.tag||"div",r=document.createElement(t);return e.props&&typeof e.props=="object"&&Object.entries(e.props).forEach(([s,n])=>{this._setProp(r,s,n)}),e.style&&typeof e.style=="object"&&Object.entries(e.style).forEach(([s,n])=>{try{r.style[s]=n}catch{}}),e.children&&Array.isArray(e.children)&&e.children.forEach(s=>{const n=this._createDOMNode(s);n&&r.appendChild(n)}),e.events&&typeof e.events=="object"&&Object.entries(e.events).forEach(([s,n])=>{typeof n=="function"&&this._addEventListener(r,s,n)}),r}static _setProp(e,t,r){if(r==null){this._removeProp(e,t);return}if(t==="className"){e.className=String(r);return}if(t==="value"){(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.tagName==="SELECT")&&(e.value=String(r));return}if(t==="checked"||t==="disabled"||t==="selected"){e[t]=!!r;return}if(t.startsWith("data-")||t.startsWith("aria-")){e.setAttribute(t,String(r));return}try{t in e?e[t]=r:e.setAttribute(t,String(r))}catch{try{e.setAttribute(t,String(r))}catch{}}}static _removeProp(e,t){if(t==="className"){e.className="";return}if(t==="value"){(e.tagName==="INPUT"||e.tagName==="TEXTAREA")&&(e.value="");return}if(t==="checked"||t==="disabled"||t==="selected"){e[t]=!1;return}try{e.removeAttribute(t)}catch{}}static _addEventListener(e,t,r){if(typeof r=="function")try{const s=t.replace(/^on/,"").toLowerCase();e._eventListeners||(e._eventListeners={}),e.addEventListener(s,r),e._eventListeners[s]=r}catch{console.warn(`Failed to add event listener ${t}`)}}static _removeEventListener(e,t){try{const r=t.replace(/^on/,"").toLowerCase();e._eventListeners&&e._eventListeners[r]&&(e.removeEventListener(r,e._eventListeners[r]),delete e._eventListeners[r])}catch{console.warn(`Failed to remove event listener ${t}`)}}static _cleanup(e){if(e&&(e._eventListeners&&(Object.entries(e._eventListeners).forEach(([t,r])=>{try{e.removeEventListener(t,r)}catch{}}),e._eventListeners={}),e.childNodes))for(let t=0;t<e.childNodes.length;t++)this._cleanup(e.childNodes[t])}static validate(e){const t=[],r=["CREATE","REMOVE","REPLACE","UPDATE_PROPS","UPDATE_STYLE","UPDATE_TEXT","UPDATE_EVENTS"];return Array.isArray(e)?(e.forEach((s,n)=>{if(!s.type){t.push(`Patch ${n}: Missing type`);return}r.includes(s.type)||t.push(`Patch ${n}: Invalid type "${s.type}"`)}),t):(t.push("Patches must be an array"),t)}static getStats(e){const t={total:e.length,byType:{}};return e.forEach(r=>{t.byType[r.type]=(t.byType[r.type]||0)+1}),t}}export{h as PatchApplier};
//# sourceMappingURL=patch_applier.js.map
