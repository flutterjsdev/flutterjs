import{VNodeRenderer as u}from"./vnode_renderer.js";class f{static hydrate(e,t,i=null){if(!e)throw new Error("Root element is required for hydration");if(!t)throw new Error("VNode tree is required for hydration");return i||(i=this.loadHydrationData()),i&&!this.validateHydrationData(i)&&(console.warn("Invalid hydration data, proceeding without it"),i=null),this.matchDOMToVNode(e,t),this.attachEventListeners(e,t,i),this.restoreRefs(e,t,i),this.initializeStateBindings(e,t,i),e.setAttribute("data-hydrated","true"),e._hydrated=!0,this.cleanupHydrationData(),e}static matchDOMToVNode(e,t,i="0"){!e||!t||typeof t=="string"||typeof t=="number"||t.tag&&e.nodeType===Node.ELEMENT_NODE&&(e._vnode=t,t._element=e,t._path=i,e.tagName.toLowerCase()!==t.tag.toLowerCase()&&console.warn(`Hydration mismatch at path ${i}: expected <${t.tag}>, got <${e.tagName.toLowerCase()}>`),t.children&&t.children.length>0&&this.matchChildren(e,t.children,i))}static matchChildren(e,t,i){const s=Array.from(e.childNodes);let a=0,r=0;for(;r<t.length&&a<s.length;){const n=s[a],c=t[r];if(n.nodeType===Node.TEXT_NODE&&!n.textContent.trim()){a++;continue}if(c==null){r++;continue}const h=`${i}.${r}`;if(typeof c=="string"||typeof c=="number"){if(n.nodeType===Node.TEXT_NODE){const y=String(c),d=n.textContent;y!==d&&console.warn(`Text content mismatch at ${h}: expected "${y}", got "${d}"`)}a++,r++;continue}if(c.tag&&n.nodeType===Node.ELEMENT_NODE){this.matchDOMToVNode(n,c,h),a++,r++;continue}a++,r++}}static attachEventListeners(e,t,i){!t||typeof t!="object"||!t.tag||(t._element&&t.events&&Object.keys(t.events).length>0&&u.applyEvents(t._element,t.events),t.children&&Array.isArray(t.children)&&t.children.forEach(s=>{this.attachEventListeners(e,s,i)}))}static restoreRefs(e,t,i){if(!(!t||typeof t!="object"||!t.tag)){if(t._element&&t.ref&&typeof t.ref=="function")try{t.ref(t._element)}catch(s){console.error("Error calling ref callback:",s)}t.children&&Array.isArray(t.children)&&t.children.forEach(s=>{this.restoreRefs(e,s,i)})}}static initializeStateBindings(e,t,i){!t||typeof t!="object"||!t.tag||(t.isStateBinding&&t._element&&(e._stateBindings||(e._stateBindings=[]),e._stateBindings.push({element:t._element,widgetId:t.statefulWidgetId,property:t.stateProperty,updateFn:t.updateFn})),t.children&&Array.isArray(t.children)&&t.children.forEach(s=>{this.initializeStateBindings(e,s,i)}))}static loadHydrationData(){if(typeof document>"u")return null;const e=document.getElementById("__FLUTTERJS_HYDRATION_DATA__");if(!e)return null;try{return JSON.parse(e.textContent)}catch(t){return console.error("Failed to parse hydration data:",t),null}}static validateHydrationData(e){if(!e||typeof e!="object"||!e.version)return!1;const t=["widgets","stateBindings","events","refs"];for(const i of t)if(!Array.isArray(e[i]))return!1;return!0}static cleanupHydrationData(){if(typeof document>"u")return;const e=document.getElementById("__FLUTTERJS_HYDRATION_DATA__");e&&e.parentNode&&e.parentNode.removeChild(e)}static isHydrated(e){return e&&(e._hydrated===!0||e.hasAttribute("data-hydrated"))}static generateHydrationData(e){const t={version:"1.0.0",timestamp:Date.now(),widgets:[],stateBindings:[],events:[],refs:[]};return this.collectHydrationData(e,t,"0"),t}static collectHydrationData(e,t,i){!e||typeof e!="object"||!e.tag||(e.metadata&&e.metadata.widgetType&&t.widgets.push({path:i,type:e.metadata.widgetType,props:e.metadata.flutterProps||{},key:e.key}),e.isStateBinding&&t.stateBindings.push({path:i,widgetId:e.statefulWidgetId,property:e.stateProperty}),e.events&&Object.keys(e.events).length>0&&t.events.push({path:i,events:Object.keys(e.events)}),e.ref&&t.refs.push({path:i,hasRef:!0}),e.children&&Array.isArray(e.children)&&e.children.forEach((s,a)=>{s&&typeof s=="object"&&s.tag&&this.collectHydrationData(s,t,`${i}.${a}`)}))}static hydratePartial(e,t){if(!e||!t)throw new Error("Element and VNode required for partial hydration");return this.matchDOMToVNode(e,t),this.attachEventListeners(e,t,null),this.restoreRefs(e,t,null),this.initializeStateBindings(e,t,null),e.setAttribute("data-hydrated","true"),e._hydrated=!0,e}static dehydrate(e){e&&(u.cleanupEventListeners(e),e.removeAttribute("data-hydrated"),delete e._hydrated,delete e._stateBindings,Array.from(e.children).forEach(t=>{this.dehydrate(t)}))}static verifyHydration(e,t){const i={success:!0,mismatches:[],warnings:[],stats:{nodesChecked:0,nodesMatched:0,eventListenersAttached:0,refsRestored:0,stateBindings:0}};return this.verifyNode(e,t,i,"0"),i.success=i.mismatches.length===0,i}static verifyNode(e,t,i,s){if(!(!t||typeof t!="object"||!t.tag)){if(i.stats.nodesChecked++,!e){i.mismatches.push({path:s,type:"missing-dom",message:`DOM node missing for VNode <${t.tag}>`});return}if(!e._vnode||!t._element?i.warnings.push({path:s,type:"missing-reference",message:"VNode-DOM references not set"}):i.stats.nodesMatched++,e.tagName.toLowerCase()!==t.tag.toLowerCase()&&i.mismatches.push({path:s,type:"tag-mismatch",expected:t.tag,actual:e.tagName.toLowerCase()}),t.events&&Object.keys(t.events).length>0&&(e._eventListeners?i.stats.eventListenersAttached+=Object.keys(e._eventListeners).length:i.warnings.push({path:s,type:"missing-events",message:"Event listeners not attached"})),t.ref&&i.stats.refsRestored++,t.isStateBinding&&i.stats.stateBindings++,t.children&&Array.isArray(t.children)){const a=Array.from(e.childNodes).filter(r=>r.nodeType===Node.ELEMENT_NODE);t.children.forEach((r,n)=>{if(r&&typeof r=="object"&&r.tag){const c=a[n];this.verifyNode(c,r,i,`${s}.${n}`)}})}}}static getStats(e){const t={isHydrated:this.isHydrated(e),totalElements:0,elementsWithEvents:0,elementsWithRefs:0,stateBindings:0},i=s=>{!s||s.nodeType!==Node.ELEMENT_NODE||(t.totalElements++,s._eventListeners&&Object.keys(s._eventListeners).length>0&&t.elementsWithEvents++,s._vnode&&s._vnode.ref&&t.elementsWithRefs++,Array.from(s.children).forEach(i))};return i(e),e._stateBindings&&(t.stateBindings=e._stateBindings.length),t}}typeof module<"u"&&module.exports&&(module.exports=f),typeof window<"u"&&(window.Hydrator=f);export{f as Hydrator};
//# sourceMappingURL=hydrator.js.map
