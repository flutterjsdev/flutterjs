import{VNode as f}from"./vnode.js";const i={CREATE:"CREATE",REMOVE:"REMOVE",REPLACE:"REPLACE",UPDATE_PROPS:"UPDATE_PROPS",UPDATE_TEXT:"UPDATE_TEXT",UPDATE_EVENTS:"UPDATE_EVENTS",REORDER:"REORDER"};class c{constructor(e,s,n,t=null){this.type=e,this.index=s,this.node=n,this.value=t}}class y{static diff(e,s,n=0){const t=[];if(!e&&!s)return t;if(!e&&s)return t.push(new c(i.CREATE,n,s)),t;if(e&&!s)return t.push(new c(i.REMOVE,n,e)),t;if(typeof e=="string"||typeof e=="number")return e!==s&&t.push(new c(i.UPDATE_TEXT,n,e,s)),t;if(e instanceof f&&s instanceof f){if(e.tag!==s.tag)return t.push(new c(i.REPLACE,n,e,s)),t;const r=this.diffProps(e,s,n);t.push(...r);const a=this.diffEvents(e,s,n);t.push(...a);const p=this.diffChildren(e.children,s.children,n);return t.push(...p),t}return t.push(new c(i.REPLACE,n,e,s)),t}static diffProps(e,s,n){const t=[],r=e.props||{},a=s.props||{};return this.hasPropsChanged(r,a)&&t.push(new c(i.UPDATE_PROPS,n,e,{old:r,new:a})),t}static diffEvents(e,s,n){const t=[],r=e.events||{},a=s.events||{};return this.hasEventsChanged(r,a)&&t.push(new c(i.UPDATE_EVENTS,n,e,{old:r,new:a})),t}static diffChildren(e=[],s=[],n){const t=[],r=this.groupByKey(e),a=this.groupByKey(s),p=Math.max(e.length,s.length);for(let E=0;E<p;E++){const l=e[E],h=s[E],o=`${n}.${E}`;if(!l&&h)t.push(new c(i.CREATE,o,h));else if(l&&!h)t.push(new c(i.REMOVE,o,l));else if(l&&h){const d=this.diff(l,h,o);t.push(...d)}}return t}static groupByKey(e=[]){const s=new Map,n=[];return e.forEach(t=>{t instanceof f&&t.key?s.set(t.key,t):n.push(t)}),{keyed:s,unkeyed:n}}static hasPropsChanged(e,s){const n=new Set([...Object.keys(e),...Object.keys(s)]);for(const t of n)if(e[t]!==s[t])return!0;return!1}static hasEventsChanged(e,s){const n=new Set([...Object.keys(e),...Object.keys(s)]);for(const t of n)if(e[t]!==s[t])return!0;return!1}static applyPatches(e,s,n=new Map){s.forEach(t=>{const r=this.findElement(e,t.index);if(!r){console.warn(`Could not find element at index ${t.index}`);return}switch(t.type){case i.CREATE:this.applyCreate(r,t);break;case i.REMOVE:this.applyRemove(r,t);break;case i.REPLACE:this.applyReplace(r,t);break;case i.UPDATE_PROPS:this.applyUpdateProps(r,t);break;case i.UPDATE_TEXT:this.applyUpdateText(r,t);break;case i.UPDATE_EVENTS:this.applyUpdateEvents(r,t);break;case i.REORDER:this.applyReorder(r,t);break}})}static findElement(e,s){if(s===0||s==="0")return e;const n=String(s).split(".");let t=e;for(const r of n){const a=parseInt(r);if(t=t.childNodes[a],!t)return null}return t}static applyCreate(e,s){const{VNodeRenderer:n}=require("./vnode_renderer.js"),t=n.createDOMNode(s.node);if(e.childNodes.length===0)e.appendChild(t);else{const r=parseInt(String(s.index).split(".").pop());r<e.childNodes.length?e.insertBefore(t,e.childNodes[r]):e.appendChild(t)}}static applyRemove(e,s){const n=parseInt(String(s.index).split(".").pop());e.childNodes[n]&&e.removeChild(e.childNodes[n])}static applyReplace(e,s){const{VNodeRenderer:n}=require("./vnode_renderer.js"),t=parseInt(String(s.index).split(".").pop()),r=e.childNodes[t];if(r){const a=n.createDOMNode(s.value);e.replaceChild(a,r)}}static applyUpdateProps(e,s){const{VNodeRenderer:n}=require("./vnode_renderer.js");n.updateProps(e,s.value.old,s.value.new)}static applyUpdateText(e,s){e.textContent=String(s.value)}static applyUpdateEvents(e,s){const{VNodeRenderer:n}=require("./vnode_renderer.js");n.updateEvents(e,s.value.old,s.value.new)}static applyReorder(e,s){const n=s.value,t=document.createDocumentFragment();n.forEach(r=>{t.appendChild(e.childNodes[r])}),e.appendChild(t)}static getStats(e){const s={total:e.length,creates:0,removes:0,replaces:0,updates:0};return e.forEach(n=>{n.type===i.CREATE?s.creates++:n.type===i.REMOVE?s.removes++:n.type===i.REPLACE?s.replaces++:s.updates++}),s}}export{c as Patch,i as PatchType,y as VNodeDiffer};
//# sourceMappingURL=vnode_differ.js.map
