import{VNode as u}from"./vnode.js";import{VNodeRenderer as E}from"./vnode_renderer.js";const i={CREATE:"CREATE",REMOVE:"REMOVE",REPLACE:"REPLACE",UPDATE_PROPS:"UPDATE_PROPS",UPDATE_TEXT:"UPDATE_TEXT",UPDATE_EVENTS:"UPDATE_EVENTS",REORDER:"REORDER"};class p{constructor(t,s,n,e=null){this.type=t,this.index=s,this.node=n,this.value=e}}class P{static diff(t,s,n=0){const e=[],a=(r,l)=>{r.length>0&&console.log(`[VNodeDiffer] \u{1FA79} Generated ${r.length} patches from ${l}:`,r.map(c=>`${c.type} @ ${c.index} (${c.node?.tag||"text"})`).join(", "))};if(!t&&!s)return e;if(!t&&s)return e.push(new p(i.CREATE,n,s)),e;if(t&&!s)return e.push(new p(i.REMOVE,n,t)),e;if(typeof t=="string"||typeof t=="number")return t!==s&&e.push(new p(i.UPDATE_TEXT,n,t,s)),e;if(t instanceof u&&s instanceof u){if(t.tag!==s.tag)return e.push(new p(i.REPLACE,n,t,s)),a(e,"diffVNode"),e;const r=this.diffProps(t,s,n);e.push(...r);const l=this.diffEvents(t,s,n);e.push(...l);const c=this.diffChildren(t.children,s.children,n);return e.push(...c),e}return e.push(new p(i.REPLACE,n,t,s)),a(e,"fallback"),e}static diffProps(t,s,n){const e=[],a=t.props||{},r=s.props||{};return this.hasPropsChanged(a,r)&&e.push(new p(i.UPDATE_PROPS,n,t,{old:a,new:r})),e}static diffEvents(t,s,n){const e=[],a=t.events||{},r=s.events||{};return this.hasEventsChanged(a,r)&&e.push(new p(i.UPDATE_EVENTS,n,t,{old:a,new:r})),e}static diffChildren(t=[],s=[],n){const e=[],a=this.groupByKey(t),r=this.groupByKey(s),l=Math.max(t.length,s.length);for(let c=0;c<l;c++){const h=t[c],o=s[c],f=`${n}.${c}`;if(!h&&o)e.push(new p(i.CREATE,f,o));else if(h&&!o)e.push(new p(i.REMOVE,f,h));else if(h&&o){const y=this.diff(h,o,f);e.push(...y)}}return e}static groupByKey(t=[]){const s=new Map,n=[];return t.forEach(e=>{e instanceof u&&e.key?s.set(e.key,e):n.push(e)}),{keyed:s,unkeyed:n}}static hasPropsChanged(t,s){const n=new Set([...Object.keys(t),...Object.keys(s)]);for(const e of n)if(t[e]!==s[e])return!0;return!1}static hasEventsChanged(t,s){const n=new Set([...Object.keys(t),...Object.keys(s)]);for(const e of n)if(t[e]!==s[e])return!0;return!1}static applyPatches(t,s,n=new Map){s.forEach(e=>{const a=this.findElement(t,e.index);if(!a){console.warn(`Could not find element at index ${e.index}`);return}switch(e.type){case i.CREATE:this.applyCreate(a,e);break;case i.REMOVE:this.applyRemove(a,e);break;case i.REPLACE:this.applyReplace(a,e);break;case i.UPDATE_PROPS:this.applyUpdateProps(a,e);break;case i.UPDATE_TEXT:this.applyUpdateText(a,e);break;case i.UPDATE_EVENTS:this.applyUpdateEvents(a,e);break;case i.REORDER:this.applyReorder(a,e);break}})}static findElement(t,s){if(s===0||s==="0")return t;const n=String(s).split(".");let e=t;for(const a of n){const r=parseInt(a);if(e=e.childNodes[r],!e)return null}return e}static applyCreate(t,s){const n=E.createDOMNode(s.node);if(t.childNodes.length===0)t.appendChild(n);else{const e=parseInt(String(s.index).split(".").pop());e<t.childNodes.length?t.insertBefore(n,t.childNodes[e]):t.appendChild(n)}}static applyRemove(t,s){const n=parseInt(String(s.index).split(".").pop());t.childNodes[n]&&t.removeChild(t.childNodes[n])}static applyReplace(t,s){const n=parseInt(String(s.index).split(".").pop()),e=t.childNodes[n];if(e){const a=E.createDOMNode(s.value);t.replaceChild(a,e)}}static applyUpdateProps(t,s){E.updateProps(t,s.value.old,s.value.new)}static applyUpdateText(t,s){t.textContent=String(s.value)}static applyUpdateEvents(t,s){E.updateEvents(t,s.value.old,s.value.new)}static applyReorder(t,s){const n=s.value,e=document.createDocumentFragment();n.forEach(a=>{e.appendChild(t.childNodes[a])}),t.appendChild(e)}static getStats(t){const s={total:t.length,creates:0,removes:0,replaces:0,updates:0};return t.forEach(n=>{n.type===i.CREATE?s.creates++:n.type===i.REMOVE?s.removes++:n.type===i.REPLACE?s.replaces++:s.updates++}),s}}export{p as Patch,i as PatchType,P as VNodeDiffer};
//# sourceMappingURL=vnode_differ.js.map
