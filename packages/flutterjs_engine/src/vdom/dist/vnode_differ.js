import{VNode as u}from"./vnode.js";import{VNodeRenderer as o}from"./vnode_renderer.js";const a={CREATE:"CREATE",REMOVE:"REMOVE",REPLACE:"REPLACE",UPDATE_PROPS:"UPDATE_PROPS",UPDATE_TEXT:"UPDATE_TEXT",UPDATE_EVENTS:"UPDATE_EVENTS",REORDER:"REORDER"};class c{constructor(e,s,n,t=null){this.type=e,this.index=s,this.node=n,this.value=t}}class P{static diff(e,s,n=0){const t=[];if(!e&&!s)return t;if(!e&&s)return t.push(new c(a.CREATE,n,s)),t;if(e&&!s)return t.push(new c(a.REMOVE,n,e)),t;if(typeof e=="string"||typeof e=="number")return e!==s&&t.push(new c(a.UPDATE_TEXT,n,e,s)),t;if(e instanceof u&&s instanceof u){if(e.tag!==s.tag)return t.push(new c(a.REPLACE,n,e,s)),t;const i=this.diffProps(e,s,n);t.push(...i);const r=this.diffEvents(e,s,n);t.push(...r);const p=this.diffChildren(e.children,s.children,n);return t.push(...p),t}return t.push(new c(a.REPLACE,n,e,s)),t}static diffProps(e,s,n){const t=[],i=e.props||{},r=s.props||{};return this.hasPropsChanged(i,r)&&t.push(new c(a.UPDATE_PROPS,n,e,{old:i,new:r})),t}static diffEvents(e,s,n){const t=[],i=e.events||{},r=s.events||{};return this.hasEventsChanged(i,r)&&t.push(new c(a.UPDATE_EVENTS,n,e,{old:i,new:r})),t}static diffChildren(e=[],s=[],n){const t=[],i=this.groupByKey(e),r=this.groupByKey(s),p=Math.max(e.length,s.length);for(let E=0;E<p;E++){const l=e[E],h=s[E],f=`${n}.${E}`;if(!l&&h)t.push(new c(a.CREATE,f,h));else if(l&&!h)t.push(new c(a.REMOVE,f,l));else if(l&&h){const y=this.diff(l,h,f);t.push(...y)}}return t}static groupByKey(e=[]){const s=new Map,n=[];return e.forEach(t=>{t instanceof u&&t.key?s.set(t.key,t):n.push(t)}),{keyed:s,unkeyed:n}}static hasPropsChanged(e,s){const n=new Set([...Object.keys(e),...Object.keys(s)]);for(const t of n)if(e[t]!==s[t])return!0;return!1}static hasEventsChanged(e,s){const n=new Set([...Object.keys(e),...Object.keys(s)]);for(const t of n)if(e[t]!==s[t])return!0;return!1}static applyPatches(e,s,n=new Map){s.forEach(t=>{const i=this.findElement(e,t.index);if(!i){console.warn(`Could not find element at index ${t.index}`);return}switch(t.type){case a.CREATE:this.applyCreate(i,t);break;case a.REMOVE:this.applyRemove(i,t);break;case a.REPLACE:this.applyReplace(i,t);break;case a.UPDATE_PROPS:this.applyUpdateProps(i,t);break;case a.UPDATE_TEXT:this.applyUpdateText(i,t);break;case a.UPDATE_EVENTS:this.applyUpdateEvents(i,t);break;case a.REORDER:this.applyReorder(i,t);break}})}static findElement(e,s){if(s===0||s==="0")return e;const n=String(s).split(".");let t=e;for(const i of n){const r=parseInt(i);if(t=t.childNodes[r],!t)return null}return t}static applyCreate(e,s){const n=o.createDOMNode(s.node);if(e.childNodes.length===0)e.appendChild(n);else{const t=parseInt(String(s.index).split(".").pop());t<e.childNodes.length?e.insertBefore(n,e.childNodes[t]):e.appendChild(n)}}static applyRemove(e,s){const n=parseInt(String(s.index).split(".").pop());e.childNodes[n]&&e.removeChild(e.childNodes[n])}static applyReplace(e,s){const n=parseInt(String(s.index).split(".").pop()),t=e.childNodes[n];if(t){const i=o.createDOMNode(s.value);e.replaceChild(i,t)}}static applyUpdateProps(e,s){o.updateProps(e,s.value.old,s.value.new)}static applyUpdateText(e,s){e.textContent=String(s.value)}static applyUpdateEvents(e,s){o.updateEvents(e,s.value.old,s.value.new)}static applyReorder(e,s){const n=s.value,t=document.createDocumentFragment();n.forEach(i=>{t.appendChild(e.childNodes[i])}),e.appendChild(t)}static getStats(e){const s={total:e.length,creates:0,removes:0,replaces:0,updates:0};return e.forEach(n=>{n.type===a.CREATE?s.creates++:n.type===a.REMOVE?s.removes++:n.type===a.REPLACE?s.replaces++:s.updates++}),s}}export{c as Patch,a as PatchType,P as VNodeDiffer};
//# sourceMappingURL=vnode_differ.js.map
