const r={ONE_WAY:"oneWay",TWO_WAY:"twoWay",EVENT:"event"};class h{constructor({statefulWidgetId:t,stateProperty:e,vnode:i,domElement:n=null,mode:s=r.ONE_WAY,transform:a=null,validate:d=null,debounceMs:m=0}={}){this.statefulWidgetId=t,this.stateProperty=e,this.id=`binding-${t}-${e}-${Date.now()}`,this.vnode=i,this.domElement=n,this.mode=s,this.transform=a,this.validate=d,this.debounceMs=m,this.currentValue=null,this.previousValue=null,this.isDirty=!1,this.isActive=!0,this.debounceTimer=null,this.pendingValue=null,this.onUpdate=null,this.onChange=null,this.onValidationError=null,this.eventListeners=[]}attach(t){if(!t)throw new Error("Cannot attach binding to null element");return this.domElement=t,t._stateBindings||(t._stateBindings=[]),t._stateBindings.push(this),(this.mode===r.TWO_WAY||this.mode===r.EVENT)&&this.attachEventListeners(),this}detach(){if(this.domElement){if(this.removeEventListeners(),this.domElement._stateBindings){const t=this.domElement._stateBindings.indexOf(this);t!==-1&&this.domElement._stateBindings.splice(t,1)}this.domElement=null}}updateDOM(t){if(!this.isActive||!this.domElement)return;this.previousValue=this.currentValue,this.currentValue=t;let e=t;if(typeof this.transform=="function")try{e=this.transform(t)}catch(i){console.error("Transform error:",i);return}if(this.applyToDOM(e),typeof this.onUpdate=="function")try{this.onUpdate(e,this.previousValue)}catch(i){console.error("onUpdate callback error:",i)}this.isDirty=!1}applyToDOM(t){if(!this.domElement)return;const e=this.domElement.tagName,i=this.domElement.type||"";if(this.stateProperty==="className"||this.stateProperty==="class"){this.domElement.className=String(t??"");return}if(this.stateProperty.startsWith("style-")){const n=this.stateProperty.replace(/^style-/,"");this.domElement.style[n]=String(t??"");return}if(this.stateProperty.startsWith("attr-")){const n=this.stateProperty.replace(/^attr-/,"");this.domElement.setAttribute(n,String(t??""));return}if(e==="SPAN"||e==="DIV"||e==="P"||e==="H1"||e==="H2"||e==="H3"||e==="H4"||e==="H5"||e==="H6"){this.domElement.textContent=String(t??"");return}if(e==="INPUT"&&(i==="text"||i==="password"||i==="email"||i==="number"||i==="search"||i==="url"||i==="tel")){this.domElement.value=String(t??"");return}if(e==="TEXTAREA"){this.domElement.value=String(t??"");return}if(e==="SELECT"){this.domElement.value=String(t??"");return}if(e==="INPUT"&&i==="checkbox"){this.domElement.checked=!!t;return}if(e==="INPUT"&&i==="radio"){this.domElement.checked=String(t)===this.domElement.value;return}if(e==="IMG"){this.domElement.src=String(t??"");return}if(e==="A"){this.domElement.href=String(t??"");return}if(this.stateProperty==="className"||this.stateProperty==="class"){this.domElement.className=String(t??"");return}if(this.stateProperty.startsWith("attr-")){const n=this.stateProperty.replace(/^attr-/,"");this.domElement.setAttribute(n,String(t??""));return}if(this.stateProperty.startsWith("style-")){const n=this.stateProperty.replace(/^style-/,"");this.domElement.style[n]=String(t??"");return}this.domElement.textContent=String(t??"")}readFromDOM(){if(!this.domElement)return null;const t=this.domElement.tagName,e=this.domElement.type||"";if(t==="SPAN"||t==="DIV"||t==="P")return this.domElement.textContent;if(t==="INPUT"&&(e==="text"||e==="password"||e==="email"||e==="number")){const i=this.domElement.value;if(e==="number"){const n=parseFloat(i);return isNaN(n)?i:n}return i}return t==="TEXTAREA"?this.domElement.value:t==="SELECT"?this.domElement.value:t==="INPUT"&&e==="checkbox"?this.domElement.checked:t==="INPUT"&&e==="radio"&&this.domElement.checked?this.domElement.value:null}attachEventListeners(){if(!this.domElement)return;const t=this.domElement.tagName,e=this.domElement.type||"";let i=[];t==="INPUT"||t==="TEXTAREA"||t==="SELECT"?i=["input","change"]:(t==="SPAN"||t==="DIV")&&(i=["click","change"]);const n=s=>this.handleDOMChange(s);i.forEach(s=>{this.domElement.addEventListener(s,n),this.eventListeners.push({event:s,handler:n})})}removeEventListeners(){this.domElement&&(this.eventListeners.forEach(({event:t,handler:e})=>{this.domElement.removeEventListener(t,e)}),this.eventListeners=[])}handleDOMChange(t){if(!this.isActive||this.mode===r.ONE_WAY)return;const e=this.readFromDOM();if(typeof this.validate=="function")try{if(!this.validate(e)){typeof this.onValidationError=="function"&&this.onValidationError(e),this.updateDOM(this.currentValue);return}}catch(i){console.error("Validation error:",i),this.updateDOM(this.currentValue);return}this.debounceMs>0?(this.pendingValue=e,this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.notifyChange(this.pendingValue),this.debounceTimer=null},this.debounceMs)):this.notifyChange(e)}notifyChange(t){if(this.isDirty=!0,this.previousValue=this.currentValue,this.currentValue=t,typeof this.onChange=="function")try{this.onChange(t,this.previousValue)}catch(e){console.error("onChange callback error:",e)}}disable(){this.isActive=!1}enable(){this.isActive=!0}isDirtyBinding(){return this.isDirty}clearDirty(){this.isDirty=!1}destroy(){this.detach(),this.onUpdate=null,this.onChange=null,this.onValidationError=null,this.debounceTimer&&clearTimeout(this.debounceTimer)}}class l{constructor(){this.bindings=new Map}register(t){if(!(t instanceof h))throw new Error("Must register StateBinding instance");const e=t.statefulWidgetId,i=t.stateProperty;this.bindings.has(e)||this.bindings.set(e,new Map);const n=this.bindings.get(e);return n.has(i)||n.set(i,[]),n.get(i).push(t),t.id}unregister(t){for(const e of this.bindings.values())for(const i of e.values()){const n=i.findIndex(s=>s.id===t);if(n!==-1)return i[n].destroy(),i.splice(n,1),!0}return!1}updateState(t,e){if(!this.bindings.has(t))return;const i=this.bindings.get(t);Object.entries(e).forEach(([n,s])=>{i.has(n)&&i.get(n).forEach(d=>{d.updateDOM(s)})})}getDirtyBindings(){const t=[];for(const e of this.bindings.values())for(const i of e.values())i.forEach(n=>{n.isDirtyBinding()&&t.push(n)});return t}getDirtyValues(t=null){const e={};for(const[i,n]of this.bindings)if(!(t&&i!==t))for(const[s,a]of n)for(const d of a)d.isDirtyBinding()&&(e[s]=d.currentValue);return e}clearDirty(){for(const t of this.bindings.values())for(const e of t.values())e.forEach(i=>i.clearDirty())}getWidgetBindings(t){if(!this.bindings.has(t))return[];const e=[],i=this.bindings.get(t);for(const n of i.values())e.push(...n);return e}getPropertyBindings(t,e){if(!this.bindings.has(t))return[];const i=this.bindings.get(t);return i.has(e)?i.get(e):[]}removeWidget(t){if(!this.bindings.has(t))return;const e=this.bindings.get(t);for(const i of e.values())i.forEach(n=>n.destroy());this.bindings.delete(t)}clear(){for(const t of this.bindings.values())for(const e of t.values())e.forEach(i=>i.destroy());this.bindings.clear()}getBindingCount(){let t=0;for(const e of this.bindings.values())for(const i of e.values())t+=i.length;return t}getStats(){const t={totalBindings:0,totalWidgets:0,totalProperties:0,dirtyBindings:0,byMode:{}};t.totalWidgets=this.bindings.size;for(const e of this.bindings.values()){t.totalProperties+=e.size;for(const i of e.values())t.totalBindings+=i.length,i.forEach(n=>{n.isDirtyBinding()&&t.dirtyBindings++,t.byMode[n.mode]||(t.byMode[n.mode]=0),t.byMode[n.mode]++})}return t}}function u(o){return new h(o)}function c({statefulWidgetId:o,stateProperty:t,vnode:e,domElement:i=null,transform:n=null,validate:s=null,debounceMs:a=0}={}){return new h({statefulWidgetId:o,stateProperty:t,vnode:e,domElement:i,mode:r.TWO_WAY,transform:n,validate:s,debounceMs:a})}function g({statefulWidgetId:o,stateProperty:t,vnode:e,domElement:i=null,transform:n=null}={}){return new h({statefulWidgetId:o,stateProperty:t,vnode:e,domElement:i,mode:r.ONE_WAY,transform:n})}typeof module<"u"&&module.exports&&(module.exports={StateBinding:h,StateBindingRegistry:l,BindingMode:r,createBinding:u,createTwoWayBinding:c,createOneWayBinding:g}),typeof window<"u"&&(window.StateBinding=h,window.StateBindingRegistry=l,window.BindingMode=r);export{r as BindingMode,h as StateBinding,l as StateBindingRegistry,u as createBinding,g as createOneWayBinding,c as createTwoWayBinding};
//# sourceMappingURL=state_binding.js.map
