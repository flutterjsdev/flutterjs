import{VNode as l}from"./vnode.js";import"./style_converter.js";import{StatelessElement as c,StatefulElement as a,State as u,InheritedElement as d}from"@flutterjs/runtime";class f{constructor(e={}){this.debugMode=e.debugMode||!1,this.runtime=e.runtime,this.buildStack=[],this.debugMode&&!this.runtime&&console.warn("[VNodeBuilder] \u26A0\uFE0F No runtime provided - Element creation will fail"),console.log("[[[ DEBUG_VNODE_FIX_APPLIED_TIMESTAMP ]]] VNodeBuilder initialized")}getWidgetType(e){return!e||typeof e!="object"?"PRIMITIVE":e.tag!==void 0?"VNODE":typeof e=="string"||typeof e=="number"||typeof e=="boolean"?"PRIMITIVE":e instanceof u?"STATE_INSTANCE":typeof e.createState=="function"&&!(e instanceof u)?"STATEFUL_WIDGET":typeof e.build=="function"&&typeof e.createState!="function"&&!(e instanceof u)?"STATELESS_WIDGET":typeof e.updateShouldNotify=="function"?"INHERITED_WIDGET":typeof e.build=="function"?"GENERIC_WIDGET":"UNKNOWN"}build(e,o={}){const n=this.buildStack.join(" \u2192 "),t="  ".repeat(this.buildStack.length);try{if(this.debugMode&&(console.log("=".repeat(80)),console.log(`${t}\u{1F527} VNodeBuilder.build() START`),console.log(`${t}  Build Path: ${n||"ROOT"}`),console.log(`${t}  Input Type: ${typeof e}`),console.log(`${t}  Constructor: ${e?.constructor?.name||"N/A"}`),console.log(`${t}  Has build: ${typeof e?.build=="function"}`),console.log(`${t}  Has createState: ${typeof e?.createState=="function"}`),console.log(`${t}  Has tag: ${e?.tag!==void 0}`),console.log(`${t}  Runtime: ${this.runtime?"\u2714":"\u2717"}`),console.log("=".repeat(80))),!e)return this.debugMode&&console.warn(`${t}\u26A0\uFE0F Widget is null/undefined`),null;if(typeof e=="string")return this.debugMode&&console.log(`${t}\u2714 Text node: "${e.substring(0,50)}${e.length>50?"...":""}"`),e;if(typeof e=="number")return this.debugMode&&console.log(`${t}\u2714 Number node: ${e}`),String(e);if(typeof e=="boolean")return this.debugMode&&console.log(`${t}\u2714 Boolean node (renders nothing)`),null;const r=this.getWidgetType(e);if(this.debugMode&&console.log(`${t}Widget Type Detected: ${r}`),!o.runtime&&this.runtime&&(o.runtime=this.runtime,this.debugMode&&console.log(`${t}\u2714 Injected runtime into context`)),!this.runtime)throw this.createError("MISSING_RUNTIME","VNodeBuilder requires a runtime instance",{suggestion:"Pass runtime to VNodeBuilder constructor: new VNodeBuilder({ runtime: this })",context:{widgetType:e?.constructor?.name}});switch(r){case"VNODE":return this.debugMode&&console.log(`${t}\u2714 Already a VNode (tag: ${e.tag}), returning`),e;case"STATE_INSTANCE":throw this.createError("STATE_PASSED_TO_BUILDER",`State instance "${e.constructor.name}" was passed to VNodeBuilder`,{stateType:e.constructor.name,suggestion:"VNodeBuilder expects Widgets, not State instances. State instances are handled internally by StatefulElement.",expectedFlow:"StatefulWidget \u2192 StatefulElement (creates state) \u2192 State.build()"});case"STATEFUL_WIDGET":return this.debugMode&&console.log(`${t}\u2705 DETECTED STATEFUL WIDGET: ${e.constructor.name}`),this.buildStatefulWidget(e,o,t);case"STATELESS_WIDGET":return this.debugMode&&console.log(`${t}\u2705 DETECTED STATELESS WIDGET: ${e.constructor.name}`),this.buildStatelessWidget(e,o,t);case"INHERITED_WIDGET":return this.debugMode&&console.log(`${t}\u2705 DETECTED INHERITED WIDGET: ${e.constructor.name}`),this.buildInheritedWidget(e,o,t);case"GENERIC_WIDGET":return this.debugMode&&console.warn(`${t}\u26A0\uFE0F Generic widget type (has build but no clear classification)`),this.buildGenericWidget(e,o,t);default:return this.debugMode&&console.warn(`${t}\u26A0\uFE0F Unknown widget type: ${e.constructor?.name||typeof e}`),this.buildGeneric(e,o,t)}}catch(r){return this.handleBuildError(r,e,o,t)}}buildStatelessWidget(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Building StatelessWidget: ${e.constructor.name}`),this.buildStack.push(e.constructor.name);try{const t=new c(e,o.parentElement||null,this.runtime),r=t.build();if(!r)throw this.createError("BUILD_RETURNED_NULL",`${e.constructor.name}.build() returned null`,{suggestion:"build() must return a Widget or VNode, not null/undefined",widgetType:e.constructor.name});if(this.debugMode&&(console.log(`${n}  Result Type: ${typeof r}`),console.log(`${n}  Constructor: ${r?.constructor?.name}`),console.log(`${n}  Has tag: ${r?.tag!==void 0}`)),r&&typeof r=="object"&&r.tag)return this.debugMode&&console.log(`${n}\u2714 Got VNode (tag: ${r.tag}), returning`),r;if(typeof r=="string"||typeof r=="number")return this.debugMode&&console.log(`${n}\u2714 Got primitive value, returning`),r;if(r&&typeof r=="object"&&(typeof r.build=="function"||typeof r.createState=="function"||typeof r.updateShouldNotify=="function"))return this.debugMode&&console.log(`${n}\u{1F504} Got nested Widget: ${r.constructor.name}, recursively building...`),this.build(r,{...o,parentElement:t,runtime:this.runtime});throw this.createError("UNKNOWN_BUILD_RESULT",`${e.constructor.name}.build() returned unexpected type`,{receivedType:typeof r,receivedConstructor:r?.constructor?.name,suggestion:"build() must return: Widget, VNode, string, number, or null",received:r})}finally{this.buildStack.pop()}}catch(t){throw this.wrapError(t,`StatelessWidget: ${e.constructor.name}`)}}buildStatefulWidget(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Building StatefulWidget: ${e.constructor.name}`),this.buildStack.push(e.constructor.name);try{if(typeof e.createState!="function")throw this.createError("NO_CREATE_STATE",`${e.constructor.name} has createState but it's not a function`,{createStateType:typeof e.createState,suggestion:"Implement createState() method in your StatefulWidget"});const t=new a(e,o.parentElement||null,this.runtime);if(!t)throw this.createError("ELEMENT_CREATION_FAILED",`Failed to create StatefulElement for ${e.constructor.name}`,{suggestion:"Check that StatefulElement constructor accepts (widget, parent, runtime)"});try{t.mounted||t.mount()}catch(i){throw this.createError("ELEMENT_MOUNT_FAILED",`Failed to mount StatefulElement: ${i.message}`,{originalError:i,suggestion:"Check element.mount() implementation"})}const r=t.vnode;if(!r)throw this.createError("BUILD_RETURNED_NULL",`State.build() for ${e.constructor.name} returned null`,{suggestion:"State.build() must return a Widget or VNode"});if(r&&typeof r=="object"&&r.tag)return this.debugMode&&console.log(`${n}\u2714 Got VNode (tag: ${r.tag})`),r;if(typeof r=="string"||typeof r=="number")return this.debugMode&&console.log(`${n}\u2714 Got primitive value`),r;if(r&&typeof r=="object"&&(typeof r.build=="function"||typeof r.createState=="function"||typeof r.updateShouldNotify=="function"))return this.debugMode&&console.log(`${n}\u{1F504} Got nested Widget: ${r.constructor.name}`),this.build(r,{...o,parentElement:t,runtime:this.runtime});throw this.createError("UNKNOWN_BUILD_RESULT",`State.build() for ${e.constructor.name} returned unexpected type`,{receivedType:typeof r,receivedConstructor:r?.constructor?.name,suggestion:"State.build() must return: Widget, VNode, string, number, or null"})}finally{this.buildStack.pop()}}catch(t){throw this.wrapError(t,`StatefulWidget: ${e.constructor.name}`)}}buildGenericWidget(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Building Generic Widget: ${e.constructor.name}`),this.buildStack.push(e.constructor.name);try{const r=new c(e,null,this.runtime).build();if(!r)throw this.createError("BUILD_RETURNED_NULL",`Generic widget ${e.constructor.name}.build() returned null`,{suggestion:"build() must return a Widget or VNode"});return r&&typeof r=="object"&&typeof r.build=="function"?(this.debugMode&&console.log(`${n}\u2714 Recovery successful, recursively building...`),this.build(r,o)):r}catch(t){throw this.createError("RECOVERY_FAILED","Failed to build generic widget",{originalError:t.message,widgetType:e.constructor.name,suggestion:"Ensure widget implements build() correctly"})}finally{this.buildStack.pop()}}catch(t){throw this.wrapError(t,`GenericWidget: ${e.constructor.name}`)}}buildInheritedWidget(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Building InheritedWidget: ${e.constructor.name}`),this.buildStack.push(e.constructor.name);try{if(typeof e.updateShouldNotify!="function")throw this.createError("INVALID_UPDATE_SHOULD_NOTIFY",`${e.constructor.name} must implement updateShouldNotify()`,{suggestion:"InheritedWidget requires updateShouldNotify(oldWidget) method"});const t=new d(e,o.parentElement||null,this.runtime);return t.mounted||t.mount(),t.vnode}finally{this.buildStack.pop()}}catch(t){throw this.wrapError(t,`InheritedWidget: ${e.constructor.name}`)}}buildGeneric(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Generic widget builder for: ${e.constructor.name}`);let t=[];try{if(e.child){const i=this.build(e.child,o);i&&(t=[i])}else e.children&&(t=this.buildChildren(e.children,o))}catch(i){throw this.createError("CHILD_BUILD_FAILED",`Failed to build children of ${e.constructor.name}`,{originalError:i.message,suggestion:"Check that child widgets are valid"})}const r=this.getWidgetType(e);return new l({tag:"div",props:{className:`fjs-${r.toLowerCase()}`,"data-widget-type":r,...this.extractCommonProps(e)},children:t,metadata:{widgetType:r,note:"Generic widget - no specific builder implemented"}})}catch(t){throw this.wrapError(t,`Generic builder for ${e?.constructor?.name||"unknown"}`)}}buildChildren(e,o){return e?(Array.isArray(e)||(e=[e]),e.map((n,t)=>{try{return this.build(n,{...o,childIndex:t,runtime:this.runtime})}catch(r){throw this.createError("CHILD_INDEX_FAILED",`Failed to build child at index ${t}`,{originalError:r.message,childIndex:t,childType:typeof n,childConstructor:n?.constructor?.name})}}).filter(n=>n!=null)):[]}getWidgetTypeName(e){return e?e.constructor&&e.constructor.name?e.constructor.name:e.runtimeType?e.runtimeType:e.widget&&e.widget.constructor?e.widget.constructor.name:"Unknown":"Unknown"}extractCommonProps(e){const o={};return e.key&&(o.key=e.key),e._debugLabel&&(o["data-debug-label"]=e._debugLabel),o}createError(e,o,n={}){const t=new Error(o);return t.code=e,t.details=n,t.buildPath=this.buildStack.join(" \u2192 ")||"ROOT",t.timestamp=new Date().toISOString(),t}wrapError(e,o){return e.buildPath||(e.buildPath=this.buildStack.join(" \u2192 ")||"ROOT"),e.context||(e.context=o),e}handleBuildError(e,o,n,t){const r=this.createErrorReport(e,o);throw console.error(""),console.error("\u274C ".repeat(40)),console.error("VNODE BUILD ERROR"),console.error("\u274C ".repeat(40)),console.error(""),console.error("\u{1F4CB} ERROR CODE:",e.code||"UNKNOWN"),console.error("\u{1F4DD} MESSAGE:",e.message),console.error(""),console.error("\u{1F517} BUILD PATH:",r.buildPath),console.error(""),r.widgetInfo&&(console.error("\u{1F50D} WIDGET INFO:"),console.error("   Constructor:",r.widgetInfo.constructor),console.error("   Type:",r.widgetInfo.type),console.error("")),e.details&&(console.error("\u{1F4CC} DETAILS:"),Object.entries(e.details).forEach(([i,s])=>{console.error(i==="suggestion"?`   \u{1F4A1} ${i}: ${s}`:i==="originalError"?`   \u26A0\uFE0F  ${i}: ${s}`:`   ${i}: ${JSON.stringify(s,null,2)}`)}),console.error("")),e.stack&&(console.error("\u{1F4DA} STACK TRACE:"),console.error(e.stack),console.error("")),console.error("\u274C ".repeat(40)),console.error(""),e}createErrorReport(e,o){return{code:e.code||"UNKNOWN",message:e.message,buildPath:e.buildPath||this.buildStack.join(" \u2192 ")||"ROOT",timestamp:e.timestamp||new Date().toISOString(),widgetInfo:o?{constructor:o.constructor?.name||"unknown",type:typeof o,hasBuild:typeof o.build=="function",hasCreateState:typeof o.createState=="function",hasTag:o.tag!==void 0,isStateInstance:o instanceof u}:null,details:e.details||{}}}}export{f as VNodeBuilder};
//# sourceMappingURL=vnode_builder.js.map
