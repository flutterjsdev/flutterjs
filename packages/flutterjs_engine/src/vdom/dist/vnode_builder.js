import{VNode as l}from"./vnode.js";import"./style_converter.js";import{StatelessElement as s,StatefulElement as c}from"@flutterjs/runtime/element";import{InheritedElement as a}from"@flutterjs/runtime/inherited_element";class d{constructor(e={}){this.debugMode=e.debugMode||!1,this.runtime=e.runtime,this.buildStack=[],this.debugMode&&!this.runtime&&console.warn("[VNodeBuilder] \u26A0\uFE0F No runtime provided - Element creation will fail")}build(e,o={}){const n=this.buildStack.join(" \u2192 "),r="  ".repeat(this.buildStack.length);try{if(this.debugMode&&(console.log("=".repeat(80)),console.log(`${r}\u{1F527} VNodeBuilder.build() START`),console.log(`${r}  Build Path: ${n||"ROOT"}`),console.log(`${r}  Input Type: ${typeof e}`),console.log(`${r}  Constructor: ${e?.constructor?.name||"N/A"}`),console.log(`${r}  Has build: ${typeof e?.build=="function"}`),console.log(`${r}  Has createState: ${typeof e?.createState=="function"}`),console.log(`${r}  Has tag: ${e?.tag!==void 0}`),console.log(`${r}  Runtime: ${this.runtime?"\u2713":"\u2717"}`),console.log("=".repeat(80))),!e)return this.debugMode&&console.warn(`${r}\u26A0\uFE0F Widget is null/undefined`),null;if(e&&typeof e=="object"&&e.tag)return this.debugMode&&console.log(`${r}\u2714 Already a VNode (tag: ${e.tag}), returning`),e;if(typeof e=="string")return this.debugMode&&console.log(`${r}\u2714 Text node: "${e.substring(0,50)}${e.length>50?"...":""}"`),e;if(typeof e=="number")return this.debugMode&&console.log(`${r}\u2714 Number node: ${e}`),String(e);if(typeof e=="boolean")return this.debugMode&&console.log(`${r}\u2714 Boolean node (renders nothing)`),null;if(!o.runtime&&this.runtime&&(o.runtime=this.runtime,this.debugMode&&console.log(`${r}\u2714 Injected runtime into context`)),!this.runtime)throw this.createError("MISSING_RUNTIME","VNodeBuilder requires a runtime instance",{suggestion:"Pass runtime to VNodeBuilder constructor: new VNodeBuilder({ runtime: this })",context:{widgetType:e?.constructor?.name}});if(typeof e.build=="function"&&!e.createState)return this.buildStatelessWidget(e,o,r);if(typeof e.createState=="function")return this.buildStatefulWidget(e,o,r);if(e.updateShouldNotify&&typeof e.updateShouldNotify=="function")return this.buildInheritedWidget(e,o,r);if(this.debugMode&&console.warn(`${r}\u26A0\uFE0F Unknown widget type: ${e.constructor?.name||typeof e}`),e&&typeof e=="object"&&typeof e.build=="function"){this.debugMode&&console.warn(`${r}\u26A0\uFE0F Widget escaped type checks, attempting recovery...`);try{const i=new s(e,null,this.runtime).build();return i&&typeof i=="object"&&typeof i.build=="function"?(this.debugMode&&console.log(`${r}\u2714 Recovery successful, recursively building...`),this.build(i,o)):i}catch(t){throw this.createError("RECOVERY_FAILED","Failed to recover widget during generic build",{originalError:t.message,widgetType:e.constructor.name,suggestion:"Ensure widget implements build() or createState() correctly"})}}return this.debugMode&&console.log(`${r}\u{1F4E6} Using generic widget builder`),this.buildGeneric(e,o,r)}catch(t){return this.handleBuildError(t,e,o,r)}}buildStatelessWidget(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Building StatelessWidget: ${e.constructor.name}`),this.buildStack.push(e.constructor.name);try{const r=new s(e,o.parentElement||null,this.runtime),t=r.build();if(!t)throw this.createError("BUILD_RETURNED_NULL",`${e.constructor.name}.build() returned null`,{suggestion:"build() must return a Widget or VNode, not null/undefined",widgetType:e.constructor.name});if(this.debugMode&&(console.log(`${n}  Result Type: ${typeof t}`),console.log(`${n}  Constructor: ${t?.constructor?.name}`),console.log(`${n}  Has tag: ${t?.tag!==void 0}`)),t&&typeof t=="object"&&t.tag)return this.debugMode&&console.log(`${n}\u2714 Got VNode (tag: ${t.tag}), returning`),t;if(typeof t=="string"||typeof t=="number")return this.debugMode&&console.log(`${n}\u2714 Got primitive value, returning`),t;if(t&&typeof t=="object"&&typeof t.build=="function")return this.debugMode&&console.log(`${n}\u{1F504} Got nested Widget: ${t.constructor.name}, recursively building...`),this.build(t,{...o,parentElement:r,runtime:this.runtime});throw this.createError("UNKNOWN_BUILD_RESULT",`${e.constructor.name}.build() returned unexpected type`,{receivedType:typeof t,receivedConstructor:t?.constructor?.name,suggestion:"build() must return: Widget, VNode, string, number, or null",received:t})}finally{this.buildStack.pop()}}catch(r){throw this.wrapError(r,`StatelessWidget: ${e.constructor.name}`)}}buildStatefulWidget(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Building StatefulWidget: ${e.constructor.name}`),this.buildStack.push(e.constructor.name);try{if(typeof e.createState!="function")throw this.createError("NO_CREATE_STATE",`${e.constructor.name} has createState but it's not a function`,{createStateType:typeof e.createState,suggestion:"Implement createState() method in your StatefulWidget"});const r=new c(e,o.parentElement||null,this.runtime);if(!r)throw this.createError("ELEMENT_CREATION_FAILED",`Failed to create StatefulElement for ${e.constructor.name}`,{suggestion:"Check that StatefulElement constructor accepts (widget, parent, runtime)"});try{r.mounted||r.mount()}catch(i){throw this.createError("ELEMENT_MOUNT_FAILED",`Failed to mount StatefulElement: ${i.message}`,{originalError:i,suggestion:"Check element.mount() implementation"})}const t=r.build();if(!t)throw this.createError("BUILD_RETURNED_NULL",`State.build() for ${e.constructor.name} returned null`,{suggestion:"State.build() must return a Widget or VNode"});if(t&&typeof t=="object"&&t.tag)return this.debugMode&&console.log(`${n}\u2714 Got VNode (tag: ${t.tag})`),t;if(typeof t=="string"||typeof t=="number")return this.debugMode&&console.log(`${n}\u2714 Got primitive value`),t;if(t&&typeof t=="object"&&typeof t.build=="function")return this.debugMode&&console.log(`${n}\u{1F504} Got nested Widget: ${t.constructor.name}`),this.build(t,{...o,parentElement:r,runtime:this.runtime});throw this.createError("UNKNOWN_BUILD_RESULT",`State.build() for ${e.constructor.name} returned unexpected type`,{receivedType:typeof t,receivedConstructor:t?.constructor?.name,suggestion:"State.build() must return: Widget, VNode, string, number, or null"})}finally{this.buildStack.pop()}}catch(r){throw this.wrapError(r,`StatefulWidget: ${e.constructor.name}`)}}buildInheritedWidget(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Building InheritedWidget: ${e.constructor.name}`),this.buildStack.push(e.constructor.name);try{if(typeof e.updateShouldNotify!="function")throw this.createError("INVALID_UPDATE_SHOULD_NOTIFY",`${e.constructor.name} must implement updateShouldNotify()`,{suggestion:"InheritedWidget requires updateShouldNotify(oldWidget) method"});const r=new a(e,o.parentElement||null,this.runtime);r.mounted||r.mount();const t=r.build();if(e.child){const i=this.build(e.child,{...o,parentElement:r,runtime:this.runtime});return t&&i&&(t.children||(t.children=[]),t.children.push(i)),t||i}return t?this.build(t,o):null}finally{this.buildStack.pop()}}catch(r){throw this.wrapError(r,`InheritedWidget: ${e.constructor.name}`)}}buildGeneric(e,o,n){try{this.debugMode&&console.log(`${n}\u{1F4E6} Generic widget builder for: ${e.constructor.name}`);let r=[];try{if(e.child){const i=this.build(e.child,o);i&&(r=[i])}else e.children&&(r=this.buildChildren(e.children,o))}catch(i){throw this.createError("CHILD_BUILD_FAILED",`Failed to build children of ${e.constructor.name}`,{originalError:i.message,suggestion:"Check that child widgets are valid"})}const t=this.getWidgetType(e);return new l({tag:"div",props:{className:`fjs-${t.toLowerCase()}`,"data-widget-type":t,...this.extractCommonProps(e)},children:r,metadata:{widgetType:t,note:"Generic widget - no specific builder implemented"}})}catch(r){throw this.wrapError(r,`Generic builder for ${e?.constructor?.name||"unknown"}`)}}buildChildren(e,o){return e?(Array.isArray(e)||(e=[e]),e.map((n,r)=>{try{return this.build(n,{...o,childIndex:r,runtime:this.runtime})}catch(t){throw this.createError("CHILD_INDEX_FAILED",`Failed to build child at index ${r}`,{originalError:t.message,childIndex:r,childType:typeof n,childConstructor:n?.constructor?.name})}}).filter(n=>n!=null)):[]}getWidgetType(e){return e?e.constructor&&e.constructor.name?e.constructor.name:e.runtimeType?e.runtimeType:e.widget&&e.widget.constructor?e.widget.constructor.name:"Unknown":"Unknown"}extractCommonProps(e){const o={};return e.key&&(o.key=e.key),e._debugLabel&&(o["data-debug-label"]=e._debugLabel),o}createError(e,o,n={}){const r=new Error(o);return r.code=e,r.details=n,r.buildPath=this.buildStack.join(" \u2192 ")||"ROOT",r.timestamp=new Date().toISOString(),r}wrapError(e,o){return e.buildPath||(e.buildPath=this.buildStack.join(" \u2192 ")||"ROOT"),e.context||(e.context=o),e}handleBuildError(e,o,n,r){const t=this.createErrorReport(e,o);throw console.error(""),console.error("\u274C ".repeat(40)),console.error("VNODE BUILD ERROR"),console.error("\u274C ".repeat(40)),console.error(""),console.error("\u{1F4CB} ERROR CODE:",e.code||"UNKNOWN"),console.error("\u{1F4DD} MESSAGE:",e.message),console.error(""),console.error("\u{1F517} BUILD PATH:",t.buildPath),console.error(""),t.widgetInfo&&(console.error("\u{1F50D} WIDGET INFO:"),console.error("   Constructor:",t.widgetInfo.constructor),console.error("   Type:",t.widgetInfo.type),console.error("")),e.details&&(console.error("\u{1F4CC} DETAILS:"),Object.entries(e.details).forEach(([i,u])=>{console.error(i==="suggestion"?`   \u{1F4A1} ${i}: ${u}`:i==="originalError"?`   \u26A0\uFE0F  ${i}: ${u}`:`   ${i}: ${JSON.stringify(u,null,2)}`)}),console.error("")),e.stack&&(console.error("\u{1F4DA} STACK TRACE:"),console.error(e.stack),console.error("")),console.error("\u274C ".repeat(40)),console.error(""),e}createErrorReport(e,o){return{code:e.code||"UNKNOWN",message:e.message,buildPath:e.buildPath||this.buildStack.join(" \u2192 ")||"ROOT",timestamp:e.timestamp||new Date().toISOString(),widgetInfo:o?{constructor:o.constructor?.name||"unknown",type:typeof o,hasBuild:typeof o.build=="function",hasCreateState:typeof o.createState=="function",hasTag:o.tag!==void 0}:null,details:e.details||{}}}}export{d as VNodeBuilder};
//# sourceMappingURL=vnode_builder.js.map
