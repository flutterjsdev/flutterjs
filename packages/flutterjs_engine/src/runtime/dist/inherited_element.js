import{Element as u}from"./element.js";class h extends u{constructor(e,t,i){super(e,t,i),this.dependents=new Set,this._inheritedValue=e.data||e.value||null,this._notifying=!1,this.runtime?.debugMode&&console.log(`[InheritedElement] Created ${e.constructor.name}`)}build(){if(!this.widget.child)throw new Error("InheritedWidget must have a child widget");const e=this.widget.child;if(e&&typeof e=="object"&&e.tag)return{tag:"div",props:{"data-widget":this.widget.constructor.name,"data-element-id":this.id,class:"fjs-inherited-widget-wrapper"},children:[e],metadata:{isInheritedWidget:!0,widgetType:this.widget.constructor.name}};if(e&&typeof e=="object"&&(e.build||e.createState||e.render)){const t=this.runtime.createElement(e,this);if(!t)throw new Error("Failed to create element from child widget");t.mounted||t.mount();const i=t.build();if(!i)throw new Error("Child element build returned null");return{tag:"div",props:{"data-widget":this.widget.constructor.name,"data-element-id":this.id,class:"fjs-inherited-widget-wrapper"},children:[i],metadata:{isInheritedWidget:!0,widgetType:this.widget.constructor.name}}}return{tag:"div",props:{"data-widget":this.widget.constructor.name,"data-element-id":this.id,class:"fjs-inherited-widget-wrapper"},children:[e],metadata:{isInheritedWidget:!0,widgetType:this.widget.constructor.name}}}performRebuild(){return this.build()}addDependent(e){if(!e)throw new Error("Cannot add null element as dependent");if(this.dependents.has(e)){this.runtime?.debugMode&&console.warn(`[InheritedElement] Element ${e.id} already registered as dependent`);return}this.dependents.add(e),this.runtime?.debugMode&&console.log(`[InheritedElement] Added dependent ${e.id} (total: ${this.dependents.size})`)}removeDependent(e){if(!e)return;this.dependents.delete(e)&&this.runtime?.debugMode&&console.log(`[InheritedElement] Removed dependent ${e.id} (remaining: ${this.dependents.size})`)}hasDependent(e){return this.dependents.has(e)}get dependentCount(){return this.dependents.size}update(e){const t=this.widget;super.update(e);const i=e.data||e.value||null,n=this._inheritedValue;if(this._inheritedValue=i,this.widget.updateShouldNotify)try{this.widget.updateShouldNotify(t)?(this.runtime?.debugMode&&console.log(`[InheritedElement] Value changed, notifying ${this.dependents.size} dependents`),this.notifyDependents()):this.runtime?.debugMode&&console.log("[InheritedElement] Value changed but updateShouldNotify returned false")}catch(o){console.error(`[InheritedElement] Error in updateShouldNotify: ${o.message}`)}}notifyDependents(){if(this._notifying){this.runtime?.debugMode&&console.warn("[InheritedElement] Recursive notification detected, skipping");return}this._notifying=!0;try{const e=this.runtime?.debugMode?performance.now():0;let t=0;for(const i of this.dependents)i.mounted&&!i.dirty?(i.markNeedsBuild(),t++):!i.mounted&&this.runtime?.debugMode&&console.warn(`[InheritedElement] Dependent ${i.id} is not mounted, skipping`);if(this.runtime?.debugMode){const i=performance.now()-e;console.log(`[InheritedElement] Notified ${t} dependents in ${i.toFixed(2)}ms`)}}finally{this._notifying=!1}}notifySpecificDependents(e){if(!this._notifying){this._notifying=!0;try{for(const t of e)this.dependents.has(t)&&t.mounted&&!t.dirty&&t.markNeedsBuild()}finally{this._notifying=!1}}}mount(){super.mount(),this.runtime?.debugMode&&console.log(`[InheritedElement] Mounted ${this.widget.constructor.name} with ${this.dependents.size} dependents`)}unmount(){const e=this.dependents.size;this.dependents.forEach(t=>{t.mounted&&t._inheritedDependencies?.delete(this.id)}),this.dependents.clear(),this.runtime?.debugMode&&console.log(`[InheritedElement] Unmounted ${this.widget.constructor.name} (cleaned up ${e} dependents)`),super.unmount()}getStats(){return{...super.getStats(),type:"InheritedElement",inheritedValue:this._inheritedValue,dependentCount:this.dependents.size,dependents:Array.from(this.dependents).map(t=>({id:t.id,type:t.constructor.name,mounted:t.mounted}))}}}class a{constructor({child:e,data:t,value:i,key:n}={}){if(!e)throw new Error("InheritedWidget requires a child widget");this.child=e,this.data=t||i||null,this.key=n,this.type="InheritedWidget"}updateShouldNotify(e){return this.data!==e.data}static of(e){return e.dependOnInheritedWidgetOfExactType(this)}createElement(e,t){return new h(this,e,t)}}class d{constructor(){this.listeners=new Set}addListener(e){if(typeof e!="function")throw new Error("Listener must be a function");this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}removeAllListeners(){this.listeners.clear()}notifyListeners(){for(const e of this.listeners)try{e()}catch(t){console.error("[ChangeNotifier] Listener error:",t)}}hasListeners(){return this.listeners.size>0}get listenerCount(){return this.listeners.size}dispose(){this.listeners.clear()}}class l extends d{constructor(e){super(),this._value=e}get value(){return this._value}set value(e){this._value!==e&&(this._value=e,this.notifyListeners())}getValue(){return this._value}setValue(e,t=!0){this._value!==e&&(this._value=e,t&&this.notifyListeners())}}class r extends a{constructor({notifier:e,value:t,child:i,key:n}={}){if(super({child:i,data:t,key:n}),e&&!(e instanceof d))throw new Error("Provider requires a ChangeNotifier instance");this.notifier=e,this.listeners=[]}updateShouldNotify(e){return this.notifier&&e.notifier===this.notifier?!1:this.data!==e.data}getValue(){return this.notifier?this.notifier.value:this.data}static of(e){return e.dependOnInheritedWidgetOfExactType(r)}}export{d as ChangeNotifier,h as InheritedElement,a as InheritedWidget,r as Provider,l as ValueNotifier};
//# sourceMappingURL=inherited_element.js.map
