import"@flutterjs/vdom/vnode_renderer";import{Hydrator as d}from"@flutterjs/vdom/hydrator";import{VNodeBuilder as h}from"@flutterjs/vdom/vnode_builder";function l(){return typeof window<"u"&&typeof document<"u"}function u(){return typeof window>"u"}class a{constructor(e={}){this.config={debugMode:e.debugMode||!1,enableHotReload:e.enableHotReload!==!1,enableStateTracking:e.enableStateTracking!==!1,enablePerformanceTracking:e.enablePerformanceTracking!==!1,mode:e.mode||"csr",target:e.target||"web",isBrowser:l(),isSSR:u(),...e},this.initialized=!1,this.mounted=!1,this.rootElement=null,this.rootWidget=null,this.rootVNode=null,this.currentDOMElement=null,this.appBuilder=null,this.stats={initTime:0,mountTime:0,renderTime:0,updateCount:0,totalUpdateTime:0,averageUpdateTime:0,lastUpdateTime:0},this.hooks={beforeInit:[],afterInit:[],beforeMount:[],afterMount:[],beforeUpdate:[],afterUpdate:[],beforeUnmount:[],afterUnmount:[]},this.errorHandlers=[],this.setupErrorHandling(),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Instance created',{environment:this.config.isBrowser?"browser":"server",mode:this.config.mode})}initialize(e={}){if(this.initialized)return console.warn("[Runtime] Already initialized"),this;const t=performance.now();try{if(this.runHooks("beforeInit"),this.config.debugMode&&console.log("[Runtime] Initializing..."),this.rootElement=e.rootElement,this.config.isBrowser&&!this.rootElement)throw new Error("[Runtime] rootElement required in browser mode");return this.initialized=!0,this.stats.initTime=performance.now()-t,this.runHooks("afterInit"),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Initialized in',this.stats.initTime.toFixed(2),"ms"),this}catch(o){throw this.handleError("initialization",o),o}}runApp(e,t={}){if(!this.initialized)throw new Error("[Runtime] Must call initialize() first");const o=performance.now();try{this.runHooks("beforeMount"),this.config.debugMode&&console.log("[Runtime] Mounting application...");const i=e&&e.tag!==void 0,s=e&&e.build!==void 0;if(i)this.rootVNode=e,this.config.debugMode&&console.log("[Runtime] Using VNode from AppBuilder");else if(s)console.warn("[Runtime] Received widget instead of VNode - building VNode"),typeof e.build=="function"?this.rootVNode=e.build({}):this.rootVNode=e;else throw new Error("[Runtime] Invalid input: expected VNode or Widget");return t.appBuilder&&(this.appBuilder=t.appBuilder),this.config.isBrowser&&this.rootElement?this.renderToDOM():this.config.isSSR&&this.renderToString(),this.mounted=!0,this.stats.mountTime=performance.now()-o,this.runHooks("afterMount"),this.config.debugMode&&(console.log('[Runtime] \xE2\u0153" Mounted in',this.stats.mountTime.toFixed(2),"ms"),this.logStats()),this}catch(i){throw this.handleError("mount",i),i}}renderToDOM(){if(!this.config.isBrowser)throw new Error("[Runtime] Cannot render to DOM in SSR mode");if(!this.rootElement)throw new Error("[Runtime] No root element");if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=performance.now();this.currentDOMElement=h.build(this.rootVNode,this.rootElement,{clear:!0}),this.stats.renderTime=performance.now()-e,this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Rendered to DOM in',this.stats.renderTime.toFixed(2),"ms")}catch(e){throw console.error("[Runtime] DOM rendering failed:",e),e}}renderToString(){if(!this.config.isSSR)return console.warn("[Runtime] renderToString called in browser mode"),"";if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=SimpleVNodeRenderer.renderToString(this.rootVNode);return this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Generated SSR HTML:',e.length,"bytes"),e}catch(e){throw console.error("[Runtime] SSR rendering failed:",e),e}}update(e={}){if(!this.mounted)return console.warn("[Runtime] Cannot update: app not mounted"),this;const t=performance.now();try{this.runHooks("beforeUpdate"),this.config.debugMode&&console.log("[Runtime] Updating..."),this.appBuilder&&e.rebuild!==!1&&this.config.debugMode&&console.log("[Runtime] Rebuilding widget tree with AppBuilder..."),this.config.isBrowser&&this.rootVNode&&(this.currentDOMElement?this.currentDOMElement=SimpleVNodeRenderer.update(this.currentDOMElement,this.rootVNode):this.renderToDOM());const o=performance.now()-t;return this.stats.updateCount++,this.stats.totalUpdateTime+=o,this.stats.averageUpdateTime=this.stats.totalUpdateTime/this.stats.updateCount,this.stats.lastUpdateTime=o,this.runHooks("afterUpdate"),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Updated in',o.toFixed(2),"ms"),this}catch(o){throw this.handleError("update",o),o}}hotReload(e){if(!this.config.enableHotReload)return console.warn("[Runtime] Hot reload disabled"),this;if(!this.config.isBrowser)return console.warn("[Runtime] Hot reload not supported in SSR mode"),this;try{return this.config.debugMode&&console.log('[Runtime] \xF0\u0178"\xA5 Hot reloading...'),this.rootVNode=e,this.currentDOMElement&&this.rootElement&&(SimpleVNodeRenderer.cleanup(this.currentDOMElement),this.renderToDOM()),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Hot reload complete'),this}catch(t){throw this.handleError("hotReload",t),t}}hydrate(e,t={}){if(!this.config.isBrowser)return console.warn("[Runtime] Cannot hydrate in SSR mode"),this;try{return this.config.debugMode&&console.log("[Runtime] Hydrating SSR content..."),d&&typeof d.hydrate=="function"&&d.hydrate(this.rootElement,this.rootVNode,e),this.mounted=!0,this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Hydration complete'),this}catch(o){throw this.handleError("hydrate",o),o}}unmount(){if(!this.mounted)return console.warn("[Runtime] Not mounted"),this;try{return this.runHooks("beforeUnmount"),this.config.debugMode&&console.log("[Runtime] Unmounting..."),this.currentDOMElement&&SimpleVNodeRenderer.cleanup(this.currentDOMElement),this.rootElement.innerHTML="",this.currentDOMElement=null,this.rootVNode=null,this.appBuilder=null,this.mounted=!1,this.runHooks("afterUnmount"),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Unmounted'),this}catch(e){throw this.handleError("unmount",e),e}}dispose(){this.mounted&&this.unmount();for(const e in this.hooks)this.hooks[e]=[];this.errorHandlers=[],this.initialized=!1,this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Disposed')}setupErrorHandling(){this.config.isBrowser&&(window.addEventListener("error",e=>{this.handleError("uncaught",e.error)}),window.addEventListener("unhandledrejection",e=>{this.handleError("promise",e.reason)}))}handleError(e,t){console.error(`[Runtime] Error in ${e}:`,t),this.errorHandlers.forEach(o=>{try{o(e,t)}catch(i){console.error("[Runtime] Error handler failed:",i)}}),this.config.debugMode&&this.config.isBrowser&&this.showErrorOverlay(e,t)}showErrorOverlay(e,t){if(typeof document>"u")return;const o=document.getElementById("__flutterjs_error_overlay__");o&&o.remove();const i=document.createElement("div");i.id="__flutterjs_error_overlay__",i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      font-family: monospace;
    `;const s=document.createElement("div");s.style.cssText=`
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    `,s.innerHTML=`
      <h2 style="color: #d32f2f; margin: 0 0 20px 0;">
        \xF0\u0178'\xA5 Runtime Error
      </h2>
      <p style="color: #666; margin: 0 0 10px 0;">
        <strong>Source:</strong> ${e}
      </p>
      <pre style="
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin: 0;
        color: #c62828;
        overflow-x: auto;
      ">${t.message}</pre>
    `,i.appendChild(s),document.body.appendChild(i)}on(e,t){return this.hooks[e]&&typeof t=="function"&&this.hooks[e].push(t),this}runHooks(e){(this.hooks[e]||[]).forEach(o=>{try{o(this)}catch(i){console.error(`[Runtime] Hook ${e} failed:`,i)}})}onError(e){return typeof e=="function"&&this.errorHandlers.push(e),this}getStats(){return{...this.stats,initialized:this.initialized,mounted:this.mounted,environment:this.config.isBrowser?"browser":"server",vnodeSize:this.rootVNode?JSON.stringify(this.rootVNode).length:0}}logStats(){if(!this.config.debugMode)return;const e=this.getStats();console.group("[Runtime] Statistics"),console.log("Environment:",e.environment),console.log("Mount Time:",`${e.mountTime.toFixed(2)}ms`),console.log("Render Time:",`${e.renderTime.toFixed(2)}ms`),console.log("Updates:",e.updateCount),console.log("Avg Update Time:",`${e.averageUpdateTime.toFixed(2)}ms`),console.log("VNode Size:",`${e.vnodeSize} bytes`),console.groupEnd()}getConfig(){return{...this.config}}isInitialized(){return this.initialized}isMounted(){return this.mounted}}let r=null;function c(n,e={}){r||(r=new a({debugMode:e.debugMode||!1,enableHotReload:!0,enablePerformanceTracking:!0,mode:e.mode||"csr"}));const t=e.container||e.rootElement||(l()?document.getElementById("root"):null);return r.initialize({rootElement:t}),r.runApp(n,e),r}function m(){return r}function f(n){if(!r)throw new Error("No runtime instance");n&&typeof n=="function"&&n(),r.update({rebuild:!1})}function g(n){if(!r){console.warn("No runtime instance");return}r.hotReload(n)}function p(){r&&(r.dispose(),r=null)}var M={FlutterJSRuntime:a,runApp:c,getRuntime:m,updateApp:f,hotReload:g,dispose:p,isBrowser:l,isSSR:u};export{a as FlutterJSRuntime,M as default,p as dispose,m as getRuntime,g as hotReload,c as runApp,f as updateApp};
//# sourceMappingURL=flutterjs_runtime.js.map
