import{VNodeRenderer as d}from"@flutterjs/vdom/vnode_renderer";import{Hydrator as u}from"@flutterjs/vdom/hydrator";import{VNodeBuilder as h}from"@flutterjs/vdom/vnode_builder";function l(){return typeof window<"u"&&typeof document<"u"}function a(){return typeof window>"u"}class c{constructor(e={}){this.config={debugMode:e.debugMode||!1,enableHotReload:e.enableHotReload!==!1,enableStateTracking:e.enableStateTracking!==!1,enablePerformanceTracking:e.enablePerformanceTracking!==!1,mode:e.mode||"csr",target:e.target||"web",isBrowser:l(),isSSR:a(),...e},this.initialized=!1,this.mounted=!1,this.rootElement=null,this.rootWidget=null,this.rootVNode=null,this.currentDOMElement=null,this.appBuilder=null,this.vNodeBuilder=null,this.vNodeRenderer=null,this.hydrator=null,this.stats={initTime:0,mountTime:0,renderTime:0,updateCount:0,totalUpdateTime:0,averageUpdateTime:0,lastUpdateTime:0},this.hooks={beforeInit:[],afterInit:[],beforeMount:[],afterMount:[],beforeUpdate:[],afterUpdate:[],beforeUnmount:[],afterUnmount:[]},this.errorHandlers=[],this.setupErrorHandling(),this.config.debugMode&&console.log("[Runtime] \u2705 Instance created",{environment:this.config.isBrowser?"browser":"server",mode:this.config.mode})}initialize(e={}){if(this.initialized)return console.warn("[Runtime] Already initialized"),this;const t=performance.now();try{if(this.runHooks("beforeInit"),this.config.debugMode&&console.log("[Runtime] Initializing..."),this.rootElement=e.rootElement,this.config.isBrowser&&!this.rootElement)throw new Error("[Runtime] rootElement required in browser mode");return this.config.debugMode&&console.log("[Runtime] \u{1F7E3} Creating VNodeBuilder..."),this.vNodeBuilder=new h({debugMode:this.config.debugMode}),this.config.isBrowser&&(this.config.debugMode&&console.log("[Runtime] \u{1F7E0} Creating VNodeRenderer..."),this.vNodeRenderer=new d({rootElement:this.rootElement,debugMode:this.config.debugMode})),(this.config.mode==="hydrate"||e.hydrateFromSSR)&&(this.config.debugMode&&console.log("[Runtime] \u{1F4A7} Creating Hydrator..."),this.hydrator=new u({rootElement:this.rootElement,debugMode:this.config.debugMode})),this.initialized=!0,this.stats.initTime=performance.now()-t,this.runHooks("afterInit"),this.config.debugMode&&(console.log("[Runtime] \u2705 Initialized in",this.stats.initTime.toFixed(2),"ms"),console.log("[Runtime] \u{1F4CA} Components ready:",{vNodeBuilder:!!this.vNodeBuilder,vNodeRenderer:!!this.vNodeRenderer,hydrator:!!this.hydrator})),this}catch(o){throw this.handleError("initialization",o),o}}runApp(e,t={}){if(!this.initialized)throw new Error("[Runtime] Must call initialize() first");const o=performance.now();try{this.runHooks("beforeMount"),this.config.debugMode&&console.log("[Runtime] Mounting application...");const i=e&&e.tag!==void 0,s=e&&typeof e.build=="function";if(i)this.rootVNode=e,this.config.debugMode&&console.log("[Runtime] \u{1F4E6} Using VNode from AppBuilder");else if(s)this.config.debugMode&&console.log("[Runtime] \u{1F3D7}\uFE0F  Building VNode from Widget class..."),this.vNodeBuilder||(this.vNodeBuilder=new h({debugMode:this.config.debugMode})),this.rootVNode=this.vNodeBuilder.build(e,{context:t.buildContext||{}}),this.config.debugMode&&console.log("[Runtime] \u2705 VNode built successfully");else throw new Error("[Runtime] Invalid input: expected VNode or Widget");return t.appBuilder&&(this.appBuilder=t.appBuilder),this.config.isBrowser&&this.rootElement?this.renderToDOM():this.config.isSSR&&this.renderToString(),this.mounted=!0,this.stats.mountTime=performance.now()-o,this.runHooks("afterMount"),this.config.debugMode&&(console.log("[Runtime] \u2705 Mounted in",this.stats.mountTime.toFixed(2),"ms"),this.logStats()),this}catch(i){throw this.handleError("mount",i),i}}renderToDOM(){if(!this.config.isBrowser)throw new Error("[Runtime] Cannot render to DOM in SSR mode");if(!this.rootElement)throw new Error("[Runtime] No root element");if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=performance.now();this.config.debugMode&&(console.log("[Runtime] \u{1F3A8} Rendering VNode to DOM..."),console.log("[Runtime] \u{1F4E6} VNode structure:",JSON.stringify(this.rootVNode,null,2).substring(0,200)+"...")),this.vNodeRenderer||(this.vNodeRenderer=new d({rootElement:this.rootElement,debugMode:this.config.debugMode})),this.currentDOMElement=this.vNodeRenderer.render(this.rootVNode,this.rootElement,{clear:!0}),this.stats.renderTime=performance.now()-e,this.config.debugMode&&(console.log("[Runtime] \u2705 Rendered to DOM in",this.stats.renderTime.toFixed(2),"ms"),console.log("[Runtime] \u{1F333} DOM Element:",this.currentDOMElement.tagName||"Fragment"))}catch(e){throw console.error("[Runtime] \u274C DOM rendering failed:",e),e}}renderToString(){if(!this.config.isSSR)return console.warn("[Runtime] renderToString called in browser mode"),"";if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=performance.now();this.config.debugMode&&console.log("[Runtime] \u{1F4DD} Rendering VNode to HTML string (SSR)..."),this.vNodeRenderer||(this.vNodeRenderer=new d({debugMode:this.config.debugMode}));const t=this.vNodeRenderer.renderToString(this.rootVNode);return this.stats.renderTime=performance.now()-e,this.config.debugMode&&console.log("[Runtime] \u2705 Generated SSR HTML:",t.length,"bytes in",this.stats.renderTime.toFixed(2),"ms"),t}catch(e){throw console.error("[Runtime] \u274C SSR rendering failed:",e),e}}update(e={}){if(!this.mounted)return console.warn("[Runtime] \u274C Cannot update: app not mounted"),this;const t=performance.now();try{if(this.runHooks("beforeUpdate"),this.config.debugMode&&console.log("[Runtime] \u{1F504} Updating application..."),this.appBuilder&&e.rebuild!==!1){this.config.debugMode&&console.log("[Runtime] \u{1F3D7}\uFE0F  Rebuilding widget tree with AppBuilder...");const i=this.appBuilder.build();this.config.isBrowser&&this.vNodeRenderer&&this.currentDOMElement&&(this.config.debugMode&&console.log("[Runtime] \u{1F50D} Running VNode reconciliation..."),this.currentDOMElement=this.vNodeRenderer.reconcile(this.currentDOMElement,this.rootVNode,i),this.rootVNode=i)}else this.config.isBrowser&&this.rootVNode&&e.forceRender&&(this.config.debugMode&&console.log("[Runtime] \u{1F4A5} Force rendering..."),this.currentDOMElement&&this.vNodeRenderer.cleanup(this.currentDOMElement),this.renderToDOM());const o=performance.now()-t;return this.stats.updateCount++,this.stats.totalUpdateTime+=o,this.stats.averageUpdateTime=this.stats.totalUpdateTime/this.stats.updateCount,this.stats.lastUpdateTime=o,this.runHooks("afterUpdate"),this.config.debugMode&&console.log("[Runtime] \u2705 Updated in",o.toFixed(2),"ms"),this}catch(o){throw this.handleError("update",o),o}}hotReload(e){if(!this.config.enableHotReload)return console.warn("[Runtime] Hot reload disabled"),this;if(!this.config.isBrowser)return console.warn("[Runtime] Hot reload not supported in SSR mode"),this;try{return this.config.debugMode&&console.log("[Runtime] \u{1F525} Hot reloading..."),this.vNodeRenderer&&this.currentDOMElement&&(this.currentDOMElement=this.vNodeRenderer.reconcile(this.currentDOMElement,this.rootVNode,e)),this.rootVNode=e,this.config.debugMode&&console.log("[Runtime] \u2705 Hot reload complete"),this}catch(t){throw this.handleError("hotReload",t),t}}hydrate(e,t={}){if(!this.config.isBrowser)return console.warn("[Runtime] Cannot hydrate in SSR mode"),this;try{return this.config.debugMode&&console.log("[Runtime] \u{1F4A7} Hydrating SSR content..."),this.hydrator||(this.hydrator=new u({rootElement:this.rootElement,debugMode:this.config.debugMode})),this.hydrator.hydrate(this.rootElement,this.rootVNode,e||{}),this.mounted=!0,this.config.debugMode&&console.log("[Runtime] \u2705 Hydration complete"),this}catch(o){throw this.handleError("hydrate",o),o}}unmount(){if(!this.mounted)return console.warn("[Runtime] \u274C Not mounted"),this;try{return this.runHooks("beforeUnmount"),this.config.debugMode&&console.log("[Runtime] \u{1F5D1}\uFE0F  Unmounting..."),this.vNodeRenderer&&this.currentDOMElement&&this.vNodeRenderer.cleanup(this.currentDOMElement),this.rootElement&&(this.rootElement.innerHTML=""),this.currentDOMElement=null,this.rootVNode=null,this.appBuilder=null,this.mounted=!1,this.runHooks("afterUnmount"),this.config.debugMode&&console.log("[Runtime] \u2705 Unmounted"),this}catch(e){throw this.handleError("unmount",e),e}}dispose(){this.mounted&&this.unmount();for(const e in this.hooks)this.hooks[e]=[];this.errorHandlers=[],this.vNodeBuilder=null,this.vNodeRenderer=null,this.hydrator=null,this.initialized=!1,this.config.debugMode&&console.log("[Runtime] \u2705 Disposed")}setupErrorHandling(){this.config.isBrowser&&(window.addEventListener("error",e=>{this.handleError("uncaught",e.error)}),window.addEventListener("unhandledrejection",e=>{this.handleError("promise",e.reason)}))}handleError(e,t){console.error(`[Runtime] \u274C Error in ${e}:`,t),this.errorHandlers.forEach(o=>{try{o(e,t)}catch(i){console.error("[Runtime] Error handler failed:",i)}}),this.config.debugMode&&this.config.isBrowser&&this.showErrorOverlay(e,t)}showErrorOverlay(e,t){if(typeof document>"u")return;const o=document.getElementById("__flutterjs_error_overlay__");o&&o.remove();const i=document.createElement("div");i.id="__flutterjs_error_overlay__",i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      font-family: monospace;
    `;const s=document.createElement("div");s.style.cssText=`
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    `,s.innerHTML=`
      <h2 style="color: #d32f2f; margin: 0 0 20px 0;">\u26A0\uFE0F Runtime Error</h2>
      <p style="color: #666; margin: 0 0 10px 0;">
        <strong>Source:</strong> ${e}
      </p>
      <pre style="
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin: 0;
        color: #c62828;
        overflow-x: auto;
      ">${t.message}</pre>
    `,i.appendChild(s),document.body.appendChild(i)}on(e,t){return this.hooks[e]&&typeof t=="function"&&this.hooks[e].push(t),this}runHooks(e){(this.hooks[e]||[]).forEach(o=>{try{o(this)}catch(i){console.error(`[Runtime] Hook ${e} failed:`,i)}})}onError(e){return typeof e=="function"&&this.errorHandlers.push(e),this}getStats(){return{...this.stats,initialized:this.initialized,mounted:this.mounted,environment:this.config.isBrowser?"browser":"server",vnodeSize:this.rootVNode?JSON.stringify(this.rootVNode).length:0}}logStats(){if(!this.config.debugMode)return;const e=this.getStats();console.group("[Runtime] \u{1F4CA} Statistics"),console.log("Environment:",e.environment),console.log("Mount Time:",`${e.mountTime.toFixed(2)}ms`),console.log("Render Time:",`${e.renderTime.toFixed(2)}ms`),console.log("Updates:",e.updateCount),console.log("Avg Update Time:",`${e.averageUpdateTime.toFixed(2)}ms`),console.log("VNode Size:",`${e.vnodeSize} bytes`),console.groupEnd()}getConfig(){return{...this.config}}isInitialized(){return this.initialized}isMounted(){return this.mounted}}let r=null;function f(n,e={}){r||(r=new c({debugMode:e.debugMode||!1,enableHotReload:!0,enablePerformanceTracking:!0,mode:e.mode||"csr"}));const t=e.container||e.rootElement||(l()?document.getElementById("root"):null);return r.initialize({rootElement:t}),r.runApp(n,e),r}function m(){return r}function g(n){if(!r)throw new Error("No runtime instance");n&&typeof n=="function"&&n(),r.update({rebuild:!0,forceRender:!1})}function p(n){if(!r){console.warn("No runtime instance");return}r.hotReload(n)}function R(){r&&(r.dispose(),r=null)}var E={FlutterJSRuntime:c,runApp:f,getRuntime:m,updateApp:g,hotReload:p,dispose:R,isBrowser:l,isSSR:a};export{c as FlutterJSRuntime,E as default,R as dispose,m as getRuntime,p as hotReload,f as runApp,g as updateApp};
//# sourceMappingURL=flutterjs_runtime.js.map
