import"@flutterjs/vdom/vnode_renderer";import{Hydrator as l}from"@flutterjs/vdom/hydrator";function a(){return typeof window<"u"&&typeof document<"u"}function u(){return typeof window>"u"}class d{static render(e,t,r={}){if(!a())throw new Error("[Runtime] Cannot render to DOM in SSR mode");try{const o=this.createDOMElement(e);return r.clear&&(t.innerHTML=""),t.appendChild(o),o}catch(o){throw console.error("[Runtime] Rendering failed:",o),o}}static createDOMElement(e){if(e==null)return document.createTextNode("");if(typeof e=="string"||typeof e=="number")return document.createTextNode(String(e));if(e.tag){const t=document.createElement(e.tag);return e.props&&Object.entries(e.props).forEach(([r,o])=>{if(r==="className")t.className=o;else if(r==="style"&&typeof o=="object")Object.assign(t.style,o);else if(r!=="children"&&o!==null&&o!==void 0)try{t.setAttribute(r,String(o))}catch(n){console.warn(`[Runtime] Could not set attribute ${r}:`,n.message)}}),e.style&&typeof e.style=="object"&&Object.assign(t.style,e.style),e.events&&typeof e.events=="object"&&Object.entries(e.events).forEach(([r,o])=>{if(typeof o=="function"){const n=r.toLowerCase();t.addEventListener(n,o)}}),e.children&&Array.isArray(e.children)&&e.children.forEach(r=>{const o=this.createDOMElement(r);o&&t.appendChild(o)}),e.ref=t,t}return document.createTextNode(String(e))}static renderToString(e,t={}){a()&&console.warn("[Runtime] renderToString should be called in SSR context");try{return this.vnodeToString(e)}catch(r){throw console.error("[Runtime] SSR rendering failed:",r),r}}static vnodeToString(e){if(e==null)return"";if(typeof e=="string"||typeof e=="number")return this.escapeHtml(String(e));if(e.tag){let t=`<${e.tag}`;if(e.props&&Object.entries(e.props).forEach(([r,o])=>{r!=="children"&&o!==null&&o!==void 0&&(t+=` ${r}="${this.escapeHtml(String(o))}"`)}),e.style&&typeof e.style=="object"){const r=Object.entries(e.style).map(([o,n])=>`${o}:${n}`).join(";");t+=` style="${r}"`}return t+=">",e.children&&Array.isArray(e.children)&&e.children.forEach(r=>{t+=this.vnodeToString(r)}),t+=`</${e.tag}>`,t}return""}static escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,r=>t[r])}static update(e,t){if(!a())throw new Error("[Runtime] Cannot update DOM in SSR mode");const r=e.parentElement;if(r){const o=this.createDOMElement(t);return r.replaceChild(o,e),o}return e}static cleanup(e){e&&(e._vnodeEvents&&(Object.entries(e._vnodeEvents).forEach(([t,r])=>{e.removeEventListener(t,r)}),delete e._vnodeEvents),Array.from(e.children).forEach(t=>{this.cleanup(t)}),e._vnode&&(e._vnode.ref=null))}}class c{constructor(e={}){this.config={debugMode:e.debugMode||!1,enableHotReload:e.enableHotReload!==!1,enableStateTracking:e.enableStateTracking!==!1,enablePerformanceTracking:e.enablePerformanceTracking!==!1,mode:e.mode||"csr",target:e.target||"web",isBrowser:a(),isSSR:u(),...e},this.initialized=!1,this.mounted=!1,this.rootElement=null,this.rootWidget=null,this.rootVNode=null,this.currentDOMElement=null,this.appBuilder=null,this.stats={initTime:0,mountTime:0,renderTime:0,updateCount:0,totalUpdateTime:0,averageUpdateTime:0,lastUpdateTime:0},this.hooks={beforeInit:[],afterInit:[],beforeMount:[],afterMount:[],beforeUpdate:[],afterUpdate:[],beforeUnmount:[],afterUnmount:[]},this.errorHandlers=[],this.setupErrorHandling(),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Instance created',{environment:this.config.isBrowser?"browser":"server",mode:this.config.mode})}initialize(e={}){if(this.initialized)return console.warn("[Runtime] Already initialized"),this;const t=performance.now();try{if(this.runHooks("beforeInit"),this.config.debugMode&&console.log("[Runtime] Initializing..."),this.rootElement=e.rootElement,this.config.isBrowser&&!this.rootElement)throw new Error("[Runtime] rootElement required in browser mode");return this.initialized=!0,this.stats.initTime=performance.now()-t,this.runHooks("afterInit"),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Initialized in',this.stats.initTime.toFixed(2),"ms"),this}catch(r){throw this.handleError("initialization",r),r}}runApp(e,t={}){if(!this.initialized)throw new Error("[Runtime] Must call initialize() first");const r=performance.now();try{this.runHooks("beforeMount"),this.config.debugMode&&console.log("[Runtime] Mounting application...");const o=e&&e.tag!==void 0,n=e&&e.build!==void 0;if(o)this.rootVNode=e,this.config.debugMode&&console.log("[Runtime] Using VNode from AppBuilder");else if(n)console.warn("[Runtime] Received widget instead of VNode - building VNode"),typeof e.build=="function"?this.rootVNode=e.build({}):this.rootVNode=e;else throw new Error("[Runtime] Invalid input: expected VNode or Widget");return t.appBuilder&&(this.appBuilder=t.appBuilder),this.config.isBrowser&&this.rootElement?this.renderToDOM():this.config.isSSR&&this.renderToString(),this.mounted=!0,this.stats.mountTime=performance.now()-r,this.runHooks("afterMount"),this.config.debugMode&&(console.log('[Runtime] \xE2\u0153" Mounted in',this.stats.mountTime.toFixed(2),"ms"),this.logStats()),this}catch(o){throw this.handleError("mount",o),o}}renderToDOM(){if(!this.config.isBrowser)throw new Error("[Runtime] Cannot render to DOM in SSR mode");if(!this.rootElement)throw new Error("[Runtime] No root element");if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=performance.now();this.currentDOMElement=d.render(this.rootVNode,this.rootElement,{clear:!0}),this.stats.renderTime=performance.now()-e,this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Rendered to DOM in',this.stats.renderTime.toFixed(2),"ms")}catch(e){throw console.error("[Runtime] DOM rendering failed:",e),e}}renderToString(){if(!this.config.isSSR)return console.warn("[Runtime] renderToString called in browser mode"),"";if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=d.renderToString(this.rootVNode);return this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Generated SSR HTML:',e.length,"bytes"),e}catch(e){throw console.error("[Runtime] SSR rendering failed:",e),e}}update(e={}){if(!this.mounted)return console.warn("[Runtime] Cannot update: app not mounted"),this;const t=performance.now();try{this.runHooks("beforeUpdate"),this.config.debugMode&&console.log("[Runtime] Updating..."),this.appBuilder&&e.rebuild!==!1&&this.config.debugMode&&console.log("[Runtime] Rebuilding widget tree with AppBuilder..."),this.config.isBrowser&&this.rootVNode&&(this.currentDOMElement?this.currentDOMElement=d.update(this.currentDOMElement,this.rootVNode):this.renderToDOM());const r=performance.now()-t;return this.stats.updateCount++,this.stats.totalUpdateTime+=r,this.stats.averageUpdateTime=this.stats.totalUpdateTime/this.stats.updateCount,this.stats.lastUpdateTime=r,this.runHooks("afterUpdate"),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Updated in',r.toFixed(2),"ms"),this}catch(r){throw this.handleError("update",r),r}}hotReload(e){if(!this.config.enableHotReload)return console.warn("[Runtime] Hot reload disabled"),this;if(!this.config.isBrowser)return console.warn("[Runtime] Hot reload not supported in SSR mode"),this;try{return this.config.debugMode&&console.log('[Runtime] \xF0\u0178"\xA5 Hot reloading...'),this.rootVNode=e,this.currentDOMElement&&this.rootElement&&(d.cleanup(this.currentDOMElement),this.renderToDOM()),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Hot reload complete'),this}catch(t){throw this.handleError("hotReload",t),t}}hydrate(e,t={}){if(!this.config.isBrowser)return console.warn("[Runtime] Cannot hydrate in SSR mode"),this;try{return this.config.debugMode&&console.log("[Runtime] Hydrating SSR content..."),l&&typeof l.hydrate=="function"&&l.hydrate(this.rootElement,this.rootVNode,e),this.mounted=!0,this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Hydration complete'),this}catch(r){throw this.handleError("hydrate",r),r}}unmount(){if(!this.mounted)return console.warn("[Runtime] Not mounted"),this;try{return this.runHooks("beforeUnmount"),this.config.debugMode&&console.log("[Runtime] Unmounting..."),this.currentDOMElement&&d.cleanup(this.currentDOMElement),this.rootElement.innerHTML="",this.currentDOMElement=null,this.rootVNode=null,this.appBuilder=null,this.mounted=!1,this.runHooks("afterUnmount"),this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Unmounted'),this}catch(e){throw this.handleError("unmount",e),e}}dispose(){this.mounted&&this.unmount();for(const e in this.hooks)this.hooks[e]=[];this.errorHandlers=[],this.initialized=!1,this.config.debugMode&&console.log('[Runtime] \xE2\u0153" Disposed')}setupErrorHandling(){this.config.isBrowser&&(window.addEventListener("error",e=>{this.handleError("uncaught",e.error)}),window.addEventListener("unhandledrejection",e=>{this.handleError("promise",e.reason)}))}handleError(e,t){console.error(`[Runtime] Error in ${e}:`,t),this.errorHandlers.forEach(r=>{try{r(e,t)}catch(o){console.error("[Runtime] Error handler failed:",o)}}),this.config.debugMode&&this.config.isBrowser&&this.showErrorOverlay(e,t)}showErrorOverlay(e,t){if(typeof document>"u")return;const r=document.getElementById("__flutterjs_error_overlay__");r&&r.remove();const o=document.createElement("div");o.id="__flutterjs_error_overlay__",o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      font-family: monospace;
    `;const n=document.createElement("div");n.style.cssText=`
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    `,n.innerHTML=`
      <h2 style="color: #d32f2f; margin: 0 0 20px 0;">
        \xF0\u0178'\xA5 Runtime Error
      </h2>
      <p style="color: #666; margin: 0 0 10px 0;">
        <strong>Source:</strong> ${e}
      </p>
      <pre style="
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin: 0;
        color: #c62828;
        overflow-x: auto;
      ">${t.message}</pre>
    `,o.appendChild(n),document.body.appendChild(o)}on(e,t){return this.hooks[e]&&typeof t=="function"&&this.hooks[e].push(t),this}runHooks(e){(this.hooks[e]||[]).forEach(r=>{try{r(this)}catch(o){console.error(`[Runtime] Hook ${e} failed:`,o)}})}onError(e){return typeof e=="function"&&this.errorHandlers.push(e),this}getStats(){return{...this.stats,initialized:this.initialized,mounted:this.mounted,environment:this.config.isBrowser?"browser":"server",vnodeSize:this.rootVNode?JSON.stringify(this.rootVNode).length:0}}logStats(){if(!this.config.debugMode)return;const e=this.getStats();console.group("[Runtime] Statistics"),console.log("Environment:",e.environment),console.log("Mount Time:",`${e.mountTime.toFixed(2)}ms`),console.log("Render Time:",`${e.renderTime.toFixed(2)}ms`),console.log("Updates:",e.updateCount),console.log("Avg Update Time:",`${e.averageUpdateTime.toFixed(2)}ms`),console.log("VNode Size:",`${e.vnodeSize} bytes`),console.groupEnd()}getConfig(){return{...this.config}}isInitialized(){return this.initialized}isMounted(){return this.mounted}}let i=null;function h(s,e={}){i||(i=new c({debugMode:e.debugMode||!1,enableHotReload:!0,enablePerformanceTracking:!0,mode:e.mode||"csr"}));const t=e.container||e.rootElement||(a()?document.getElementById("root"):null);return i.initialize({rootElement:t}),i.runApp(s,e),i}function f(){return i}function m(s){if(!i)throw new Error("No runtime instance");s&&typeof s=="function"&&s(),i.update({rebuild:!1})}function g(s){if(!i){console.warn("No runtime instance");return}i.hotReload(s)}function p(){i&&(i.dispose(),i=null)}var R={FlutterJSRuntime:c,runApp:h,getRuntime:f,updateApp:m,hotReload:g,dispose:p,isBrowser:a,isSSR:u};export{c as FlutterJSRuntime,R as default,p as dispose,f as getRuntime,g as hotReload,h as runApp,m as updateApp};
//# sourceMappingURL=flutterjs_runtime.js.map
