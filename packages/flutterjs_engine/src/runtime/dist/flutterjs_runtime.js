import{VNodeRuntime as f,renderToString as I,hydrate as N}from"@flutterjs/vdom/runtime_index";import{StatelessElement as H,StatefulElement as B,ComponentElement as $}from"@flutterjs/runtime/element";import{InheritedElement as A}from"@flutterjs/runtime/inherited_element";import{VNodeBuilder as h}from"@flutterjs/vdom/vnode_builder";import{VNodeRenderer as g}from"@flutterjs/vdom/vnode_renderer";function m(){return typeof window<"u"&&typeof document<"u"}function p(){return typeof window>"u"}function a(n){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(n).replace(/[&<>"']/g,t=>e[t])}function _(){return`fjs-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function b(n,...e){if(!e.length)return n;const t=e.shift();if(c(n)&&c(t))for(const r in t)c(t[r])?(n[r]||Object.assign(n,{[r]:{}}),b(n[r],t[r])):Object.assign(n,{[r]:t[r]});return b(n,...e)}function c(n){return n&&typeof n=="object"&&!Array.isArray(n)}function V(n){return n&&n.tag!==void 0&&(n.props!==void 0||n.children!==void 0)&&n.build===void 0&&n.createState===void 0&&n.createElement===void 0}function O(n){return n&&(typeof n.build=="function"||typeof n.createState=="function"||typeof n.render=="function"||typeof n.createElement=="function")}class d extends f{constructor(e={}){super(),this.flutterConfig={debugMode:e.debugMode||!1,enableHotReload:e.enableHotReload!==!1,enableStateTracking:e.enableStateTracking!==!1,enablePerformanceTracking:e.enablePerformanceTracking!==!1,enableErrorBoundaries:e.enableErrorBoundaries!==!1,target:e.target||"web",isBrowser:m(),isSSR:p(),strictMode:e.strictMode||!1,...e},this.initialized=!1,this.mounted=!1,this.originalInput=null,this.inputType=null,this.elementRegistry=new Map,this.widgetCache=new WeakMap,this.errorBoundaries=[],this.lifecycleCallbacks={onElementCreated:[],onElementMounted:[],onElementUpdated:[],onElementUnmounted:[],onError:[],onStateChange:[]},this.performanceMarks=new Map,this.setupErrorHandling(),this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u2705 Enhanced runtime created",{environment:this.flutterConfig.isBrowser?"browser":"server",hotReload:this.flutterConfig.enableHotReload,strictMode:this.flutterConfig.strictMode})}initialize(e={}){if(this.initialized)return this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u26A0\uFE0F  Already initialized, skipping"),this;const t=performance.now();try{this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F527} Initializing runtime..."),e.rootElement&&(this.rootElement=e.rootElement,this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F4CD} Root element set:",this.rootElement.id||this.rootElement.tagName)),this.flutterConfig.isBrowser&&!this.rootElement&&console.warn("[FlutterJSRuntime] \u26A0\uFE0F  No root element provided in browser mode"),this.initialized=!0;const r=performance.now()-t;return this.flutterConfig.debugMode&&console.log(`[FlutterJSRuntime] \u2705 Initialized in ${r.toFixed(2)}ms`),this}catch(r){throw this.handleError("initialize",r,{options:e}),r}}createElement(e,t=null){if(!e)throw new Error("[FlutterJSRuntime.createElement] Widget is required");const r=this.flutterConfig.enablePerformanceTracking?performance.now():0;try{this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime.createElement] Creating element for:",e.constructor.name);let i=null;if(this.widgetCache.has(e)){const l=this.widgetCache.get(e);if(l&&!l.unmounted)return this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime.createElement] Using cached element"),l}if(this.isStatelessWidget(e))this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime.createElement] \u2192 StatelessElement"),i=new H(e,t,this);else if(this.isStatefulWidget(e))this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime.createElement] \u2192 StatefulElement"),i=new B(e,t,this);else if(this.isInheritedWidget(e))this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime.createElement] \u2192 InheritedElement"),i=new A(e,t,this);else if(this.isComponentWidget(e))this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime.createElement] \u2192 ComponentElement"),i=new $(e,t,this);else if(typeof e.createElement=="function")this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime.createElement] \u2192 Custom createElement"),i=e.createElement(t,this);else throw new Error(`[FlutterJSRuntime.createElement] Unknown widget type: ${e.constructor.name}. Widget must be StatelessWidget, StatefulWidget, InheritedWidget, or implement createElement().`);if(i){const l=_();i._id=l,this.elementRegistry.set(l,i),this.widgetCache.set(e,i),this.triggerLifecycleCallback("onElementCreated",i)}if(this.flutterConfig.enablePerformanceTracking){const l=performance.now()-r;this.recordPerformance("createElement",e.constructor.name,l)}return i}catch(i){throw this.handleError("createElement",i,{widget:e,parent:t}),i}}isStatelessWidget(e){return e?e.constructor.name==="StatelessWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="StatelessWidget"?!0:typeof e.build=="function"&&!e.createState&&!e.child&&!e.updateShouldNotify:!1}isStatefulWidget(e){return e?e.constructor.name==="StatefulWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="StatefulWidget"?!0:typeof e.createState=="function":!1}isInheritedWidget(e){return e?e.constructor.name==="InheritedWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="InheritedWidget"?!0:e.child!==void 0&&typeof e.updateShouldNotify=="function":!1}isComponentWidget(e){return e?typeof e.render=="function"?!0:typeof e.build=="function"&&typeof e.createState!="function"&&!e.updateShouldNotify:!1}runApp(e,t={}){try{this.initialized||(this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] Auto-initializing before runApp"),this.initialize({rootElement:this.rootElement||t.rootElement})),this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F680} Starting Flutter app..."),this.originalInput=e;const r=V(e),i=O(e);if(this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] Input type:",{isVNode:r,isWidget:i,constructorName:e?.constructor?.name,hasTag:e?.tag!==void 0,hasBuild:typeof e?.build=="function"}),r)return this.inputType="vnode",this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F4E6} Input is VNode, rendering directly"),this.app=e,this.rootVNode=e,this.flutterConfig.isBrowser&&this.rootElement&&(this.renderer||(this.renderer=new g({debugMode:this.flutterConfig.debugMode})),this.renderer.render(this.rootVNode,this.rootElement,{clear:!0})),this.mounted=!0,this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u2705 VNode rendered directly"),this;if(i){this.inputType="widget",this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F527} Input is Widget, building VNode..."),this.app=e;const l=this.createBuildContext({...t,runtime:this,flutterConfig:this.flutterConfig}),s=new h({debugMode:this.flutterConfig.debugMode,runtime:this});return this.rootVNode=s.build(e,l),this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u2705 VNode built from Widget"),this.flutterConfig.isBrowser&&this.rootElement&&(this.renderer||(this.renderer=new g({debugMode:this.flutterConfig.debugMode})),this.renderer.render(this.rootVNode,this.rootElement,{clear:!0})),this.mounted=!0,this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u2705 Widget rendered to DOM"),this}else throw new Error(`[FlutterJSRuntime] Invalid input type. Expected Widget or VNode, got: ${typeof e}. Constructor: ${e?.constructor?.name||"unknown"}`)}catch(r){throw this.handleError("runApp",r,{input:e,options:t}),r}}update(e){try{if(this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F504} Updating application..."),e&&typeof e=="function"&&e(),this.inputType==="widget"&&this.originalInput){const t=this.createBuildContext({runtime:this,flutterConfig:this.flutterConfig}),i=new h({debugMode:this.flutterConfig.debugMode,runtime:this}).build(this.originalInput,t);this.renderer&&this.rootElement&&this.renderer.render(i,this.rootElement,{clear:!0}),this.rootVNode=i}else this.inputType==="vnode"&&console.warn("[FlutterJSRuntime] Cannot auto-rebuild from VNode. Provide new VNode to update().");this.triggerLifecycleCallback("onStateChange",{timestamp:Date.now(),updateFn:e?e.name:"anonymous"}),this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u2705 Update complete")}catch(t){throw this.handleError("update",t,{updateFn:e}),t}}onElementMounted(e){e&&(this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F50C} Element mounted:",e.widget?.constructor.name),this.triggerLifecycleCallback("onElementMounted",e))}onElementUpdated(e){e&&(this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F504} Element updated:",e.widget?.constructor.name),this.triggerLifecycleCallback("onElementUpdated",e))}onElementUnmounted(e){e&&(this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F5D1}\uFE0F Element unmounted:",e.widget?.constructor.name),e._id&&this.elementRegistry.delete(e._id),e.widget&&this.widgetCache.delete(e.widget),this.triggerLifecycleCallback("onElementUnmounted",e))}on(e,t){return this.lifecycleCallbacks[e]&&typeof t=="function"?(this.lifecycleCallbacks[e].push(t),this.flutterConfig.debugMode&&console.log(`[FlutterJSRuntime] \u{1F4DD} Registered callback for: ${e}`)):console.warn(`[FlutterJSRuntime] Unknown event: ${e}`),this}off(e,t){if(this.lifecycleCallbacks[e]){const r=this.lifecycleCallbacks[e].indexOf(t);r>-1&&this.lifecycleCallbacks[e].splice(r,1)}return this}triggerLifecycleCallback(e,t){(this.lifecycleCallbacks[e]||[]).forEach(i=>{try{i(t,this)}catch(l){console.error(`[FlutterJSRuntime] Callback error (${e}):`,l)}})}setupErrorHandling(){if(!this.flutterConfig.isBrowser||this._errorHandlingSetup)return;this._errorHandlingSetup=!0;const e=r=>{this.handleError("uncaught",r.error||r.message,{filename:r.filename,lineno:r.lineno,colno:r.colno})},t=r=>{this.handleError("promise",r.reason,{promise:r.promise})};window.addEventListener("error",e),window.addEventListener("unhandledrejection",t),this._errorHandlers={errorHandler:e,rejectionHandler:t}}handleError(e,t,r={}){const i={source:e,error:t,context:r,timestamp:Date.now(),stack:t instanceof Error?t.stack:null};console.error(`[FlutterJSRuntime] \u274C Error in ${e}:`,t),this.flutterConfig.debugMode&&t instanceof Error&&t.stack&&console.error("[FlutterJSRuntime] Stack trace:",t.stack),this.triggerLifecycleCallback("onError",i),this.flutterConfig.debugMode&&this.flutterConfig.isBrowser&&this.showErrorOverlay(e,t,r)}showErrorOverlay(e,t,r){try{if(typeof document>"u")return;const i=document.getElementById("__flutterjs_error_overlay__");i&&i.remove();const l=t instanceof Error?t.message:String(t),s=t instanceof Error&&t.stack?t.stack.split(`
`).slice(0,10).join(`
`):"No stack trace available",u=document.createElement("div");u.id="__flutterjs_error_overlay__",u.style.cssText=`
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.9); color: white; z-index: 999999;
        overflow-y: auto; font-family: 'Monaco', 'Menlo', monospace;
        font-size: 13px; padding: 20px;
      `,u.innerHTML=`
        <div style="max-width: 900px; margin: 0 auto;">
          <div style="background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            padding: 20px; border-radius: 8px 8px 0 0; display: flex;
            align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2);
                border-radius: 50%; display: flex; align-items: center;
                justify-content: center; font-size: 24px;">\u26A0</div>
              <div>
                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">
                  ${a(e.charAt(0).toUpperCase()+e.slice(1))} Error
                </h2>
                <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 12px;">
                  FlutterJS Runtime Error
                </p>
              </div>
            </div>
            <button onclick="this.parentElement.parentElement.parentElement.remove()"
              style="background: rgba(255,255,255,0.2); border: none; color: white;
              width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
              font-size: 18px;">\xD7</button>
          </div>
          <div style="background: #1e1e1e; padding: 20px; border-radius: 0 0 8px 8px;">
            <div style="margin-bottom: 20px;">
              <h3 style="color: #ff6b6b; margin: 0 0 12px 0; font-size: 14px;
                font-weight: 600; text-transform: uppercase;">Error Message</h3>
              <pre style="background: #2d2d2d; padding: 16px; border-radius: 6px;
                border-left: 4px solid #d32f2f; margin: 0; overflow-x: auto;
                color: #ff8a80; line-height: 1.5;">${a(l)}</pre>
            </div>
            ${s&&s!=="No stack trace available"?`
              <div style="margin-bottom: 20px;">
                <h3 style="color: #64b5f6; margin: 0 0 12px 0; font-size: 14px;
                  font-weight: 600; text-transform: uppercase;">Stack Trace</h3>
                <pre style="background: #2d2d2d; padding: 16px; border-radius: 6px;
                  border-left: 4px solid #1976d2; margin: 0; overflow-x: auto;
                  color: #90caf9; line-height: 1.6; font-size: 12px;">${a(s)}</pre>
              </div>
            `:""}
            ${Object.keys(r).length>0?`
              <div>
                <h3 style="color: #81c784; margin: 0 0 12px 0; font-size: 14px;
                  font-weight: 600; text-transform: uppercase;">Context</h3>
                <pre style="background: #2d2d2d; padding: 16px; border-radius: 6px;
                  border-left: 4px solid #388e3c; margin: 0; overflow-x: auto;
                  color: #a5d6a7; line-height: 1.6; font-size: 12px;">${a(JSON.stringify(r,null,2))}</pre>
              </div>
            `:""}
          </div>
        </div>
      `,document.body.appendChild(u)}catch(i){console.error("[FlutterJSRuntime] Failed to show error overlay:",i)}}recordPerformance(e,t,r){if(!this.flutterConfig.enablePerformanceTracking)return;const i=`${e}:${t}`;this.performanceMarks.has(i)||this.performanceMarks.set(i,{count:0,totalTime:0,avgTime:0,minTime:1/0,maxTime:0});const l=this.performanceMarks.get(i);l.count++,l.totalTime+=r,l.avgTime=l.totalTime/l.count,l.minTime=Math.min(l.minTime,r),l.maxTime=Math.max(l.maxTime,r)}getPerformanceReport(){const e={};return this.performanceMarks.forEach((t,r)=>{e[r]={calls:t.count,total:`${t.totalTime.toFixed(2)}ms`,average:`${t.avgTime.toFixed(2)}ms`,min:`${t.minTime.toFixed(2)}ms`,max:`${t.maxTime.toFixed(2)}ms`}}),e}clearPerformanceMarks(){this.performanceMarks.clear()}getFlutterConfig(){return{...this.flutterConfig}}getElementById(e){return this.elementRegistry.get(e)}getAllElements(){return Array.from(this.elementRegistry.values())}getElementCount(){return this.elementRegistry.size}isInitialized(){return this.initialized}isMounted(){return this.mounted}getStats(){const e=this.getMetrics();return e?{...e,flutter:{elements:this.elementRegistry.size,cachedWidgets:this.widgetCache?"enabled":"disabled",inputType:this.inputType,lifecycleCallbacks:Object.keys(this.lifecycleCallbacks).reduce((t,r)=>(t[r]=this.lifecycleCallbacks[r].length,t),{})}}:{flutter:{elements:this.elementRegistry.size,cachedWidgets:this.widgetCache?"enabled":"disabled",inputType:this.inputType,initialized:this.initialized,mounted:this.mounted,hasApp:this.app!==null,lifecycleCallbacks:Object.keys(this.lifecycleCallbacks).reduce((t,r)=>(t[r]=this.lifecycleCallbacks[r].length,t),{})}}}destroy(){this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u{1F5D1}\uFE0F Destroying..."),this._errorHandlers&&this.flutterConfig.isBrowser&&(window.removeEventListener("error",this._errorHandlers.errorHandler),window.removeEventListener("unhandledrejection",this._errorHandlers.rejectionHandler)),this.elementRegistry.clear(),this.widgetCache=new WeakMap,Object.keys(this.lifecycleCallbacks).forEach(e=>{this.lifecycleCallbacks[e]=[]}),this.performanceMarks.clear(),super.destroy(),this.initialized=!1,this.mounted=!1,this.flutterConfig.debugMode&&console.log("[FlutterJSRuntime] \u2705 Destroyed")}}let o=null;function y(n,e={}){try{o?e.debugMode&&console.log("[FlutterJS] \u267B\uFE0F Reusing existing runtime"):(e.debugMode&&console.log("[FlutterJS] \u{1F195} Creating new Flutter runtime"),o=new d({debugMode:e.debugMode||!1,enableHotReload:e.enableHotReload!==!1,enablePerformanceTracking:e.enablePerformanceTracking!==!1,enableStateTracking:e.enableStateTracking!==!1,enableErrorBoundaries:e.enableErrorBoundaries!==!1,strictMode:e.strictMode||!1,mode:e.mode||"csr"}));const t={...e,context:{...e.context,runtime:o}};return o.runApp(n,t)}catch(t){throw console.error("[FlutterJS] \u274C Failed to run app:",t),t}}function S(){return o}function C(n){if(!o)throw new Error("[FlutterJS] No runtime instance. Call runApp() first.");n&&typeof n=="function"&&n(),o.update()}function E(){if(!o){console.warn("[FlutterJS] No runtime instance");return}o.hotReload()}function x(n,e={}){try{e.debugMode&&console.log("[FlutterJS] \xF0\u0178\u201C\u201E SSR: Creating temporary runtime for rendering");const t=new d({debugMode:e.debugMode||!1,mode:"ssr"}),r={...e,context:{...e.context,runtime:t}},i=I(n,r);return t.destroy(),i}catch(t){throw console.error("[FlutterJS] \xE2\x9D\u0152 SSR failed:",t),t}}function M(n,e={}){try{e.debugMode&&console.log("[FlutterJS] \xF0\u0178\u2019\xA7 Starting hydration..."),o||(o=new d({debugMode:e.debugMode||!1,enableHotReload:e.enableHotReload!==!1,mode:"hydrate"}));const t={...e,context:{...e.context,runtime:o}};return N(n,t)}catch(t){throw console.error("[FlutterJS] \xE2\x9D\u0152 Hydration failed:",t),t}}function R(){return o?o.getStats():null}function w(){return o?o.getPerformanceReport():null}function k(){o&&(o.clearMetrics(),o.clearPerformanceMarks())}function F(n,e){if(!o){console.warn("[FlutterJS] No runtime instance. Call runApp() first.");return}o.on(n,e)}function J(n,e){o&&o.off(n,e)}function v(){return o?o.getFlutterConfig():null}function T(){o&&(o.destroy(),o=null)}function z(){return o!==null&&o.isInitialized()}function W(){return o!==null&&o.isMounted()}var Y={FlutterJSRuntime:d,VNodeRuntime:f,runApp:y,getRuntime:S,updateApp:C,hotReload:E,renderToString:x,hydrate:M,getMetrics:R,getPerformanceReport:w,clearMetrics:k,on:F,off:J,getConfig:v,dispose:T,isInitialized:z,isMounted:W,isBrowser:m,isSSR:p};typeof window<"u"&&(console.log("[FlutterJS] \xF0\u0178\u0152\x90 Setting up window.FlutterJS"),window.FlutterJS={runApp:y,getRuntime:S,updateApp:C,hotReload:E,renderToString:x,hydrate:M,getMetrics:R,getPerformanceReport:w,clearMetrics:k,on:F,off:J,getConfig:v,dispose:T,isInitialized:z,isMounted:W,version:"1.0.0",environment:"browser"},console.log("[FlutterJS] \xE2\u0153\u2026 window.FlutterJS ready"),console.log("[FlutterJS] \xF0\u0178\u201C\u0161 Available methods:",Object.keys(window.FlutterJS).join(", ")));export{d as FlutterJSRuntime,k as clearMetrics,Y as default,T as dispose,v as getConfig,R as getMetrics,w as getPerformanceReport,S as getRuntime,E as hotReload,M as hydrate,z as isInitialized,W as isMounted,J as off,F as on,x as renderToString,y as runApp,C as updateApp};
//# sourceMappingURL=flutterjs_runtime.js.map
