import{VNodeRenderer as d}from"@flutterjs/vdom/vnode_renderer";import{Hydrator as u}from"@flutterjs/vdom/hydrator";import{VNodeBuilder as a}from"@flutterjs/vdom/vnode_builder";import{StatelessElement as m,StatefulElement as g,ComponentElement as p}from"@flutterjs/runtime/element";import{InheritedElement as R}from"@flutterjs/runtime/inherited_element";function l(){return typeof window<"u"&&typeof document<"u"}function h(){return typeof window>"u"}class c{constructor(e={}){this.config={debugMode:e.debugMode||!1,enableHotReload:e.enableHotReload!==!1,enableStateTracking:e.enableStateTracking!==!1,enablePerformanceTracking:e.enablePerformanceTracking!==!1,mode:e.mode||"csr",target:e.target||"web",isBrowser:l(),isSSR:h(),...e},this.initialized=!1,this.mounted=!1,this.rootElement=null,this.rootWidget=null,this.rootVNode=null,this.currentDOMElement=null,this.appBuilder=null,this.vNodeBuilder=null,this.vNodeRenderer=null,this.hydrator=null,this.stats={initTime:0,mountTime:0,renderTime:0,updateCount:0,totalUpdateTime:0,averageUpdateTime:0,lastUpdateTime:0},this.hooks={beforeInit:[],afterInit:[],beforeMount:[],afterMount:[],beforeUpdate:[],afterUpdate:[],beforeUnmount:[],afterUnmount:[]},this.errorHandlers=[],this.setupErrorHandling(),this.config.debugMode&&console.log("[Runtime] \u2705 Instance created",{environment:this.config.isBrowser?"browser":"server",mode:this.config.mode})}createElement(e,t=null){if(!e)throw new Error("[Runtime.createElement] Widget is required");if(this.config.debugMode&&console.log("[Runtime.createElement] Creating element for:",e.constructor.name),this.isStatelessWidget(e))return this.config.debugMode&&console.log("[Runtime.createElement] \u2192 StatelessElement"),new m(e,t,this);if(this.isStatefulWidget(e))return this.config.debugMode&&console.log("[Runtime.createElement] \u2192 StatefulElement"),new g(e,t,this);if(this.isInheritedWidget(e))return this.config.debugMode&&console.log("[Runtime.createElement] \u2192 InheritedElement"),new R(e,t,this);if(this.isComponentWidget(e))return this.config.debugMode&&console.log("[Runtime.createElement] \u2192 ComponentElement"),new p(e,t,this);if(typeof e.createElement=="function")return this.config.debugMode&&console.log("[Runtime.createElement] \u2192 Custom createElement"),e.createElement(t,this);throw new Error(`[Runtime.createElement] Unknown widget type: ${e.constructor.name}`)}isStatelessWidget(e){return e?e.constructor.name==="StatelessWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="StatelessWidget"||typeof e.build=="function"&&!e.createState&&!e.child&&!e.updateShouldNotify:!1}isStatefulWidget(e){return e?e.constructor.name==="StatefulWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="StatefulWidget"||typeof e.createState=="function":!1}isInheritedWidget(e){return e?e.constructor.name==="InheritedWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="InheritedWidget"||e.child!==void 0&&typeof e.updateShouldNotify=="function":!1}isComponentWidget(e){return e?typeof e.render=="function"||typeof e.build=="function"&&typeof e.createState!="function"&&!e.updateShouldNotify:!1}initialize(e={}){if(this.initialized)return console.warn("[Runtime] Already initialized"),this;const t=performance.now();try{if(this.runHooks("beforeInit"),this.config.debugMode&&console.log("[Runtime] Initializing..."),this.rootElement=e.rootElement,this.config.isBrowser&&!this.rootElement)throw new Error("[Runtime] rootElement required in browser mode");return this.config.debugMode&&console.log("[Runtime] \u{1F7E2} Creating VNodeBuilder..."),this.vNodeBuilder=new a({debugMode:this.config.debugMode,runtime:this}),this.config.isBrowser&&(this.config.debugMode&&console.log("[Runtime] \u{1F7E2} Creating VNodeRenderer..."),this.vNodeRenderer=new d({rootElement:this.rootElement,debugMode:this.config.debugMode,runtime:this})),(this.config.mode==="hydrate"||e.hydrateFromSSR)&&(this.config.debugMode&&console.log("[Runtime] \u{1F9CA} Creating Hydrator..."),this.hydrator=new u({rootElement:this.rootElement,debugMode:this.config.debugMode,runtime:this})),this.initialized=!0,this.stats.initTime=performance.now()-t,this.runHooks("afterInit"),this.config.debugMode&&(console.log("[Runtime] \u2705 Initialized in",this.stats.initTime.toFixed(2),"ms"),console.log("[Runtime] \u{1F4CA} Components ready:",{vNodeBuilder:!!this.vNodeBuilder,vNodeRenderer:!!this.vNodeRenderer,hydrator:!!this.hydrator})),this}catch(o){throw this.handleError("initialization",o),o}}runApp(e,t={}){if(!this.initialized)throw new Error("[Runtime] Must call initialize() first");const o=performance.now();try{this.runHooks("beforeMount"),this.config.debugMode&&console.log("[Runtime] Mounting application...");const n=e&&e.tag!==void 0,s=e&&typeof e.build=="function";if(n)this.rootVNode=e,this.config.debugMode&&console.log("[Runtime] \u{1F4E6} Using VNode from AppBuilder");else if(s)this.config.debugMode&&console.log("[Runtime] \u{1F5DD}\uFE0F  Building VNode from Widget class..."),this.vNodeBuilder||(this.vNodeBuilder=new a({debugMode:this.config.debugMode,runtime:this})),this.rootVNode=this.vNodeBuilder.build(e,{context:t.buildContext||{}}),this.config.debugMode&&console.log("[Runtime] \u2705 VNode built successfully");else throw new Error("[Runtime] Invalid input: expected VNode or Widget");return t.appBuilder&&(this.appBuilder=t.appBuilder),this.config.isBrowser&&this.rootElement?this.renderToDOM():this.config.isSSR&&this.renderToString(),this.mounted=!0,this.stats.mountTime=performance.now()-o,this.runHooks("afterMount"),this.config.debugMode&&(console.log("[Runtime] \u2705 Mounted in",this.stats.mountTime.toFixed(2),"ms"),this.logStats()),this}catch(n){throw this.handleError("mount",n),n}}renderToDOM(){if(!this.config.isBrowser)throw new Error("[Runtime] Cannot render to DOM in SSR mode");if(!this.rootElement)throw new Error("[Runtime] No root element");if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=performance.now();this.config.debugMode&&console.log("[Runtime] \u{1F3A8} Rendering VNode to DOM..."),this.vNodeRenderer||(this.vNodeRenderer=new d({rootElement:this.rootElement,debugMode:this.config.debugMode})),this.currentDOMElement=this.vNodeRenderer.render(this.rootVNode,this.rootElement,{clear:!0}),this.stats.renderTime=performance.now()-e,this.config.debugMode&&(console.log("[Runtime] \u2705 Rendered to DOM in",this.stats.renderTime.toFixed(2),"ms"),console.log("[Runtime] \u{1F333} DOM Element:",this.currentDOMElement.tagName||"Fragment"))}catch(e){throw console.error("[Runtime] \u274C DOM rendering failed:",e),e}}renderToString(){if(!this.config.isSSR)return console.warn("[Runtime] renderToString called in browser mode"),"";if(!this.rootVNode)throw new Error("[Runtime] No VNode tree to render");try{const e=performance.now();this.config.debugMode&&console.log("[Runtime] \u{1F4DD} Rendering VNode to HTML string (SSR)..."),this.vNodeRenderer||(this.vNodeRenderer=new d({debugMode:this.config.debugMode}));const t=this.vNodeRenderer.renderToString(this.rootVNode);return this.stats.renderTime=performance.now()-e,this.config.debugMode&&console.log("[Runtime] \u2705 Generated SSR HTML:",t.length,"bytes in",this.stats.renderTime.toFixed(2),"ms"),t}catch(e){throw console.error("[Runtime] \u274C SSR rendering failed:",e),e}}update(e={}){if(!this.mounted)return console.warn("[Runtime] \u274C Cannot update: app not mounted"),this;const t=performance.now();try{if(this.runHooks("beforeUpdate"),this.config.debugMode&&console.log("[Runtime] \u{1F4C4} Updating application..."),this.appBuilder&&e.rebuild!==!1){this.config.debugMode&&console.log("[Runtime] \u{1F5DD}\uFE0F  Rebuilding widget tree with AppBuilder...");const n=this.appBuilder.build();this.config.isBrowser&&this.vNodeRenderer&&this.currentDOMElement&&(this.config.debugMode&&console.log("[Runtime] \u{1F4CD} Running VNode reconciliation..."),this.currentDOMElement=this.vNodeRenderer.reconcile(this.currentDOMElement,this.rootVNode,n),this.rootVNode=n)}else this.config.isBrowser&&this.rootVNode&&e.forceRender&&(this.config.debugMode&&console.log("[Runtime] \u{1F4A5} Force rendering..."),this.currentDOMElement&&this.vNodeRenderer.cleanup(this.currentDOMElement),this.renderToDOM());const o=performance.now()-t;return this.stats.updateCount++,this.stats.totalUpdateTime+=o,this.stats.averageUpdateTime=this.stats.totalUpdateTime/this.stats.updateCount,this.stats.lastUpdateTime=o,this.runHooks("afterUpdate"),this.config.debugMode&&console.log("[Runtime] \u2705 Updated in",o.toFixed(2),"ms"),this}catch(o){throw this.handleError("update",o),o}}hotReload(e){if(!this.config.enableHotReload)return console.warn("[Runtime] Hot reload disabled"),this;if(!this.config.isBrowser)return console.warn("[Runtime] Hot reload not supported in SSR mode"),this;try{return this.config.debugMode&&console.log("[Runtime] \u{1F525} Hot reloading..."),this.vNodeRenderer&&this.currentDOMElement&&(this.currentDOMElement=this.vNodeRenderer.reconcile(this.currentDOMElement,this.rootVNode,e)),this.rootVNode=e,this.config.debugMode&&console.log("[Runtime] \u2705 Hot reload complete"),this}catch(t){throw this.handleError("hotReload",t),t}}hydrate(e,t={}){if(!this.config.isBrowser)return console.warn("[Runtime] Cannot hydrate in SSR mode"),this;try{return this.config.debugMode&&console.log("[Runtime] \u{1F4A7} Hydrating SSR content..."),this.hydrator||(this.hydrator=new u({rootElement:this.rootElement,debugMode:this.config.debugMode})),this.hydrator.hydrate(this.rootElement,this.rootVNode,e||{}),this.mounted=!0,this.config.debugMode&&console.log("[Runtime] \u2705 Hydration complete"),this}catch(o){throw this.handleError("hydrate",o),o}}unmount(){if(!this.mounted)return console.warn("[Runtime] \u274C Not mounted"),this;try{return this.runHooks("beforeUnmount"),this.config.debugMode&&console.log("[Runtime] \u{1F5D1}\uFE0F  Unmounting..."),this.vNodeRenderer&&this.currentDOMElement&&this.vNodeRenderer.cleanup(this.currentDOMElement),this.rootElement&&(this.rootElement.innerHTML=""),this.currentDOMElement=null,this.rootVNode=null,this.appBuilder=null,this.mounted=!1,this.runHooks("afterUnmount"),this.config.debugMode&&console.log("[Runtime] \u2705 Unmounted"),this}catch(e){throw this.handleError("unmount",e),e}}dispose(){this.mounted&&this.unmount();for(const e in this.hooks)this.hooks[e]=[];this.errorHandlers=[],this.vNodeBuilder=null,this.vNodeRenderer=null,this.hydrator=null,this.initialized=!1,this.config.debugMode&&console.log("[Runtime] \u2705 Disposed")}setupErrorHandling(){if(!this.config.isBrowser)return;let e=!1;window.addEventListener("error",t=>{if(!e){e=!0;try{this.handleError("uncaught",t.error)}finally{e=!1}}}),window.addEventListener("unhandledrejection",t=>{if(!e){e=!0;try{this.handleError("promise",t.reason)}finally{e=!1}}})}handleError(e,t){const o=t instanceof Error?t.message:String(t);if(console.error(`[Runtime] \u274C Error in ${e}:`,o),t instanceof Error&&t.stack&&this.config.debugMode&&console.error("[Runtime] Stack trace:",t.stack),this.errorHandlers.forEach(n=>{try{n(e,t)}catch(s){console.error("[Runtime] Error handler failed:",s.message)}}),this.config.debugMode&&this.config.isBrowser)try{this.showErrorOverlay(e,o)}catch(n){console.error("[Runtime] Could not show error overlay:",n.message)}}showErrorOverlay(e,t){try{if(typeof document>"u")return;const o=document.getElementById("__flutterjs_error_overlay__");o&&o.remove();const n=document.createElement("div");n.id="__flutterjs_error_overlay__",n.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      font-family: monospace;
    `;const s=document.createElement("div");s.style.cssText=`
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border-left: 4px solid #d32f2f;
    `;const f=t?String(t).split(`
`)[0]:"Unknown error";s.innerHTML=`
      <h2 style="margin: 0 0 15px 0; color: #d32f2f; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;">
        \u274C ${e.charAt(0).toUpperCase()+e.slice(1)} Error
      </h2>
      <div style="
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        margin: 0;
        color: #c62828;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.6;
        word-break: break-word;
        white-space: pre-wrap;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      ">${S(f)}</div>
      <p style="color: #666; margin-top: 20px; font-size: 12px; margin-bottom: 0;">
        \u{1F4A1} Check the browser console for more details.
      </p>
    `,n.appendChild(s),document.body.appendChild(n)}catch(o){console.error("[Runtime] Overlay creation failed:",o.message)}}on(e,t){return this.hooks[e]&&typeof t=="function"&&this.hooks[e].push(t),this}runHooks(e){(this.hooks[e]||[]).forEach(o=>{try{o(this)}catch(n){console.error(`[Runtime] Hook ${e} failed:`,n)}})}onError(e){return typeof e=="function"&&this.errorHandlers.push(e),this}getStats(){return{...this.stats,initialized:this.initialized,mounted:this.mounted,environment:this.config.isBrowser?"browser":"server",vnodeSize:0}}logStats(){if(!this.config.debugMode)return;const e=this.getStats();console.group("[Runtime] \u{1F4CA} Statistics"),console.log("Environment:",e.environment),console.log("Mount Time:",`${e.mountTime.toFixed(2)}ms`),console.log("Render Time:",`${e.renderTime.toFixed(2)}ms`),console.log("Updates:",e.updateCount),console.log("Avg Update Time:",`${e.averageUpdateTime.toFixed(2)}ms`),console.log("VNode Size:",`${e.vnodeSize} bytes`),console.groupEnd()}getConfig(){return{...this.config}}isInitialized(){return this.initialized}isMounted(){return this.mounted}}let r=null;function b(i,e={}){r||(r=new c({debugMode:e.debugMode||!1,enableHotReload:!0,enablePerformanceTracking:!0,mode:e.mode||"csr"}));const t=e.container||e.rootElement||(l()?document.getElementById("root"):null);return r.initialize({rootElement:t}),r.runApp(i,e),r}function E(){return r}function M(i){if(!r)throw new Error("No runtime instance");i&&typeof i=="function"&&i(),r.update({rebuild:!0,forceRender:!1})}function y(i){if(!r){console.warn("No runtime instance");return}r.hotReload(i)}function w(){r&&(r.dispose(),r=null)}function S(i){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return i.replace(/[&<>"']/g,t=>e[t])}var H={FlutterJSRuntime:c,runApp:b,getRuntime:E,updateApp:M,hotReload:y,dispose:w,isBrowser:l,isSSR:h};export{c as FlutterJSRuntime,H as default,w as dispose,E as getRuntime,y as hotReload,b as runApp,M as updateApp};
//# sourceMappingURL=flutterjs_runtime.js.map
