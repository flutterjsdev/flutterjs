class l{constructor(e){this.runtime=e,this.focusedElement=null,this.focusableElements=new Map,this.focusScopes=new Map,this.activeScopeId=null,this.focusChangeListeners=new Set,this.keyboardEnabled=!1,this.keyboardHandler=null}registerFocusable(e,s,t={}){if(!e||!s){console.warn("[FocusManager] Invalid registration:",{elementId:e,domElement:s});return}const o={elementId:e,element:s,canRequestFocus:t.canRequestFocus!==!1,skipTraversal:t.skipTraversal===!0,autofocus:t.autofocus===!0,onFocusChange:t.onFocusChange||null,tabIndex:t.tabIndex??0,scopeId:t.scopeId||null};this.focusableElements.set(e,o),o.skipTraversal||(s.tabIndex=o.tabIndex),this._attachDOMListeners(s,e),o.autofocus&&requestAnimationFrame(()=>{this.focusableElements.has(e)&&this.requestFocus(e)})}unregisterFocusable(e){const s=this.focusableElements.get(e);if(s){this.focusedElement===e&&(this.focusedElement=null,this._notifyFocusChange(null,e));for(const[t,o]of this.focusScopes.entries()){const n=o.indexOf(e);n!==-1&&o.splice(n,1)}this._detachDOMListeners(s.element,e),this.focusableElements.delete(e)}}requestFocus(e,s={}){const t=this.focusableElements.get(e);if(!t)return console.warn("[FocusManager] Cannot focus unknown element:",e),!1;if(!t.canRequestFocus)return console.warn("[FocusManager] Element cannot receive focus:",e),!1;if(this.activeScopeId&&t.scopeId!==this.activeScopeId)return console.warn("[FocusManager] Focus request blocked by active scope"),!1;const o=this.focusedElement;o&&o!==e&&this._blurElement(o);try{return t.element.focus(s),this.focusedElement=e,this._notifyFocusChange(e,o),t.onFocusChange&&t.onFocusChange(!0),!0}catch(n){return console.error("[FocusManager] Focus failed:",n),!1}}unfocus(e){this.focusedElement===e&&(this._blurElement(e),this.focusedElement=null,this._notifyFocusChange(null,e))}_blurElement(e){const s=this.focusableElements.get(e);if(s)try{s.element.blur(),s.onFocusChange&&s.onFocusChange(!1)}catch(t){console.error("[FocusManager] Blur failed:",t)}}moveFocus(e="forward"){const s=this._getFocusableInScope();if(s.length===0){console.warn("[FocusManager] No focusable elements available");return}s.sort((c,u)=>{const i=this.focusableElements.get(c),a=this.focusableElements.get(u);if(i.tabIndex!==a.tabIndex)return i.tabIndex-a.tabIndex;const r=i.element.compareDocumentPosition(a.element);return r&Node.DOCUMENT_POSITION_FOLLOWING?-1:r&Node.DOCUMENT_POSITION_PRECEDING?1:0});const t=this.focusedElement?s.indexOf(this.focusedElement):-1;let o;e==="forward"?o=(t+1)%s.length:o=(t-1+s.length)%s.length;const n=s[o];this.requestFocus(n)}_getFocusableInScope(){const e=Array.from(this.focusableElements.entries()).filter(([t,o])=>!o.skipTraversal).map(([t])=>t);if(!this.activeScopeId)return e;const s=this.focusScopes.get(this.activeScopeId)||[];return e.filter(t=>s.includes(t))}createScope(e,s=[]){this.focusScopes.set(e,s)}addToScope(e,s){this.focusScopes.has(e)||this.createScope(e);const t=this.focusScopes.get(e);t.includes(s)||t.push(s);const o=this.focusableElements.get(s);o&&(o.scopeId=e)}pushScope(e){if(!this.focusScopes.has(e)){console.warn("[FocusManager] Cannot activate unknown scope:",e);return}this.activeScopeId=e;const s=this.focusedElement?this.focusableElements.get(this.focusedElement):null;s&&s.scopeId!==e&&this.unfocus(this.focusedElement)}popScope(){this.activeScopeId=null}removeScope(e){(this.focusScopes.get(e)||[]).forEach(t=>{const o=this.focusableElements.get(t);o&&o.scopeId===e&&(o.scopeId=null)}),this.focusScopes.delete(e),this.activeScopeId===e&&(this.activeScopeId=null)}setupKeyboardNavigation(){this.keyboardEnabled||(this.keyboardHandler=e=>{if(e.key==="Tab"){e.preventDefault();const s=e.shiftKey?"backward":"forward";this.moveFocus(s)}e.key==="Escape"&&this.activeScopeId&&this.popScope()},document.addEventListener("keydown",this.keyboardHandler),this.keyboardEnabled=!0)}disableKeyboardNavigation(){this.keyboardEnabled&&(this.keyboardHandler&&(document.removeEventListener("keydown",this.keyboardHandler),this.keyboardHandler=null),this.keyboardEnabled=!1)}_attachDOMListeners(e,s){const t=()=>{if(this.focusedElement!==s){const n=this.focusedElement;this.focusedElement=s,this._notifyFocusChange(s,n);const c=this.focusableElements.get(s);c&&c.onFocusChange&&c.onFocusChange(!0)}},o=()=>{if(this.focusedElement===s){this.focusedElement=null,this._notifyFocusChange(null,s);const n=this.focusableElements.get(s);n&&n.onFocusChange&&n.onFocusChange(!1)}};e.addEventListener("focus",t),e.addEventListener("blur",o),e._focusHandlers={focusHandler:t,blurHandler:o}}_detachDOMListeners(e,s){if(!e._focusHandlers)return;const{focusHandler:t,blurHandler:o}=e._focusHandlers;e.removeEventListener("focus",t),e.removeEventListener("blur",o),delete e._focusHandlers}addFocusChangeListener(e){this.focusChangeListeners.add(e)}removeFocusChangeListener(e){this.focusChangeListeners.delete(e)}_notifyFocusChange(e,s){this.focusChangeListeners.forEach(t=>{try{t(e,s)}catch(o){console.error("[FocusManager] Listener error:",o)}})}get currentFocus(){return this.focusedElement}hasFocus(e){return this.focusedElement===e}getFocusableElements(){return Array.from(this.focusableElements.keys())}getElementInfo(e){return this.focusableElements.get(e)||null}clearFocus(){this.focusedElement&&(this._blurElement(this.focusedElement),this.focusedElement=null)}getStats(){return{totalFocusable:this.focusableElements.size,currentFocus:this.focusedElement,activeScope:this.activeScopeId,scopeCount:this.focusScopes.size,keyboardEnabled:this.keyboardEnabled,listeners:this.focusChangeListeners.size}}dispose(){this.disableKeyboardNavigation();for(const[e,s]of this.focusableElements.entries())this._detachDOMListeners(s.element,e);this.focusableElements.clear(),this.focusScopes.clear(),this.focusChangeListeners.clear(),this.focusedElement=null,this.activeScopeId=null}}export{l as FocusManager};
//# sourceMappingURL=focus_manager.js.map
