class c{constructor(e={}){this.config={enableTracking:e.enableTracking!==!1,enableWeakRefs:e.enableWeakRefs!==!1,maxDependenciesPerProperty:e.maxDependenciesPerProperty||1e3,enableDebugLogging:e.enableDebugLogging||!1,warnOnThreshold:e.warnOnThreshold!==!1,dependencyThreshold:e.dependencyThreshold||500},this.dependencies=new Map,this.elementDependencies=new Map,this.weakElementRefs=new WeakMap,this.tracking=!1,this.currentElement=null,this.trackingStack=[],this.stats={dependenciesTracked:0,dependenciesCleared:0,rebuildsTriggered:0,selectiveRebuilds:0,fullRebuilds:0,trackingSessionsStarted:0,trackingSessionsEnded:0,peakDependencies:0},this.debugLog=[],this.maxDebugLogSize=1e3}startTracking(e){if(this.config.enableTracking){if(!e)throw new Error("Element is required for tracking");this.tracking&&this.currentElement&&this.trackingStack.push({element:this.currentElement,tracking:this.tracking}),this.tracking=!0,this.currentElement=e,this.stats.trackingSessionsStarted++,this.log(`Started tracking for element ${e.id}`)}}stopTracking(){if(this.config.enableTracking){if(this.currentElement&&this.log(`Stopped tracking for element ${this.currentElement.id}`),this.trackingStack.length>0){const e=this.trackingStack.pop();this.currentElement=e.element,this.tracking=e.tracking}else this.tracking=!1,this.currentElement=null;this.stats.trackingSessionsEnded++}}recordDependency(e,n){if(!this.config.enableTracking||!this.tracking||!this.currentElement)return;if(!e||!n){this.config.enableDebugLogging&&console.warn("[StateTracker] Invalid dependency recording attempt");return}const s=this.getStateId(e),t=`${s}.${n}`;this.dependencies.has(t)||this.dependencies.set(t,new Set);const i=this.dependencies.get(t);if(i.size>=this.config.maxDependenciesPerProperty){console.warn(`[StateTracker] Max dependencies reached for ${t} (${i.size}/${this.config.maxDependenciesPerProperty})`);return}i.add(this.currentElement);const r=this.currentElement.id;this.elementDependencies.has(r)||this.elementDependencies.set(r,new Set),this.elementDependencies.get(r).add(t),this.config.enableWeakRefs&&this.weakElementRefs.set(this.currentElement,{id:r,stateId:s,property:n,trackedAt:Date.now()}),this.stats.dependenciesTracked++;const d=this.getTotalDependencies();d>this.stats.peakDependencies&&(this.stats.peakDependencies=d),this.config.warnOnThreshold&&d>this.config.dependencyThreshold&&console.warn(`[StateTracker] Dependency count (${d}) exceeds threshold (${this.config.dependencyThreshold})`),this.log(`Recorded dependency: ${this.currentElement.id} \u2192 ${t}`)}getDependents(e,n){if(!e||!n)return new Set;const t=`${this.getStateId(e)}.${n}`,i=this.dependencies.get(t);if(!i)return new Set;const r=new Set;return i.forEach(d=>{d&&d.mounted&&r.add(d)}),r}getElementDependencies(e){return e?this.elementDependencies.get(e.id)||new Set:new Set}notifyPropertyChange(e,n){const s=this.getDependents(e,n);return s.size===0?0:(s.forEach(t=>{t.mounted&&!t.dirty&&(t.markNeedsBuild(),this.stats.selectiveRebuilds++)}),this.stats.rebuildsTriggered++,this.log(`Notified ${s.size} dependents of ${this.getStateId(e)}.${n} change`),s.size)}notifyMultipleChanges(e,n){if(!n||n.length===0)return 0;const s=new Set;return n.forEach(t=>{this.getDependents(e,t).forEach(r=>s.add(r))}),s.forEach(t=>{t.mounted&&!t.dirty&&(t.markNeedsBuild(),this.stats.selectiveRebuilds++)}),this.stats.rebuildsTriggered++,s.size}clearDependencies(e){if(!e)return;const n=e.id,s=this.elementDependencies.get(n);if(!s)return;let t=0;s.forEach(i=>{const r=this.dependencies.get(i);r&&r.has(e)&&(r.delete(e),t++,r.size===0&&this.dependencies.delete(i))}),this.elementDependencies.delete(n),this.weakElementRefs.delete(e),this.stats.dependenciesCleared+=t,this.log(`Cleared ${t} dependencies for element ${n}`)}clearPropertyDependencies(e,n){const t=`${this.getStateId(e)}.${n}`,i=this.dependencies.get(t);if(!i)return;const r=i.size;i.forEach(d=>{const a=this.elementDependencies.get(d.id);a&&a.delete(t)}),this.dependencies.delete(t),this.stats.dependenciesCleared+=r}clearStateDependencies(e){const n=this.getStateId(e),s=[];this.dependencies.forEach((t,i)=>{i.startsWith(`${n}.`)&&(s.push(i),t.forEach(r=>{const d=this.elementDependencies.get(r.id);d&&d.delete(i)}))}),s.forEach(t=>{this.dependencies.delete(t)}),this.log(`Cleared all dependencies for state ${n}`)}clear(){this.dependencies.clear(),this.elementDependencies.clear(),this.tracking=!1,this.currentElement=null,this.trackingStack=[],this.log("Cleared all dependencies")}getStateId(e){return e?(e._stateId||(e._stateId=`state_${++c._stateIdCounter}`),e._stateId):"unknown"}getTotalDependencies(){let e=0;return this.dependencies.forEach(n=>{e+=n.size}),e}getDependencyTree(){const e={};return this.dependencies.forEach((n,s)=>{e[s]=Array.from(n).map(t=>({id:t.id,type:t.constructor.name,mounted:t.mounted}))}),e}getElementDependencyMap(){const e={};return this.elementDependencies.forEach((n,s)=>{e[s]=Array.from(n)}),e}isTracking(){return this.tracking&&this.currentElement!==null}getCurrentElement(){return this.currentElement}getStats(){return{...this.stats,totalDependencies:this.getTotalDependencies(),uniqueDependencyKeys:this.dependencies.size,trackedElements:this.elementDependencies.size,isTracking:this.tracking,trackingStackDepth:this.trackingStack.length}}getDetailedReport(){return{stats:this.getStats(),dependencyTree:this.getDependencyTree(),elementDependencies:this.getElementDependencyMap(),config:this.config,timestamp:Date.now()}}resetStats(){this.stats={dependenciesTracked:0,dependenciesCleared:0,rebuildsTriggered:0,selectiveRebuilds:0,fullRebuilds:0,trackingSessionsStarted:0,trackingSessionsEnded:0,peakDependencies:0}}setTrackingEnabled(e){this.config.enableTracking=e,e||this.stopTracking()}log(e){if(!this.config.enableDebugLogging)return;const n={timestamp:Date.now(),message:e};this.debugLog.push(n),this.debugLog.length>this.maxDebugLogSize&&this.debugLog.shift(),console.log(`[StateTracker] ${e}`)}getDebugLog(){return[...this.debugLog]}clearDebugLog(){this.debugLog=[]}}c._stateIdCounter=0;export{c as StateTracker};
//# sourceMappingURL=state_tracker.js.map
