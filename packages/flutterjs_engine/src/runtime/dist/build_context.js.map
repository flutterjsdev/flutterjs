{
  "version": 3,
  "sources": ["../src/build_context.js"],
  "sourcesContent": ["/**\r\n * FlutterJS BuildContext\r\n * \r\n * BuildContext is the bridge between widgets and the framework.\r\n * It provides access to:\r\n * - Ancestor widgets and state\r\n * - Framework services (Theme, Navigator, MediaQuery)\r\n * - Inherited values (InheritedWidget data)\r\n * - Element and state references\r\n * \r\n * Key methods:\r\n * - findAncestorWidgetOfExactType(Type)\r\n * - findAncestorStateOfType(Type)\r\n * - dependOnInheritedWidgetOfExactType(Type)\r\n * - getService(name)\r\n * \r\n * Usage:\r\n * class MyWidget extends StatelessWidget {\r\n *   build(context) {\r\n *     final theme = Theme.of(context);\r\n *     final mediaQuery = MediaQuery.of(context);\r\n *     return Container(...);\r\n *   }\r\n * }\r\n */\r\n\r\nclass BuildContext {\r\n  /**\r\n   * Create a new BuildContext\r\n   * @param {Element} element - Element that owns this context\r\n   * @param {RuntimeEngine} runtime - Runtime engine reference\r\n   * @param {State} state - State object (optional, for StatefulWidget)\r\n   */\r\n  constructor(element, runtime, state = null) {\r\n    if (!element) {\r\n      throw new Error('Element is required for BuildContext');\r\n    }\r\n    \r\n    if (!runtime) {\r\n      throw new Error('Runtime is required for BuildContext');\r\n    }\r\n    \r\n    // Core references\r\n    this._element = element;\r\n    this._runtime = runtime;\r\n    this._state = state;\r\n    \r\n    // Cache for inherited widgets\r\n    this._inheritedCache = new Map();\r\n    \r\n    // Tracking\r\n    this._visited = new Set();      // For cycle detection\r\n    this._dependencies = new Set(); // For memory tracking\r\n  }\r\n  \r\n  /**\r\n   * Get the current widget\r\n   * @returns {Widget}\r\n   */\r\n  get widget() {\r\n    return this._element ? this._element.widget : null;\r\n  }\r\n  \r\n  /**\r\n   * Get the current state (StatefulWidget only)\r\n   * @returns {State|null}\r\n   */\r\n  get state() {\r\n    return this._state;\r\n  }\r\n  \r\n  /**\r\n   * Get the owning element\r\n   * @returns {Element}\r\n   */\r\n  get element() {\r\n    return this._element;\r\n  }\r\n  \r\n  /**\r\n   * Check if mounted\r\n   * @returns {boolean}\r\n   */\r\n  get mounted() {\r\n    return this._element ? this._element.mounted : false;\r\n  }\r\n  \r\n  /**\r\n   * Find ancestor widget of exact type\r\n   * Searches up the element tree for widget of specific type\r\n   * \r\n   * @param {Function} Type - Widget class to find\r\n   * @returns {Widget|null} - Found widget or null\r\n   * \r\n   * @example\r\n   * const appBar = context.findAncestorWidgetOfExactType(AppBar);\r\n   */\r\n  findAncestorWidgetOfExactType(Type) {\r\n    if (!Type) {\r\n      throw new Error('Widget type is required');\r\n    }\r\n    \r\n    let current = this._element.parent;\r\n    \r\n    while (current) {\r\n      const widget = current.widget;\r\n      \r\n      // Check exact type match\r\n      if (widget && widget.constructor === Type) {\r\n        return widget;\r\n      }\r\n      \r\n      current = current.parent;\r\n    }\r\n    \r\n    return null;\r\n  }\r\n  \r\n  /**\r\n   * Find ancestor widget of exact type (deprecated name variant)\r\n   * Alias for findAncestorWidgetOfExactType\r\n   */\r\n  findAncestorWidgetOfType(Type) {\r\n    return this.findAncestorWidgetOfExactType(Type);\r\n  }\r\n  \r\n  /**\r\n   * Find ancestor state of exact type\r\n   * Searches up the element tree for StatefulElement with state of specific type\r\n   * \r\n   * @param {Function} Type - State class to find\r\n   * @returns {State|null} - Found state or null\r\n   * \r\n   * @example\r\n   * const counterState = context.findAncestorStateOfType(CounterState);\r\n   */\r\n  findAncestorStateOfType(Type) {\r\n    if (!Type) {\r\n      throw new Error('State type is required');\r\n    }\r\n    \r\n    let current = this._element.parent;\r\n    \r\n    while (current) {\r\n      // Check if element has state\r\n      if (current.state) {\r\n        // Check exact type match\r\n        if (current.state.constructor === Type) {\r\n          return current.state;\r\n        }\r\n      }\r\n      \r\n      current = current.parent;\r\n    }\r\n    \r\n    return null;\r\n  }\r\n  \r\n  /**\r\n   * Find ancestor render object (DOM node)\r\n   * Gets the DOM reference for ancestor element\r\n   * \r\n   * @returns {HTMLElement|null} - DOM node or null\r\n   */\r\n  findRenderObject() {\r\n    let current = this._element.parent;\r\n    \r\n    while (current) {\r\n      if (current.domNode) {\r\n        return current.domNode;\r\n      }\r\n      current = current.parent;\r\n    }\r\n    \r\n    return null;\r\n  }\r\n  \r\n  /**\r\n   * Depend on InheritedWidget of exact type\r\n   * Finds and registers dependency on InheritedWidget\r\n   * This element will rebuild when InheritedWidget updates\r\n   * \r\n   * @param {Function} Type - InheritedWidget class to find\r\n   * @returns {InheritedWidget|null} - Found widget or null\r\n   * \r\n   * @example\r\n   * const theme = context.dependOnInheritedWidgetOfExactType(Theme);\r\n   * if (theme) {\r\n   *   return Container({ color: theme.data.primaryColor });\r\n   * }\r\n   */\r\n  dependOnInheritedWidgetOfExactType(Type) {\r\n    if (!Type) {\r\n      throw new Error('InheritedWidget type is required');\r\n    }\r\n    \r\n    // Check cache first\r\n    const cached = this._inheritedCache.get(Type);\r\n    if (cached !== undefined) {\r\n      return cached;\r\n    }\r\n    \r\n    let current = this._element.parent;\r\n    \r\n    while (current) {\r\n      // Check if this element is InheritedElement\r\n      if (this._isInheritedElement(current)) {\r\n        const widget = current.widget;\r\n        \r\n        if (widget && widget.constructor === Type) {\r\n          // Register dependency\r\n          if (current.addDependent) {\r\n            current.addDependent(this._element);\r\n          }\r\n          \r\n          // Cache result\r\n          this._inheritedCache.set(Type, widget);\r\n          this._dependencies.add(current);\r\n          \r\n          return widget;\r\n        }\r\n      }\r\n      \r\n      current = current.parent;\r\n    }\r\n    \r\n    // Cache null result too\r\n    this._inheritedCache.set(Type, null);\r\n    \r\n    return null;\r\n  }\r\n  \r\n  /**\r\n   * Convenience: Get Theme\r\n   * Shorthand for Theme.of(context)\r\n   * \r\n   * @returns {ThemeData|null}\r\n   * \r\n   * @example\r\n   * const theme = context.theme();\r\n   * if (theme) {\r\n   *   console.log(theme.primaryColor);\r\n   * }\r\n   */\r\n  theme() {\r\n    const themeWidget = this.dependOnInheritedWidgetOfExactType(\r\n      this._getThemeClass()\r\n    );\r\n    return themeWidget ? themeWidget.data : null;\r\n  }\r\n  \r\n  /**\r\n   * Convenience: Get MediaQuery\r\n   * Shorthand for MediaQuery.of(context)\r\n   * \r\n   * @returns {MediaQueryData|null}\r\n   * \r\n   * @example\r\n   * const mq = context.mediaQuery();\r\n   * if (mq) {\r\n   *   console.log(mq.size.width);\r\n   * }\r\n   */\r\n  mediaQuery() {\r\n    const mq = this.dependOnInheritedWidgetOfExactType(\r\n      this._getMediaQueryClass()\r\n    );\r\n    return mq ? mq.data : null;\r\n  }\r\n  \r\n  /**\r\n   * Convenience: Get Navigator\r\n   * \r\n   * @returns {NavigatorService|null}\r\n   */\r\n  navigator() {\r\n    return this.getService('navigator');\r\n  }\r\n  \r\n  /**\r\n   * Get framework service\r\n   * Accesses registered services from runtime\r\n   * \r\n   * @param {string} serviceName - Name of service\r\n   * @returns {*} - Service instance or null\r\n   * \r\n   * @example\r\n   * const navigator = context.getService('navigator');\r\n   * const theme = context.getService('theme');\r\n   */\r\n  getService(serviceName) {\r\n    if (!serviceName) {\r\n      throw new Error('Service name is required');\r\n    }\r\n    \r\n    if (!this._runtime || !this._runtime.serviceRegistry) {\r\n      return null;\r\n    }\r\n    \r\n    return this._runtime.serviceRegistry.get(serviceName) || null;\r\n  }\r\n  \r\n  /**\r\n   * Visit all ancestor elements\r\n   * Calls visitor function for each ancestor\r\n   * \r\n   * @param {Function} visitor - Callback function\r\n   *        Receives: element\r\n   *        Return false to stop traversal\r\n   * \r\n   * @example\r\n   * context.visitAncestorElements((element) => {\r\n   *   console.log(element.constructor.name);\r\n   *   // Return false to stop\r\n   * });\r\n   */\r\n  visitAncestorElements(visitor) {\r\n    if (typeof visitor !== 'function') {\r\n      throw new Error('Visitor must be a function');\r\n    }\r\n    \r\n    let current = this._element.parent;\r\n    \r\n    while (current) {\r\n      const shouldContinue = visitor(current);\r\n      \r\n      if (shouldContinue === false) {\r\n        break;\r\n      }\r\n      \r\n      current = current.parent;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Get size of element\r\n   * Returns width and height of DOM element\r\n   * \r\n   * @returns {Object|null} - { width, height } or null\r\n   * \r\n   * @example\r\n   * const size = context.size;\r\n   * if (size) {\r\n   *   console.log(`${size.width}x${size.height}`);\r\n   * }\r\n   */\r\n  get size() {\r\n    const domNode = this._element ? this._element.domNode : null;\r\n    \r\n    if (!domNode) {\r\n      return null;\r\n    }\r\n    \r\n    return {\r\n      width: domNode.offsetWidth,\r\n      height: domNode.offsetHeight\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Get position of element\r\n   * Returns x, y offset from document\r\n   * \r\n   * @returns {Object|null} - { x, y } or null\r\n   */\r\n  get position() {\r\n    const domNode = this._element ? this._element.domNode : null;\r\n    \r\n    if (!domNode) {\r\n      return null;\r\n    }\r\n    \r\n    return {\r\n      x: domNode.offsetLeft,\r\n      y: domNode.offsetTop\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Get bounds of element\r\n   * Returns position and size\r\n   * \r\n   * @returns {Object|null} - { x, y, width, height } or null\r\n   */\r\n  get bounds() {\r\n    const size = this.size;\r\n    const position = this.position;\r\n    \r\n    if (!size || !position) {\r\n      return null;\r\n    }\r\n    \r\n    return {\r\n      x: position.x,\r\n      y: position.y,\r\n      width: size.width,\r\n      height: size.height\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Dispatch a custom event\r\n   * For communicating with other widgets\r\n   * \r\n   * @param {string} eventName - Event name\r\n   * @param {*} data - Event data\r\n   * \r\n   * @example\r\n   * context.dispatch('theme-changed', { theme: 'dark' });\r\n   */\r\n  dispatch(eventName, data) {\r\n    if (!eventName) {\r\n      throw new Error('Event name is required');\r\n    }\r\n    \r\n    // Dispatch to runtime or element\r\n    if (this._element && this._element.dispatch) {\r\n      this._element.dispatch(eventName, data);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Get dependency information\r\n   * For debugging\r\n   * \r\n   * @returns {Object}\r\n   */\r\n  getDependencyInfo() {\r\n    return {\r\n      dependenciesCount: this._dependencies.size,\r\n      cachedInheritedWidgets: this._inheritedCache.size,\r\n      inheritedWidgetTypes: Array.from(this._inheritedCache.keys())\r\n        .map(Type => Type.name)\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Check if element is InheritedElement\r\n   * @private\r\n   */\r\n  _isInheritedElement(element) {\r\n    if (!element) return false;\r\n    \r\n    // Check by dependents property (MockInheritedElement has this)\r\n    return element.dependents !== undefined;\r\n  }\r\n  \r\n  /**\r\n   * Get Theme class\r\n   * @private\r\n   */\r\n  _getThemeClass() {\r\n    // Try to get from runtime or return a placeholder\r\n    if (this._runtime && this._runtime._ThemeClass) {\r\n      return this._runtime._ThemeClass;\r\n    }\r\n    \r\n    // Return a class that won't be found (graceful fallback)\r\n    return class ThemeClass {};\r\n  }\r\n  \r\n  /**\r\n   * Get MediaQuery class\r\n   * @private\r\n   */\r\n  _getMediaQueryClass() {\r\n    if (this._runtime && this._runtime._MediaQueryClass) {\r\n      return this._runtime._MediaQueryClass;\r\n    }\r\n    \r\n    return class MediaQueryClass {};\r\n  }\r\n  \r\n  /**\r\n   * Clear cache (for cleanup)\r\n   * @private\r\n   */\r\n  _clearCache() {\r\n    this._inheritedCache.clear();\r\n    this._dependencies.clear();\r\n    this._visited.clear();\r\n  }\r\n  \r\n  /**\r\n   * Dispose context\r\n   */\r\n  dispose() {\r\n    this._clearCache();\r\n    this._element = null;\r\n    this._runtime = null;\r\n    this._state = null;\r\n  }\r\n  \r\n  /**\r\n   * Get context information (for debugging)\r\n   * @returns {Object}\r\n   */\r\n  getInfo() {\r\n    return {\r\n      mounted: this.mounted,\r\n      widgetType: this.widget ? this.widget.constructor.name : null,\r\n      stateType: this.state ? this.state.constructor.name : null,\r\n      elementId: this._element ? this._element.id : null,\r\n      elementDepth: this._element ? this._element.depth : null,\r\n      size: this.size,\r\n      position: this.position,\r\n      dependencies: this.getDependencyInfo()\r\n    };\r\n  }\r\n}\r\n\r\n\r\nexport {BuildContext};\r\n"],
  "mappings": "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",
  "names": ["BuildContext", "element", "runtime", "state", "Type", "current", "widget", "cached", "themeWidget", "mq", "serviceName", "visitor", "domNode", "size", "position", "eventName", "data"]
}
