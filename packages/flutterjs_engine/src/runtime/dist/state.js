import{UpdateBatcher as a}from"./update_batcher.js";import{StateTracker as d}from"./state_tracker.js";class r{constructor(){this._element=null,this._widget=null,this._mounted=!1,this._updateQueued=!1,this._building=!1,this._initStateCalled=!1,this._disposeCalled=!1,this._didInitState=!1,this._didMount=!1,this._isActive=!1,this._buildCount=0,this._lastBuildTime=0}build(t){throw new Error(`${this.constructor.name}.build() must be implemented`)}initState(){}didUpdateWidget(t){}didChangeDependencies(){}dispose(){}didMount(){}activate(){}deactivate(){}reassemble(){}setState(t){if(!this.mounted){console.warn(`[State] setState called on unmounted state (${this.constructor.name})`);return}if(this._building&&console.warn(`[State] setState called during build in ${this.constructor.name}`),typeof t=="function")try{t.call(this)}catch(e){throw console.error("[State] setState update function failed:",e),e}else if(typeof t=="object"&&t!==null)Object.assign(this,t);else if(t!=null)throw new Error("setState accepts function or object");this._element&&this._element.markNeedsBuild&&this._element.markNeedsBuild()}get context(){return this._element?this._element.context:null}get mounted(){return this._mounted&&this._element&&this._element._mounted}get widget(){if(!this._widget)if(this._element&&this._element.widget)console.warn("[State] this._widget was null, recovering from element. This indicates _mount() was not called properly."),this._widget=this._element.widget;else return console.error(`[State] Cannot access this.widget - state not properly mounted. Element: ${!!this._element}, Element.widget: ${!!this._element?.widget}`),null;return this._widget}_markBuilding(t){this._building=t}_mount(t){if(console.log("\u{1F527} State._mount() called for:",this.constructor.name),this._mounted){console.warn("\u26A0\uFE0F State already mounted");return}if(this._element=t,this._widget=t.widget,console.log("\u2705 State._mount() set widget:",{widgetType:this._widget?.constructor?.name,widgetTitle:this._widget?.title,widgetProps:Object.keys(this._widget||{})}),this._mounted=!0,this._isActive=!0,!this._didInitState){this._didInitState=!0,console.log("\u{1F3AC} Calling initState()");try{this.initState()}catch(e){throw console.error("[State] initState failed:",e),e}}console.log("\u{1F517} Calling didChangeDependencies()");try{this.didChangeDependencies()}catch(e){console.error("[State] didChangeDependencies failed:",e)}if(!this._didMount){this._didMount=!0,console.log("\u{1F389} Calling didMount()");try{this.didMount()}catch(e){console.error("[State] didMount failed:",e)}}console.log("\u2705 State._mount() complete")}_unmount(){this._mounted&&(this._isActive=!1,this._mounted=!1)}_reactivate(){if(!this._isActive){this._isActive=!0;try{this.activate()}catch(t){console.error("[State] activate failed:",t)}}}_deactivate(){if(this._isActive){this._isActive=!1;try{this.deactivate()}catch(t){console.error("[State] deactivate failed:",t)}}}_updateWidget(t){console.log("\u{1F504} State._updateWidget() called"),console.log("  Old widget:",this._widget?.constructor?.name),console.log("  New widget:",t?.constructor?.name);const e=this._widget;if(this._widget=t,this.didUpdateWidget&&typeof this.didUpdateWidget=="function")try{this.didUpdateWidget(e)}catch(i){console.error("[State] didUpdateWidget failed:",i)}console.log("\u2705 Widget updated")}_dispose(){if(!this._disposeCalled){this._disposeCalled=!0,this._mounted=!1,this._isActive=!1;try{this.dispose()}catch(t){console.error("[State] dispose failed:",t)}this._element=null,this._widget=null}}getStats(){return{mounted:this.mounted,buildCount:this._buildCount,lastBuildTime:this._lastBuildTime,initStateCalled:this._initStateCalled,disposeCalled:this._disposeCalled,isActive:this._isActive,hasWidget:!!this._widget,widgetType:this._widget?.constructor?.name||"none"}}}class o extends r{constructor(){super()}_mount(t){super._mount(t);const e=this.constructor.widgetType;e&&!(this._widget instanceof e)&&console.warn(`[TypedState] Type mismatch: expected ${e.name}, got ${this._widget?.constructor?.name}`)}get widget(){const t=super.widget;if(!t)throw new Error("[TypedState] this.widget is null. State may not be properly mounted. Ensure StatefulElement calls state._mount(this) during mount.");return t}}class l{constructor(t,e,i=null){this._element=t,this._runtime=e,this._state=i}get widget(){return this._state&&this._state._widget?this._state._widget:this._element?.widget||null}get state(){return this._state}get element(){return this._element}get runtime(){return this._runtime}findAncestorWidgetOfExactType(t){let e=this._element?._parent;for(;e;){if(e.widget instanceof t)return e.widget;e=e._parent}return null}findAncestorStateOfType(t){let e=this._element?._parent;for(;e;){if(e.state&&e.state instanceof t)return e.state;e=e._parent}return null}}class s{constructor(t){this.runtime=t,this.states=new Map,this.stateElements=new WeakMap,this.updateBatcher=new a(this),this.stateTracker=new d,this.config={enableBatching:!0,enableTracking:!0,warnOnSetStateDuringBuild:!0,debugMode:!1},this.stats={statesCreated:0,statesDisposed:0,setStateCalls:0,batchedUpdates:0}}register(t,e){if(!t||!e)throw new Error("State and element are required");const i=this.generateStateId(t);this.states.set(i,t),this.stateElements.set(t,e),!t._widget&&e.widget&&(console.warn("[StateManager] State widget not set, setting from element. This indicates _mount() was not called."),t._widget=e.widget),this.stats.statesCreated++,this.config.debugMode&&(console.log(`[StateManager] Registered state ${i}`),console.log(`  Widget type: ${t._widget?.constructor?.name}`),console.log("  Widget props:",Object.keys(t._widget||{})))}unregister(t){if(!t)return;const e=this.generateStateId(t);t._disposeCalled||t._dispose(),this.states.delete(e),this.stateElements.delete(t),t._element=null,t._widget=null,this.stats.statesDisposed++,this.config.debugMode&&console.log(`[StateManager] Unregistered state ${e}`)}handleSetState(t,e){!t||!t.mounted||(this.stats.setStateCalls++,this.config.enableBatching?this.updateBatcher.queueUpdate(t._element,e):(e(),t._element.markNeedsBuild()))}generateStateId(t){return t._stateId||(t._stateId=`state_${++s._stateIdCounter}`),t._stateId}getElement(t){return this.stateElements.get(t)}getStats(){return{...this.stats,currentStates:this.states.size,batcher:this.updateBatcher.getStats(),tracker:this.stateTracker.getStats()}}clear(){this.states.forEach(t=>{t._disposeCalled||t._dispose()}),this.states.clear(),this.updateBatcher.clear(),this.stateTracker.clear()}dispose(){this.clear()}}s._stateIdCounter=0;export{l as EnhancedBuildContext,r as State,s as StateManager,o as TypedState};
//# sourceMappingURL=state.js.map
