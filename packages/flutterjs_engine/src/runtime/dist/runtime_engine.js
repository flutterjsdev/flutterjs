import{StatelessElement as s,StatefulElement as o,InheritedElement as d,ComponentElement as u}from"../src/element.js";class l{constructor(){this.rootElement=null,this.rootWidget=null,this.elementTree=null,this.dirtyElements=new Set,this.updateScheduled=!1,this.isUpdating=!1,this.buildContext=null,this.serviceRegistry=new Map,this.frameCounter=0,this.buildTime=0,this.renderTime=0,this.lastUpdateTime=0,this.mounted=!1,this.disposed=!1,this.config={batchUpdates:!0,debugMode:!1,performanceMonitoring:!0}}mount(e,t){if(this.mounted)throw new Error("Runtime already mounted. Call unmount() first.");if(!e)throw new Error("Root widget is required");if(!t||!(t instanceof HTMLElement))throw new Error("Valid container element is required");try{if(this.rootWidget=e,this.rootElement=t,this.elementTree=this.createElement(e,null),!this.elementTree)throw new Error("Failed to create root element");const i=performance.now(),n=this.elementTree.build();if(this.buildTime=performance.now()-i,!n)throw new Error("Root element build() returned null");const r=performance.now();return this.renderVNode(n,t),this.renderTime=performance.now()-r,this.elementTree.domNode=t.firstChild,this.elementTree.mount(),this.mounted=!0,this.config.debugMode&&(console.log(`[RuntimeEngine] Mounted in ${(this.buildTime+this.renderTime).toFixed(2)}ms`),console.log(`  - Build: ${this.buildTime.toFixed(2)}ms`),console.log(`  - Render: ${this.renderTime.toFixed(2)}ms`)),this}catch(i){throw this.cleanup(),new Error(`Failed to mount application: ${i.message}`)}}createElement(e,t){if(!e)throw new Error("Widget is required");if(typeof e.createElement=="function")return e.createElement(t,this);const i=e.constructor.name;if(this.isStatelessWidget(e))return new s(e,t,this);if(this.isStatefulWidget(e))return new o(e,t,this);if(this.isInheritedWidget(e))return new d(e,t,this);if(this.isComponentWidget(e))return new u(e,t,this);throw new Error(`Unknown widget type: ${i}. Widget must extend StatelessWidget, StatefulWidget, InheritedWidget, or have render/build method.`)}isStatelessWidget(e){return e.constructor.name==="StatelessWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="StatelessWidget"||typeof e.build=="function"&&!e.createState&&!e.child}isStatefulWidget(e){return e.constructor.name==="StatefulWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="StatefulWidget"||typeof e.createState=="function"}isInheritedWidget(e){return e.constructor.name==="InheritedWidget"||e.constructor.prototype&&e.constructor.prototype.constructor.name==="InheritedWidget"||e.child!==void 0&&typeof e.updateShouldNotify=="function"}isComponentWidget(e){return typeof e.render=="function"||typeof e.build=="function"&&typeof e.createState!="function"}renderVNode(e,t){if(!e)return;if(typeof e=="string"){t.textContent=e;return}const i=document.createElement(e.tag||"div");e.props&&Object.entries(e.props).forEach(([n,r])=>{n==="className"?i.className=r:n==="style"&&typeof r=="object"?Object.assign(i.style,r):(n.startsWith("data-"),i.setAttribute(n,r))}),e.style&&Object.assign(i.style,e.style),e.children&&e.children.forEach(n=>{if(typeof n=="string")i.appendChild(document.createTextNode(n));else if(n){const r=document.createElement("div");this.renderVNode(n,r),r.firstChild&&i.appendChild(r.firstChild)}}),t.appendChild(i)}markNeedsBuild(e){if(!e){console.warn("[RuntimeEngine] markNeedsBuild called with null element");return}if(!this.mounted){this.config.debugMode&&console.warn("[RuntimeEngine] markNeedsBuild called but runtime not mounted");return}this.dirtyElements.add(e),this.scheduleUpdate()}scheduleUpdate(){this.updateScheduled||this.disposed||(this.updateScheduled=!0,requestAnimationFrame(()=>{this.performUpdate()}))}performUpdate(){if(!this.disposed){if(this.isUpdating){this.updateScheduled=!0;return}this.updateScheduled=!1,this.isUpdating=!0;try{const e=performance.now(),t=Array.from(this.dirtyElements);if(t.length===0){this.isUpdating=!1;return}t.sort((i,n)=>i.depth-n.depth);for(const i of t)if(i.mounted&&this.dirtyElements.has(i))try{i.rebuild()}catch(n){console.error("[RuntimeEngine] Error rebuilding element:",n)}this.dirtyElements.clear(),this.buildTime=performance.now()-e,this.lastUpdateTime=Date.now(),this.frameCounter++,this.config.performanceMonitoring&&this.buildTime>16&&console.warn(`[RuntimeEngine] Slow update: ${this.buildTime.toFixed(2)}ms (${t.length} elements)`),this.config.debugMode&&console.log(`[RuntimeEngine] Updated ${t.length} elements in ${this.buildTime.toFixed(2)}ms`)}finally{this.isUpdating=!1,this.updateScheduled&&this.dirtyElements.size>0&&this.scheduleUpdate()}}}unmount(){if(!this.mounted){console.warn("[RuntimeEngine] unmount called but not mounted");return}try{this.elementTree&&(this.elementTree.unmount(),this.elementTree=null),this.cleanup(),this.config.debugMode&&console.log("[RuntimeEngine] Unmounted")}catch(e){console.error("[RuntimeEngine] Error during unmount:",e)}}cleanup(){this.dirtyElements.clear(),this.serviceRegistry.clear(),this.mounted=!1,this.updateScheduled=!1,this.isUpdating=!1}dispose(){this.disposed||(this.unmount(),this.rootElement=null,this.rootWidget=null,this.buildContext=null,this.disposed=!0,this.config.debugMode&&console.log("[RuntimeEngine] Disposed"))}getStats(){return{mounted:this.mounted,frameCount:this.frameCounter,buildTime:this.buildTime,renderTime:this.renderTime,lastUpdateTime:this.lastUpdateTime,dirtyElements:this.dirtyElements.size,updateScheduled:this.updateScheduled}}registerService(e,t){this.serviceRegistry.set(e,t)}getService(e){return this.serviceRegistry.get(e)}setDebugMode(e){this.config.debugMode=e}}export{l as RuntimeEngine};
//# sourceMappingURL=runtime_engine.js.map
