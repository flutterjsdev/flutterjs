import{BuildContext as l}from"./build_context.js";const a={hidden:"hidden",fine:"fine",debug:"debug",info:"info",warning:"warning",hint:"hint",summary:"summary",error:"error",off:"off"},h={none:"none",sparse:"sparse",offstage:"offstage",dense:"dense",transition:"transition",error:"error",whitespace:"whitespace",flat:"flat",singleLine:"singleLine",errorProperty:"errorProperty",shallow:"shallow",truncateChildren:"truncateChildren"};class c{toStringShort(){return`${this.constructor.name}${this.key?`(key: ${this.key})`:"(unkeyed)"}`}toDiagnosticsNode(t=null,e=h.sparse){return{name:t||this.constructor.name,value:this,style:e,toString:()=>this.toStringShort()}}debugFillProperties(t){this.key!==null&&this.key!==void 0&&t.push({name:"key",value:this.key})}debugInfo(){const t=[];return this.debugFillProperties(t),{type:this.constructor.name,key:this.key||null,properties:t,style:this.style||h.sparse,description:this.toStringShort()}}toString(){return this.toStringShort()}}class i extends c{constructor(t,e,r){if(super(),console.log("\u274C Element constructor called:",{widgetType:t?.constructor.name,hasParent:!!e,runtimeType:r?.constructor.name,runtimeDefined:r!==void 0,runtimeArg:r}),!t)throw new Error("Widget is required for Element creation");if(!r)throw console.error("\u274C RUNTIME IS UNDEFINED!"),console.error("   Widget type:",t.constructor.name),console.error("   Parent:",e?.constructor.name),console.error("   Called from:",new Error().stack),new Error("RUNTIME IS UNDEFINED! Runtime is required for Element creation");this.widget=t,this.parent=e,this.runtime=r,console.log("\u2713 Element created:",{type:this.constructor.name,runtime:this.runtime.constructor.name}),this.children=[],this.childMap=new Map,this.vnode=null,this.domNode=null,this.mounted=!1,this.dirty=!1,this.building=!1,this.depth=e?e.depth+1:0,this.key=t.key,this.id=i.generateId(),this.buildCount=0,this.lastBuildTime=0,this.lastBuildDuration=0}build(){throw new Error(`${this.constructor.name}.build() must be implemented by subclass`)}mount(){if(this.mounted){console.warn(`[Element] ${this.id} already mounted`);return}try{this.mounted=!0,this.vnode=this.performBuild(),this.children.forEach(t=>{t.mounted||t.mount()}),this.didMount()}catch(t){throw this.mounted=!1,new Error(`Failed to mount ${this.constructor.name}: ${t.message}`)}}update(t){if(!t)throw new Error("New widget is required for update");const e=this.widget;this.widget=t,this.shouldRebuild(e,t)&&this.markNeedsBuild(),this.didUpdateWidget(e,t)}rebuild(){if(!this.mounted){console.warn(`[Element] Cannot rebuild unmounted element ${this.id}`);return}if(this.building){console.warn(`[Element] Recursive rebuild detected for ${this.id}`);return}try{this.building=!0;const t=this.vnode;this.vnode=this.performBuild(),this.applyChanges(t,this.vnode),this.dirty=!1}catch(t){throw console.error(`[Element] Rebuild failed for ${this.id}:`,t),t}finally{this.building=!1}}performBuild(){const t=performance.now();try{const e=this.build();if(!e)throw new Error("build() returned null or undefined");return this.buildCount++,this.lastBuildTime=Date.now(),this.lastBuildDuration=performance.now()-t,e}catch(e){throw new Error(`Build failed: ${e.message}`)}}applyChanges(t,e){this.runtime.config&&this.runtime.config.debugMode&&console.log(`[Element] Applied changes to ${this.id}`)}markNeedsBuild(){if(!this.dirty){if(!this.mounted){console.warn(`[Element] Cannot mark unmounted element ${this.id} dirty`);return}this.dirty=!0,this.runtime&&this.runtime.markNeedsBuild&&this.runtime.markNeedsBuild(this)}}unmount(){if(this.mounted)try{this.willUnmount(),this.children.forEach(t=>{t.mounted&&t.unmount()}),this.children=[],this.childMap.clear(),this.vnode=null,this.domNode=null,this.mounted=!1,this.dirty=!1,this.didUnmount()}catch(t){console.error(`[Element] Unmount failed for ${this.id}:`,t)}}shouldRebuild(t,e){return t===e?!1:t.constructor!==e.constructor?!0:!this.areWidgetsEqual(t,e)}areWidgetsEqual(t,e){if(t.constructor!==e.constructor)return!1;const r=Object.keys(t),n=Object.keys(e);return r.length!==n.length?!1:r.every(d=>{const s=t[d],o=e[d];return typeof s=="function"&&typeof o=="function"?!0:typeof s=="object"&&typeof o=="object"?JSON.stringify(s)===JSON.stringify(o):s===o})}addChild(t){if(!t)throw new Error("Child element is required");this.children.push(t),t.key&&this.childMap.set(t.key,t),t.parent=this}removeChild(t){const e=this.children.indexOf(t);e!==-1&&this.children.splice(e,1),t.key&&this.childMap.delete(t.key),t.parent=null}findChildByKey(t){return this.childMap.get(t)}findAncestorOfType(t){let e=this.parent;for(;e;){if(e instanceof t)return e;e=e.parent}return null}visitAncestors(t){let e=this.parent;for(;e&&t(e)!==!1;)e=e.parent}didMount(){}didUpdateWidget(t,e){}willUnmount(){}didUnmount(){}getStats(){return{id:this.id,type:this.constructor.name,mounted:this.mounted,dirty:this.dirty,depth:this.depth,childCount:this.children.length,buildCount:this.buildCount,lastBuildDuration:this.lastBuildDuration,hasKey:!!this.key}}static generateId(){return`el_${++i._counter}`}static resetCounter(){i._counter=0}}i._counter=0;class m extends i{constructor(t,e,r){super(t,e,r)}build(){console.log("\u{1F50D} StatelessElement.build() - checking this.runtime:",{exists:!!this.runtime,type:this.runtime?.constructor.name,isUndefined:this.runtime===void 0});const t=this.buildContext();try{const e=this.widget.build(t);if(!e)throw new Error("StatelessWidget.build() returned null");if(e&&typeof e=="object"&&e.constructor.name&&!e.tag){const r=this.runtime.createElement(e,this);if(!r)throw new Error("Failed to create element from child widget");return r.build()}return e}catch(e){throw new Error(`StatelessWidget build failed: ${e.message}`)}}buildContext(){return new l(this,this.runtime)}}class f extends i{constructor(t,e,r){if(super(t,e,r),!t.createState||typeof t.createState!="function")throw new Error("StatefulWidget must implement createState()");if(this.state=t.createState(),!this.state)throw new Error("createState() returned null or undefined");this.state._element=this,this.state._widget=t,this.state._mounted=!1}build(){const t=this.buildContext();try{if(!this.state.build||typeof this.state.build!="function")throw new Error("State must implement build() method");const e=this.state.build(t);if(!e)throw new Error("State.build() returned null");if(e&&typeof e=="object"&&e.constructor.name&&!e.tag){const r=this.runtime.createElement(e,this);if(!r)throw new Error("Failed to create element from child widget");return r.build()}return e}catch(e){throw new Error(`StatefulWidget build failed: ${e.message}`)}}mount(){if(this.state.initState&&typeof this.state.initState=="function")try{this.state.initState()}catch(t){console.error("[StatefulElement] initState failed:",t)}this.state._mounted=!0,super.mount()}update(t){const e=this.widget;if(this.widget=t,this.state._widget=t,this.state.didUpdateWidget&&typeof this.state.didUpdateWidget=="function")try{this.state.didUpdateWidget(e)}catch(r){console.error("[StatefulElement] didUpdateWidget failed:",r)}this.shouldRebuild(e,t)&&this.markNeedsBuild()}unmount(){if(this.state.dispose&&typeof this.state.dispose=="function")try{this.state.dispose()}catch(t){console.error("[StatefulElement] dispose failed:",t)}this.state._mounted=!1,super.unmount()}buildContext(){return new l(this,this.runtime,this.state)}getStats(){return{...super.getStats(),hasState:!!this.state,stateMounted:this.state?this.state._mounted:!1}}}class p extends i{constructor(t,e,r){super(t,e,r),this.componentState={}}build(){const t=this.widget.render||this.widget.build;if(!t||typeof t!="function")throw new Error("ComponentElement widget must have render() or build() method");const e=this.buildContext();try{const r=t.call(this.widget,e);if(r&&typeof r=="object"&&r.constructor.name&&!r.tag){const n=this.runtime.createElement(r,this);if(!n)throw new Error("Failed to create element from child widget");return n.build()}return r}catch(r){throw new Error(`Component build failed: ${r.message}`)}}buildContext(){return{element:this,runtime:this.runtime,widget:this.widget,state:this.componentState,setState:t=>{Object.assign(this.componentState,t),this.markNeedsBuild()}}}}export{p as ComponentElement,a as DiagnosticLevel,c as Diagnosticable,i as Element,f as StatefulElement,m as StatelessElement};
//# sourceMappingURL=element.js.map
