import{BuildContext as f}from"./build_context.js";import{VNodeDiffer as p}from"@flutterjs/vdom/vnode_differ";import{PatchApplier as _}from"@flutterjs/vdom/patch_applier";const y={hidden:"hidden",fine:"fine",debug:"debug",info:"info",warning:"warning",hint:"hint",summary:"summary",error:"error",off:"off"},g={none:"none",sparse:"sparse",offstage:"offstage",dense:"dense",transition:"transition",error:"error",whitespace:"whitespace",flat:"flat",singleLine:"singleLine",errorProperty:"errorProperty",shallow:"shallow",truncateChildren:"truncateChildren"};class b{toStringShort(){return`${this.constructor.name}${this.key?`(key: ${this.key})`:"(unkeyed)"}`}toDiagnosticsNode(t=null,e=g.sparse){return{name:t||this.constructor.name,value:this,style:e,toString:()=>this.toStringShort()}}debugFillProperties(t){this.key!==null&&this.key!==void 0&&t.push({name:"key",value:this.key})}debugInfo(){const t=[];return this.debugFillProperties(t),{type:this.constructor.name,key:this.key||null,properties:t,style:this.style||g.sparse,description:this.toStringShort()}}toString(){return this.toStringShort()}}function a(i){if(!i||typeof i!="object")return!1;const t=typeof i.tag=="string",e=Array.isArray(i.children)||i.children===null||i.children===void 0,n=i.props===null||i.props===void 0||typeof i.props=="object",r=typeof i.build!="function"&&typeof i.createState!="function";return t&&e&&n&&r}function m(i){return!i||typeof i!="object"?!1:typeof i.build=="function"||typeof i.createState=="function"||typeof i.render=="function"}class l extends b{constructor(t,e=null,n=null){if(super(),!t)throw new Error("Widget is required for Element creation");if(!n)throw new Error("RUNTIME IS UNDEFINED! Runtime is required for Element creation");this._widget=t,this._parent=e,this.runtime=n,this._children=[],this._childMap=new Map,this._vnode=null,this._domNode=null,this._mounted=!1,this._dirty=!1,this._building=!1,this._shouldPatch=!0,this._depth=e?(e._depth||0)+1:0,this.key=t.key,this._id=l.generateId(),this._buildCount=0,this._lastBuildTime=0,this._lastBuildDuration=0,this._context=null}get widget(){return this._widget}set widget(t){this._widget=t}get parent(){return this._parent}set parent(t){this._parent=t}get children(){return this._children}get depth(){return this._depth}get id(){return this._id}get mounted(){return this._mounted}get dirty(){return this._dirty}get building(){return this._building}get vnode(){return this._vnode}set vnode(t){this._vnode=t}get domNode(){return this._domNode}set domNode(t){this._domNode=t}get context(){return this._context||(this._context=new f(this,this.runtime)),this._context}getElementId(){return this._id}getWidgetPath(){if(this._widgetPath)return this._widgetPath;const t=this.widget?.constructor?.name||"Unknown",e=this.parent?.getWidgetPath?this.parent.getWidgetPath():"";return this._widgetPath=e?`${e}/${t}`:t,this._widgetPath}getIdentificationStrategy(){return this.key?"key":"id"}performRebuild(){throw new Error(`${this.constructor.name}.performRebuild() must be implemented by subclass`)}mount(t=null){if(this._mounted){console.warn(`[Element] ${this._id} already mounted`);return}try{this._mounted=!0,t&&(this._parent=t,this._depth=(t._depth||0)+1),this._vnode=this.performRebuild(),this._children.forEach(e=>{e._mounted||e.mount(this)}),this.didMount()}catch(e){throw this._mounted=!1,new Error(`Failed to mount ${this.constructor.name}: ${e.message}`)}}rebuild(){if(!this._mounted){console.warn(`[Element] Cannot rebuild unmounted element ${this._id}`);return}if(this._building){console.warn(`[Element] Recursive rebuild detected for ${this._id}`);return}try{this._building=!0;const t=this._vnode;this._vnode=this.performRebuild(),this._shouldPatch?this.applyChanges(t,this._vnode):this._vnode&&this._vnode._element&&(this._domNode=this._vnode._element),this._dirty=!1}catch(t){throw console.error(`[Element] Rebuild failed for ${this._id}:`,t),t}finally{this._building=!1}}applyChanges(t,e){if(this.runtime.config&&this.runtime.config.debugMode&&console.log(`[Element] Applied changes to ${this._id}`),t&&t._element&&this.runtime.renderer){if(t._element.parentNode)try{const n=t._element,r=n.parentNode,o=Array.from(r.childNodes).indexOf(n);if(o!==-1){this.runtime.config&&this.runtime.config.debugMode&&console.log(`[Element] Diffing at index ${o}`);const s=p.diff(t,e,o);if(s.length>0){console.log(`[Element] Applying ${s.length} patches to ${this._id} (${this.widget?.constructor.name})`),s.forEach(c=>console.log(`   - Patch: ${c.type} at index ${c.index}, content:`,c.content));const u=_.apply(r,s);u.success?console.log("[Element] Patches applied successfully"):console.error("[Element] PatchApplier failed:",u.errors),e._element||(e._element=t._element),this._domNode===n&&(this._domNode=e._element)}else console.log(`[Element] No patches generated for ${this._id} (${this.widget?.constructor.name})`),e._element=t._element,e._element&&(e._element._vnode=e);return}}catch(n){console.warn("[Element] Diffing failed, falling back to replace",n)}this.runtime.config&&this.runtime.config.debugMode&&console.log(`[Element] Fallback: Replacing DOM for ${this._id}`);try{const n=this.runtime.renderer.replaceElement(t._element,e);this._domNode===t._element&&(this._domNode=n)}catch(n){console.error(`[Element] Failed to patch DOM for ${this._id}:`,n)}}}markNeedsBuild(){if(!this._dirty){if(!this._mounted){console.warn(`[Element] Cannot mark unmounted element ${this._id} dirty`);return}this._dirty=!0,this.runtime&&this.runtime.markNeedsBuild&&this.runtime.markNeedsBuild(this)}}unmount(){if(this._mounted)try{this.willUnmount(),this._children.forEach(t=>{t._mounted&&t.unmount()}),this._children=[],this._childMap.clear(),this._vnode=null,this._domNode=null,this._mounted=!1,this._dirty=!1,this.didUnmount()}catch(t){console.error(`[Element] Unmount failed for ${this._id}:`,t)}}updateWidget(t){if(!t)throw new Error("New widget is required for update");const e=this._widget;this.widget=t,this.shouldRebuild(e,t)&&this.markNeedsBuild(),this.didUpdateWidget(e,t)}shouldRebuild(t,e){return t===e?!1:t.constructor!==e.constructor?!0:!this.areWidgetsEqual(t,e)}areWidgetsEqual(t,e){if(t.constructor!==e.constructor)return!1;const n=Object.keys(t),r=Object.keys(e);return n.length!==r.length?!1:n.every(o=>{const s=t[o],u=e[o];if(typeof s=="function"&&typeof u=="function")return!0;if(typeof s=="object"&&typeof u=="object")try{return JSON.stringify(s)===JSON.stringify(u)}catch{return!1}return s===u})}addChild(t){if(!t)throw new Error("Child element is required");this._children.push(t),t.key&&this._childMap.set(t.key,t),t.parent=this}removeChild(t){const e=this._children.indexOf(t);e!==-1&&this._children.splice(e,1),t.key&&this._childMap.delete(t.key),t.parent=null}findChildByKey(t){return this._childMap.get(t)}findAncestorOfType(t){let e=this._parent;for(;e;){if(e instanceof t)return e;e=e._parent}return null}visitAncestors(t){let e=this._parent;for(;e&&t(e)!==!1;)e=e._parent}didMount(){}didUpdateWidget(t,e){}willUnmount(){}didUnmount(){}reassemble(){}activate(){}deactivate(){}didChangeDependencies(){}getStats(){return{id:this._id,type:this.constructor.name,mounted:this._mounted,dirty:this._dirty,depth:this._depth,childCount:this._children.length,buildCount:this._buildCount,lastBuildDuration:this._lastBuildDuration,hasKey:!!this.key}}static generateId(){return`el_${++l._counter}`}static resetCounter(){l._counter=0}}l._counter=0;class d extends l{constructor(t,e,n){super(t,e,n)}build(){console.log("\u{1F4E6} StatelessElement.build() START",{widgetType:this.widget?.constructor.name,widgetInstance:this.widget});const t=this.buildContext();try{console.log("\u{1F528} Calling widget.build(context)...");const e=this.widget.build(t);if(console.log("\u2713 widget.build() returned:",{resultType:typeof e,resultConstructor:e?.constructor?.name,hasTag:e?.tag!==void 0,isString:typeof e=="string",isNull:e===null}),!e)throw console.warn("\u26A0\uFE0F Result is null/undefined"),new Error("StatelessWidget.build() returned null");if(a(e))return console.log("\u2705 Result is a REAL VNode, returning it directly"),this._shouldPatch=!0,e;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return console.log("\u2705 Result is a primitive:",e),this._shouldPatch=!0,e;if(m(e)){console.log("\u{1F504} Result is a Widget, need to build recursively:",e.constructor.name);let n=this._children[0];if(n&&n.widget.constructor===e.constructor&&n.widget.key===e.key){console.log("\u267B\uFE0F Reusing existing child element for:",e.constructor.name);const o=n.widget;return n.widget=e,n.shouldRebuild(o,e)?(console.log("\u{1F504} Widget changed, rebuilding child element"),n.rebuild()):console.log("\u2705 Widget unchanged, reusing existing vnode"),n.vnode}n&&(console.log("\u{1F5D1}\uFE0F Unmounting old child element:",n.constructor.name),n.unmount(),this._children=[]),n=this._createElementForWidget(e),console.log("\u2705 Created child element:",n.constructor.name),n._parent=this,n._depth=this._depth+1,n._mounted=!0,this._children=[n],console.log("\u2705 Set up child element parent/depth");const r=n.build();if(n.vnode=r,console.log("\u2705 Child element.build() returned:",{hasTag:r?.tag!==void 0,type:typeof r,isRealVNode:a(r)}),!r)throw new Error("Child element.build() returned null");return this._shouldPatch=!1,r}throw console.warn("\u26A0\uFE0F Unknown result type from build():",e),console.warn("   Constructor:",e?.constructor?.name),console.warn("   Type:",typeof e),console.warn("   Has .tag:",e?.tag),console.warn("   Has .build:",typeof e?.build),new Error(`Invalid build() return type from ${this.widget.constructor.name}. Expected: Widget, VNode, string, number, or null. Got: ${e?.constructor?.name} with tag="${e?.tag}"`)}catch(e){throw console.error("\u274C Build error:",e.message),console.error("   Widget:",this.widget?.constructor.name),new Error(`StatelessWidget build failed: ${e.message}`)}}_createElementForWidget(t){if(t&&typeof t.createElement=="function")return console.log("  Using widget.createElement() for:",t.constructor.name),t.createElement(this,this.runtime);if(typeof t.createState=="function")return console.log("  Creating StatefulElement for:",t.constructor.name),new h(t,this,this.runtime);if(t.updateShouldNotify&&typeof t.updateShouldNotify=="function")throw console.error("  \u26A0\uFE0F InheritedWidget without createElement():",t.constructor.name),new Error(`InheritedWidget "${t.constructor.name}" must define createElement() method. Extend InheritedWidget class properly.`);return console.log("  Creating StatelessElement for:",t.constructor.name),new d(t,this,this.runtime)}buildContext(){return new f(this,this.runtime)}performRebuild(){return this.build()}}class h extends l{constructor(t,e,n){if(super(t,e,n),!t.createState||typeof t.createState!="function")throw new Error("StatefulWidget must implement createState()");if(this.state=t.createState(),!this.state)throw new Error("createState() returned null or undefined");this.state._element=this,this.state._widget=t,this.state._mounted=!1}build(){console.log("\u{1F4E6} StatefulElement.build() START",{widgetType:this.widget?.constructor.name,stateType:this.state?.constructor.name});const t=this.buildContext();try{if(!this.state.build||typeof this.state.build!="function")throw new Error("State must implement build() method");console.log("\u{1F528} Calling state.build(context)...");const e=this.state.build(t);if(console.log("\u2713 state.build() returned:",{resultType:typeof e,resultConstructor:e?.constructor?.name,isVNode:e?.tag!==void 0}),!e)throw new Error("State.build() returned null");if(a(e))return console.log("\u2705 Result is a REAL VNode, returning"),this._shouldPatch=!0,e;if(typeof e=="string"||typeof e=="number"||typeof e=="boolean")return console.log("\u2705 Result is a primitive"),this._shouldPatch=!0,e;let n=this._children[0];if(m(e)){if(console.log("\u{1F504} State.build() returned a Widget, building recursively:",e.constructor.name),n&&n.widget.constructor===e.constructor&&n.widget.key===e.key){console.log("\u267B\uFE0F Reusing existing child element for:",e.constructor.name);const o=n.widget;return n.widget=e,n.shouldRebuild(o,e)?(console.log("\u{1F504} Widget changed, rebuilding child element"),n.rebuild()):console.log("\u2705 Widget unchanged, reusing existing vnode"),this._shouldPatch=!1,n.vnode}n&&(console.log("\u{1F5D1}\uFE0F Unmounting old child element:",n.constructor.name),n.unmount(),this._children=[]),this._shouldPatch=!1,n=this._createElementForWidget(e),n._parent=this,n._depth=this._depth+1,n._mounted=!0,this._children=[n];const r=n.build();if(n.vnode=r,!r)throw new Error("Child element.build() returned null");return r}return this._shouldPatch=!1,n?n.vnode:e;throw new Error(`Invalid build() return type from ${this.widget.constructor.name} state. Expected: Widget, VNode, string, number, or null.`)}catch(e){throw new Error(`StatefulWidget build failed: ${e.message}`)}}_createElementForWidget(t){return t&&typeof t.createElement=="function"?t.createElement(this,this.runtime):typeof t.createState=="function"?new h(t,this,this.runtime):t.updateShouldNotify&&typeof t.updateShouldNotify=="function"?new InheritedElement(t,this,this.runtime):new d(t,this,this.runtime)}mount(){if(console.log("\u{1F680} StatefulElement.mount() called"),console.log("   Widget:",this.widget?.constructor?.name),console.log("   State:",this.state?.constructor?.name),console.log("   State has _mount:",typeof this.state._mount=="function"),this.state._mount&&typeof this.state._mount=="function")console.log("\u2705 Calling state._mount(this)..."),this.state._mount(this),console.log("\u2705 state._mount() complete");else if(console.log("\u26A0\uFE0F State does not have _mount(), using fallback initialization"),this.state._element=this,this.state._widget=this.widget,this.state._mounted=!0,this.state.initState&&typeof this.state.initState=="function")try{console.log("\u{1F3AC} Calling initState()..."),this.state.initState()}catch(t){console.error("[StatefulElement] initState failed:",t)}console.log("\u{1F50D} State after mount:",{hasMounted:this.state._mounted,hasElement:!!this.state._element,hasWidget:!!this.state._widget,widgetType:this.state._widget?.constructor?.name,widgetTitle:this.state._widget?.title}),super.mount(),console.log("\u2705 StatefulElement.mount() complete")}buildContext(){return new f(this,this.runtime,this.state)}updateWidget(t){console.log("\u{1F504} StatefulElement.updateWidget() called");const e=this._widget;if(super.updateWidget(t),this.state._updateWidget&&typeof this.state._updateWidget=="function"?(console.log("\u2705 Calling state._updateWidget()"),this.state._updateWidget(t)):(console.log("\u26A0\uFE0F State does not have _updateWidget(), updating directly"),this.state._widget=t),this.state.didUpdateWidget&&typeof this.state.didUpdateWidget=="function")try{this.state.didUpdateWidget(e)}catch(n){console.error("[StatefulElement] didUpdateWidget failed:",n)}}unmount(){console.log("\u{1F6D1} StatefulElement.unmount() called"),this.state._unmount&&typeof this.state._unmount=="function"&&this.state._unmount(),this.state._dispose&&typeof this.state._dispose=="function"&&this.state._dispose(),super.unmount()}performRebuild(){return this.build()}}class E extends l{constructor(t,e,n){super(t,e,n),this.componentState={}}build(){const t=this.widget.render||this.widget.build;if(!t||typeof t!="function")throw new Error("ComponentElement widget must have render() or build() method");const e=this.buildContext();try{const n=t.call(this.widget,e);if(n&&typeof n=="object"&&n.tag||typeof n=="string"||typeof n=="number")return n;if(n&&typeof n=="object"&&(typeof n.build=="function"||typeof n.createState=="function")){const o=this._createElementForWidget(n);return o._parent=this,o._depth=this._depth+1,o._mounted=!0,o.build()}return n}catch(n){throw new Error(`Component build failed: ${n.message}`)}}_createElementForWidget(t){return t&&typeof t.createElement=="function"?t.createElement(this,this.runtime):typeof t.createState=="function"?new h(t,this,this.runtime):new d(t,this,this.runtime)}buildContext(){return{element:this,runtime:this.runtime,widget:this.widget,state:this.componentState,setState:t=>{Object.assign(this.componentState,t),this.markNeedsBuild()}}}performRebuild(){return this.build()}}export{E as ComponentElement,y as DiagnosticLevel,b as Diagnosticable,l as Element,h as StatefulElement,d as StatelessElement,a as isRealVNode,m as isWidget};
//# sourceMappingURL=element.js.map
