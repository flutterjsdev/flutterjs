import h from"fs";import{Lexer as y}from"./lexer.js";import{Parser as S}from"./flutterjs_parser.js";import{WidgetAnalyzer as w}from"./flutterjs_widget_analyzer.js";import{StateAnalyzer as x}from"./state_analyzer_implementation.js";import{ContextAnalyzer as z}from"./context_analyzer.js";import{SSRAnalyzer as v}from"./ssr_analyzer.js";import{ReportGenerator as E}from"./flutterjs_report_generator.js";import{ImportResolver as $}from"./flutter_import_resolver.js";import{resolverConfig as R}from"./flutter_resolver_config.js";import{initLogger as C}from"./flutterjs_logger.js";class g{constructor(e={}){this.options={sourceFile:null,sourceCode:null,outputFormat:"json",outputFile:null,verbose:!0,strict:!1,projectRoot:process.cwd(),includeMetrics:!0,includeTree:!0,includeValidation:!0,includeSuggestions:!0,includeContext:!0,includeSsr:!0,includeImports:!0,ignoreUnresolvedImports:!0,prettyPrint:!0,debugLevel:"info",...e},this.logger=C({level:this.options.debugLevel,writeToFile:!0,writeToConsole:!1,debugDir:".debug"});const t=this.logger.createComponentLogger("Analyzer");this.log=t,this.importResolver=new $({projectRoot:this.options.projectRoot,ignoreUnresolved:this.options.ignoreUnresolvedImports,...R}),this.results={source:null,tokens:null,ast:null,widgets:null,importResolution:null,state:null,context:null,ssr:null,report:null},this.errors=[],this.timings={}}async analyze(){const e=this.log;e.startSession("FullAnalyzerPipeline");try{if(e.info(`
`+"=".repeat(80)),e.info("\u{1F680} FlutterJS ANALYZER - FULL PIPELINE"),e.info("=".repeat(80)),e.startSession("LoadSource"),e.info("STEP 1: Loading source code..."),await this.loadSource(),e.success("Source loaded"),e.endSession("LoadSource"),e.startSession("Lexing"),e.info("STEP 2: Tokenizing (Lexing)..."),this.lex(),e.trace("Tokens generated",this.results.tokens.length),e.success("Lexing complete"),e.endSession("Lexing"),e.startSession("Parsing"),e.info("STEP 3: Building AST (Parsing)..."),this.parse(),e.trace("Top-level items",this.results.ast.body.length),e.success("Parsing complete"),e.endSession("Parsing"),e.startSession("WidgetAnalysis"),e.info("STEP 4: Widget Analysis (Phase 1)..."),this.analyzeWidgets(),e.trace("Widgets detected",this.results.widgets.widgets.length),e.success("Widget analysis complete"),e.endSession("WidgetAnalysis"),this.options.includeImports){e.startSession("ImportResolution"),e.info("STEP 5: Resolving Imports..."),this.analyzeImports();const t=this.results.importResolution?.summary;e.trace("Imports resolved",t?.resolved||0),e.trace("Imports unresolved",t?.unresolved||0),e.success("Import resolution complete"),e.endSession("ImportResolution")}return e.startSession("StateAnalysis"),e.info("STEP 6: State Analysis (Phase 2)..."),this.analyzeState(),e.trace("State classes analyzed",this.results.state.stateClasses.length),e.success("State analysis complete"),e.endSession("StateAnalysis"),this.options.includeContext&&(e.startSession("ContextAnalysis"),e.info("STEP 7: Context Analysis (Phase 3)..."),this.analyzeContext(),e.trace("Inherited widgets detected",this.results.context.inheritedWidgets?.length||0),e.success("Context analysis complete"),e.endSession("ContextAnalysis")),this.options.includeSsr&&(e.startSession("SSRAnalysis"),e.info("STEP 8: SSR Compatibility Analysis (Phase 3)..."),this.analyzeSsr(),e.trace("SSR Compatibility Score",this.results.ssr.ssrCompatibilityScore),e.success("SSR analysis complete"),e.endSession("SSRAnalysis")),e.startSession("ReportGeneration"),e.info("STEP 9: Generating Report..."),this.generateReport(),e.success("Report generated"),e.endSession("ReportGeneration"),e.startSession("Output"),e.info("STEP 10: Output..."),this.output(),e.success("Output complete"),e.endSession("Output"),e.info("=".repeat(80)),e.success("\u2705 ANALYSIS COMPLETE"),e.info("=".repeat(80)+`
`),this.logger.saveLogs(),this.getResults()}catch(t){throw e.error("ANALYSIS FAILED"),e.failure("Analysis pipeline",t.message),e.endSession("FullAnalyzerPipeline"),t}}analyzeImports(){const e=Date.now(),t=this.log;try{if(!this.results.widgets){t.warn("No widgets found, skipping import analysis");return}const s=this.results.widgets.imports||[];if(s.length===0){t.info("No imports found in source"),this.results.importResolution={imports:{resolved:[],unresolved:[],errors:[]},summary:{total:0,resolved:0,unresolved:0,errors:0,resolutionRate:"N/A",bySource:{framework:0,local:0,cache:0}}};return}t.info(`Found ${s.length} imports to resolve`);const o=this.importResolver.resolveImports(s.map(a=>({source:a.source,items:a.items})));if(this.results.importResolution=o,t.debug(`Resolved: ${o.imports.resolved.length}`),t.debug(`Unresolved: ${o.imports.unresolved.length}`),t.debug(`Errors: ${o.imports.errors.length}`),!this.options.ignoreUnresolvedImports&&o.imports.errors.length>0)throw new Error(`${o.imports.errors.length} imports could not be resolved`)}catch(s){throw t.error(`Import resolution failed: ${s.message}`),new Error(`Import resolution failed: ${s.message}`)}this.timings.analyzeImports=Date.now()-e}async loadSource(){const e=Date.now(),t=this.log;if(this.options.sourceCode)this.results.source=this.options.sourceCode,t.debug("Using provided source code");else if(this.options.sourceFile)try{this.results.source=h.readFileSync(this.options.sourceFile,"utf-8"),t.debug(`Loaded from file: ${this.options.sourceFile}`),t.trace("Source file size",this.results.source.length)}catch(s){throw t.error(`Cannot read file "${this.options.sourceFile}"`),new Error(`Cannot read file "${this.options.sourceFile}": ${s.message}`)}else throw t.error("No source code or source file provided"),new Error("No source code or source file provided");this.timings.loadSource=Date.now()-e}lex(){const e=Date.now(),t=this.log;try{const s=new y(this.results.source);this.results.tokens=s.tokenize(),s.getErrors().length>0&&(t.warn(`Lexer produced ${s.getErrors().length} warnings`),s.getErrors().forEach(o=>{t.debug(`Lexer: ${o.message}`)}))}catch(s){throw t.error(`Lexing failed: ${s.message}`),new Error(`Lexing failed: ${s.message}`)}this.timings.lex=Date.now()-e}parse(){const e=Date.now(),t=this.log;try{const s=new S(this.results.tokens);if(this.results.ast=s.parse(),s.getErrors().length>0&&(t.warn(`Parser produced ${s.getErrors().length} errors`),s.getErrors().forEach(o=>{t.debug(`Parser: ${o.message}`)}),this.options.strict))throw new Error(`${s.getErrors().length} parser errors found`)}catch(s){throw t.error(`Parsing failed: ${s.message}`),new Error(`Parsing failed: ${s.message}`)}this.timings.parse=Date.now()-e}analyzeWidgets(){const e=Date.now(),t=this.log;try{const s=new w(this.results.ast);this.results.widgets=s.analyze(),this.results.widgets.errors.length>0&&(t.warn(`Widget analysis produced ${this.results.widgets.errors.length} errors`),this.results.widgets.errors.forEach(o=>{t.debug(`Widget: ${o.message}`)}))}catch(s){throw t.error(`Widget analysis failed: ${s.message}`),new Error(`Widget analysis failed: ${s.message}`)}this.timings.analyzeWidgets=Date.now()-e}analyzeState(){const e=Date.now(),t=this.log;try{const s=new x(this.results.ast,this.results.widgets.widgets,{strict:this.options.strict});this.results.state=s.analyze(),this.results.state.errors.length>0&&(t.warn(`State analysis produced ${this.results.state.errors.length} errors`),this.results.state.errors.forEach(o=>{t.debug(`State: ${o.message}`)}))}catch(s){throw t.error(`State analysis failed: ${s.message}`),new Error(`State analysis failed: ${s.message}`)}this.timings.analyzeState=Date.now()-e}analyzeContext(){const e=Date.now(),t=this.log;try{const s=new z(this.results.ast,this.results.widgets.widgets,{strict:this.options.strict});this.results.context=s.analyze(),this.results.context.errors&&this.results.context.errors.length>0&&(t.warn(`Context analysis produced ${this.results.context.errors.length} errors`),this.results.context.errors.forEach(o=>{t.debug(`Context: ${o.message}`)}))}catch(s){throw t.error(`Context analysis failed: ${s.message}`),new Error(`Context analysis failed: ${s.message}`)}this.timings.analyzeContext=Date.now()-e}analyzeSsr(){const e=Date.now(),t=this.log;try{const s=new v(this.results.context,this.results.state,{strict:this.options.strict});this.results.ssr=s.analyze(),this.results.ssr.errors&&this.results.ssr.errors.length>0&&(t.warn(`SSR analysis produced ${this.results.ssr.errors.length} errors`),this.results.ssr.errors.forEach(o=>{t.debug(`SSR: ${o.message}`)}))}catch(s){throw t.error(`SSR analysis failed: ${s.message}`),new Error(`SSR analysis failed: ${s.message}`)}this.timings.analyzeSsr=Date.now()-e}generateReport(){const e=Date.now(),t=this.log;try{const s=new E(this.results.widgets,this.results.state,this.results.context,this.results.ssr,{format:this.options.outputFormat,includeMetrics:this.options.includeMetrics,includeTree:this.options.includeTree,includeValidation:this.options.includeValidation,includeSuggestions:this.options.includeSuggestions,includeContext:this.options.includeContext,includeSsr:this.options.includeSsr,prettyPrint:this.options.prettyPrint});this.results.report=s.generate()}catch(s){throw t.error(`Report generation failed: ${s.message}`),new Error(`Report generation failed: ${s.message}`)}this.timings.generateReport=Date.now()-e}output(){const e=this.log;if(this.options.outputFile)try{h.writeFileSync(this.options.outputFile,this.results.report,"utf-8"),e.success(`Report saved to: ${this.options.outputFile}`)}catch(t){throw e.error(`Cannot write to file "${this.options.outputFile}"`),new Error(`Cannot write to file "${this.options.outputFile}": ${t.message}`)}else this.options.outputFormat!=="console"&&console.log(this.results.report)}getResults(){const e=this.results.widgets?.widgets||[],t=e.filter(r=>r.type==="stateless"),s=e.filter(r=>r.type==="stateful"),o=e.filter(r=>r.type==="state"),a=t.map(r=>r.name),c=s.map(r=>r.name),l={};o.forEach(r=>{const i=r.name.replace(/^_/,"").replace(/State$/,""),m=r.fields||[];l[r.name]=m.map(f=>f.name)}),s.forEach(r=>{const i=`_${r.name}State`;l[i]&&(l[r.name]=l[i])});const u=this.results.widgets?.imports||[];return{source:{length:this.results.source?.length||0,file:this.options.sourceFile},tokens:{count:this.results.tokens?.length||0},ast:{items:this.results.ast?.body?.length||0},widgets:{stateless:a,stateful:c,count:e.length,all:e,stateClasses:l,total:{stateless:t.length,stateful:s.length,state:o.length}},imports:this.options.includeImports?u:null,importResolution:this.options.includeImports?{summary:this.results.importResolution?.summary||{total:u.length,resolved:0,unresolved:u.length,errors:0,resolutionRate:"0%"}}:null,state:{stateClasses:this.results.state?.stateClasses?.length||0,stateFields:this.results.state?.stateFields?.length||0,setStateCalls:this.results.state?.setStateCalls?.length||0,lifecycleMethods:this.results.state?.lifecycleMethods?.length||0,eventHandlers:this.results.state?.eventHandlers?.length||0,validationIssues:this.results.state?.validationResults?.length||0},context:this.options.includeContext?{inheritedWidgets:this.results.context?.inheritedWidgets?.length||0,changeNotifiers:this.results.context?.changeNotifiers?.length||0,providers:this.results.context?.providers?.length||0,contextAccessPoints:this.results.context?.contextAccessPoints?.length||0}:null,ssr:this.options.includeSsr?{compatibility:this.results.ssr?.overallCompatibility||"unknown",compatibilityScore:this.results.ssr?.ssrCompatibilityScore||0,safePatterns:this.results.ssr?.ssrSafePatterns?.length||0,unsafePatterns:this.results.ssr?.ssrUnsafePatterns?.length||0,hydrationNeeded:this.results.ssr?.hydrationCount||0,migrationSteps:this.results.ssr?.ssrMigrationPath?.length||0,estimatedEffort:this.results.ssr?.estimatedEffort||"unknown"}:null,timings:this.timings,report:this.results.report,logger:this.logger.getReport(),debugFiles:this.logger.readDebugFiles()}}}async function P(n,e={}){return new g({sourceCode:n,...e}).analyze()}async function b(n,e={}){return new g({sourceFile:n,...e}).analyze()}async function A(n,e,t={}){return new g({sourceFile:n,outputFile:e,...t}).analyze()}async function d(){const n=process.argv.slice(2);n.length===0&&(p(),process.exit(0));const e=n[0];let t=null,s="json",o=!0,a=!0,c=!0,l=!0,u="info";for(let r=1;r<n.length;r++){const i=n[r];i==="-o"||i==="--output"?t=n[++r]:i==="-f"||i==="--format"?s=n[++r]:i==="-q"||i==="--quiet"?o=!1:i==="--debug"?u=n[++r]||"debug":i==="--no-imports"?a=!1:i==="--no-context"?c=!1:i==="--no-ssr"?l=!1:i==="--phase1"?(a=!1,c=!1,l=!1):(i==="-h"||i==="--help")&&(p(),process.exit(0))}["json","markdown","console"].includes(s)||(console.error(`Invalid format: ${s}`),process.exit(1));try{const i=await new g({sourceFile:e,outputFile:t,outputFormat:s,verbose:o,includeImports:a,includeContext:c,includeSsr:l,debugLevel:u}).analyze();u!=="info"&&(console.log(`
\u{1F4CA} Debug logs saved to: .debug/`),console.log(`   View with: node debug_viewer.js
`)),process.exit(0)}catch(r){console.error(`
\u274C Error: ${r.message}
`),process.exit(1)}}function p(){console.log(`
FlutterJS Analyzer (Phase 1 + Import Resolution + Phase 2 + 3)

Usage:
  node analyzer.js <source-file> [options]

Options:
  -o, --output <file>      Output file (default: print to console)
  -f, --format <format>    Output format: json, markdown, console (default: json)
  -q, --quiet              Suppress verbose output
  --debug <level>          Enable debug logging: trace, debug, info (default: info)
  --no-imports             Skip import resolution
  --no-context             Skip Phase 3 context analysis
  --no-ssr                 Skip Phase 3 SSR analysis
  --phase1                 Only Phase 1 (widgets + imports)
  -h, --help               Show this help message

Examples:
  node analyzer.js test.fjs
  node analyzer.js test.fjs -o report.json
  node analyzer.js test.fjs --debug trace
  node analyzer.js test.fjs -f markdown
  node analyzer.js test.fjs --phase1
`)}import.meta.url===`file://${process.argv[1]}`&&d();export{g as Analyzer,A as analyzeAndSave,P as analyzeCode,b as analyzeFile,d as runCLI};
//# sourceMappingURL=analyzer.js.map
