class p{constructor(e,s,t={}){this.ast=e,this.widgets=s,this.options={strict:!1,...t},this.stateClasses=new Map,this.stateFields=new Map,this.setStateCalls=[],this.lifecycleMethods=[],this.eventHandlers=[],this.dependencyGraph=null,this.validationResults=[],this.errors=[]}analyze(){if(!this.ast||!this.ast.body)throw new Error("Invalid AST provided");try{return this.linkStatefulToState(),this.extractStateFields(),this.findSetStateCalls(),this.extractLifecycleMethods(),this.extractEventHandlers(),this.buildDependencyGraph(),this.validateState(),this.getResults()}catch(e){return this.errors.push(e),this.getResults()}}linkStatefulToState(){this.widgets.forEach(e=>{if(e.type!=="stateful")return;if(!e.methods.find(o=>o.name==="createState")){this.errors.push({type:"missing-create-state",widget:e.name,message:`StatefulWidget "${e.name}" has no createState() method`});return}const t=this.ast.body.find(o=>o.type==="ClassDeclaration"&&o.id.name===e.name);if(!t)return;const n=t.body.methods.find(o=>o.key.name==="createState");if(!n)return;const i=this.extractReturnedClassName(n.body);if(!i){this.errors.push({type:"cannot-parse-create-state",widget:e.name,message:`Cannot determine which State class is returned by ${e.name}.createState()`});return}const a=this.ast.body.find(o=>o.type==="ClassDeclaration"&&o.id.name===i);if(!a){this.errors.push({type:"missing-state-class",widget:e.name,stateClass:i,message:`State class "${i}" not found`});return}if(!a.superClass||!a.superClass.name.startsWith("State")){this.errors.push({type:"invalid-state-class",stateClass:i,message:`Class "${i}" does not extend State`});return}const r=new d(i,a.location,e.name);this.stateClasses.set(i,{astNode:a,metadata:r}),e.linkedStateClass=i})}extractReturnedClassName(e){if(!e)return null;if(e.type==="BlockStatement"&&e.body){for(const s of e.body)if(s.type==="ReturnStatement"&&s.argument){const t=this.getClassNameFromExpression(s.argument);if(t)return t}}return e.type==="NewExpression"?e.callee.name:null}getClassNameFromExpression(e){return e?e.type==="NewExpression"&&e.callee?e.callee.name:e.type==="Identifier"?e.name:e.type==="CallExpression"&&e.callee&&e.callee.type==="Identifier"?e.callee.name:null:null}extractStateFields(){this.stateClasses.forEach(({astNode:e,metadata:s})=>{!e.body||!e.body.fields||e.body.fields.forEach(t=>{const n=t.key.name,i=t.initialValue,a=this.inferFieldType(i),r=new f(n,a,this.expressionToValue(i),i?i.location:t.location);this.stateFields.set(`${s.name}.${n}`,r),s.stateFields.push(r)})})}inferFieldType(e){if(!e)return"any";if(e.type==="Literal"){if(typeof e.value=="number")return"number";if(typeof e.value=="string")return"string";if(typeof e.value=="boolean")return"boolean";if(e.value===null)return"null"}if(e.type==="Identifier"){const s=e.name;if(s==="true"||s==="false")return"boolean";if(s==="null")return"null";if(s==="undefined")return"undefined"}return e.type==="ArrayLiteral"?"array":e.type==="ObjectLiteral"?"object":(e.type==="CallExpression","any")}expressionToValue(e){if(e){if(e.type==="Literal")return e.value;if(e.type==="Identifier"){const s=e.name;if(s==="true")return!0;if(s==="false")return!1;if(s==="null")return null;if(s==="undefined")return}}}findSetStateCalls(){this.stateClasses.forEach(({astNode:e,metadata:s})=>{!e.body||!e.body.methods||e.body.methods.forEach(t=>{const n=this.findSetStateInMethod(t,s.name);this.setStateCalls.push(...n)})})}findSetStateInMethod(e,s){const t=[],n=e.key.name;return e.body&&(e.body.type==="BlockStatement"?e.body.body:[e.body]).forEach(a=>{this.findSetStateInStatement(a,t,n,s)}),t}findSetStateInStatement(e,s,t,n){e&&(e.type==="ExpressionStatement"&&e.expression&&this.findSetStateInExpression(e.expression,s,t,n),e.type==="ReturnStatement"&&e.argument&&this.findSetStateInExpression(e.argument,s,t,n),e.type==="BlockStatement"&&e.body&&e.body.forEach(i=>{this.findSetStateInStatement(i,s,t,n)}))}findSetStateInExpression(e,s,t,n){if(e){if(e.type==="CallExpression"){if(this.isSetStateCall(e)){const a=this.extractSetStateUpdates(e,n),r=new h(e.location,t,a,n);s.push(r)}e.args.forEach(a=>{this.findSetStateInExpression(a,s,t,n)})}e.type==="ObjectLiteral"&&e.properties&&e.properties.forEach(i=>{this.findSetStateInExpression(i.value,s,t,n)})}}isSetStateCall(e){if(e.type!=="CallExpression"||!e.callee)return!1;if(e.callee.type==="MemberExpression"){const s=e.callee.object,t=e.callee.property;if(s.type==="Identifier"&&s.name==="this"&&t.type==="Identifier"&&t.name==="setState")return!0}return!1}extractSetStateUpdates(e,s){const t=[];if(!e.args||e.args.length===0)return t;const n=e.args[0];if(n.type==="ArrowFunctionExpression"){const i=n.body;if(i.type==="BlockStatement"&&i.body)i.body.forEach(a=>{const r=this.extractMutatedFields(a,s);t.push(...r)});else if(i.type==="UpdateExpression"||i.type==="AssignmentExpression"){const a=this.extractMutatedFields(i,s);t.push(...a)}}return[...new Set(t)]}extractMutatedFields(e,s){const t=[];if(!e)return t;if(e.type==="ExpressionStatement"&&e.expression){const n=e.expression;if(n.type==="AssignmentExpression"){const i=this.getFieldNameFromTarget(n.left);i&&t.push(i)}if(n.type==="UpdateExpression"){const i=this.getFieldNameFromTarget(n.argument);i&&t.push(i)}}if(e.type==="AssignmentExpression"){const n=this.getFieldNameFromTarget(e.left);n&&t.push(n)}if(e.type==="UpdateExpression"){const n=this.getFieldNameFromTarget(e.argument);n&&t.push(n)}return t}getFieldNameFromTarget(e){if(!e)return null;if(e.type==="MemberExpression"){const s=e.object,t=e.property;if(s.type==="Identifier"&&s.name==="this"&&t.type==="Identifier")return t.name}return e.type==="Identifier"?e.name:null}extractLifecycleMethods(){const e=["initState","dispose","didUpdateWidget","build"];this.stateClasses.forEach(({astNode:s,metadata:t})=>{!s.body||!s.body.methods||s.body.methods.forEach(n=>{const i=n.key.name;if(e.includes(i)){const a=new u(i,n.location,n.params||[],this.checkCallsSuper(n),this.checkHasSideEffects(n));this.lifecycleMethods.push(a),t.lifecycleMethods.push(a)}})})}checkCallsSuper(e){if(!e.body)return!1;const s=e.body.type==="BlockStatement"?e.body.body:[e.body];for(const t of s)if(t.type==="ExpressionStatement"&&t.expression){const n=t.expression;if(n.type==="CallExpression"&&n.callee.type==="MemberExpression"){const i=n.callee.object,a=n.callee.property;if(i.type==="Identifier"&&i.name==="super"&&a.type==="Identifier"&&a.name===e.key.name)return!0}}return!1}checkHasSideEffects(e){if(!e.body)return!1;const s=e.body.type==="BlockStatement"?e.body.body:[e.body];for(const t of s)if(t.type==="ExpressionStatement"&&t.expression){const n=t.expression;if(n.type==="AssignmentExpression"||n.type==="UpdateExpression"||n.type==="CallExpression")return!0}return!1}extractEventHandlers(){this.stateClasses.forEach(({astNode:e,metadata:s})=>{if(!e.body||!e.body.methods)return;const t=e.body.methods.find(i=>i.key.name==="build");if(!t)return;const n=this.findEventHandlersInMethod(t,s.name);this.eventHandlers.push(...n)})}findEventHandlersInMethod(e,s){const t=[];return e.body&&(e.body.type==="BlockStatement"?e.body.body:[e.body]).forEach(i=>{this.findEventHandlersInStatement(i,t,s)}),t}findEventHandlersInStatement(e,s,t){e&&(e.type==="ExpressionStatement"&&e.expression&&this.findEventHandlersInExpression(e.expression,s,t),e.type==="ReturnStatement"&&e.argument&&this.findEventHandlersInExpression(e.argument,s,t),e.type==="BlockStatement"&&e.body&&e.body.forEach(n=>{this.findEventHandlersInStatement(n,s,t)}))}findEventHandlersInExpression(e,s,t){e&&(e.type==="ObjectLiteral"&&e.properties&&e.properties.forEach(n=>{const i=this.getPropertyKey(n.key);if(/^on[A-Z]/.test(i)){const r=this.extractEventHandler(n.value,t);r&&s.push({event:i,handler:r,location:n.location,component:this.getComponentNameFromContext(e)})}this.findEventHandlersInExpression(n.value,s,t)}),e.type==="CallExpression"&&e.args&&e.args.forEach(n=>{this.findEventHandlersInExpression(n,s,t)}),e.type==="NewExpression"&&e.args&&e.args.forEach(n=>{this.findEventHandlersInExpression(n,s,t)}))}getPropertyKey(e){return e?e.type==="Identifier"?e.name:e.type==="Literal"?String(e.value):null:null}extractEventHandler(e,s){if(!e)return null;if(e.type==="ArrowFunctionExpression"){if(e.body.type==="CallExpression")return this.getClassNameFromExpression(e.body.callee);if(e.body.type==="Identifier")return e.body.name}return e.type==="Identifier"?e.name:e.type==="MemberExpression"&&e.property.type==="Identifier"?e.property.name:null}getComponentNameFromContext(e){return e.type==="CallExpression"&&e.callee?this.getClassNameFromExpression(e.callee):"Unknown"}buildDependencyGraph(){this.dependencyGraph=new c,this.stateFields.forEach((e,s)=>{const t=this.findMethodsUsingField(e.name);t.length>0&&this.dependencyGraph.stateToMethods.set(e.name,t)}),this.stateClasses.forEach(({metadata:e})=>{e.stateFields.forEach(s=>{const t=this.findMethodsReadingField(e.name,s.name);t.length>0&&this.dependencyGraph.methodToState.set(s.name,t)})}),this.eventHandlers.forEach(e=>{const s=this.findStateChangedByMethod(e.handler);s.length>0&&this.dependencyGraph.eventToState.set(e.event,s)})}findMethodsUsingField(e){const s=new Set;return this.setStateCalls.forEach(t=>{t.updates.includes(e)&&s.add(t.method)}),this.stateClasses.forEach(({astNode:t,metadata:n})=>{if(!t.body||!t.body.methods)return;const i=t.body.methods.find(a=>a.key.name==="build");i&&this.methodUsesField(i,e)&&s.add("build")}),Array.from(s)}methodUsesField(e,s){if(!e.body)return!1;const t=e.body.type==="BlockStatement"?e.body.body:[e.body];for(const n of t)if(this.statementUsesField(n,s))return!0;return!1}statementUsesField(e,s){return e?JSON.stringify(e).includes(s):!1}findMethodsReadingField(e,s){const t=[];return this.stateClasses.forEach(({metadata:n})=>{n.name===e&&n.stateFields.forEach(i=>{i.name===s&&t.push(...i.usedInMethods)})}),t}findStateChangedByMethod(e){const s=new Set;return this.setStateCalls.forEach(t=>{t.method===e&&t.updates.forEach(n=>s.add(n))}),Array.from(s)}validateState(){this.validateSetStatePatterns(),this.validateStateFieldUsage(),this.validateLifecyclePatterns(),this.validateEventHandlers()}validateSetStatePatterns(){this.setStateCalls.forEach(e=>{const s=[];this.stateClasses.get(e.stateClassName)||s.push({type:"invalid-context",message:`setState called outside of ${e.stateClassName}`}),e.updates.length===0&&s.push({type:"empty-update",message:"setState called with no state updates",severity:"warning"}),e.updates.forEach(n=>{this.stateFields.has(`${e.stateClassName}.${n}`)||s.push({type:"unknown-field",message:`setState updates unknown field "${n}"`,field:n})}),e.isValid=s.length===0,e.issues=s})}validateStateFieldUsage(){this.stateFields.forEach((e,s)=>{const t=s.split("."),n=t[0],i=t[1];this.fieldIsUsed(i,n)||this.validationResults.push({type:"unused-state-field",severity:"warning",field:i,location:e.location,message:`State field "${i}" is defined but never used`,suggestion:"Remove unused field or implement its usage"});const a=this.findMutationsOutsideSetState(i,n);a.length>0&&this.validationResults.push({type:"mutation-outside-setstate",severity:"error",field:i,locations:a,message:`State field "${i}" is mutated outside setState()`,suggestion:"Always use setState() to update state fields"})})}fieldIsUsed(e,s){const t=this.stateClasses.get(s);if(!t)return!1;const n=t.astNode.body.methods.find(i=>i.key.name==="build");return n&&this.methodUsesField(n,e)?!0:this.setStateCalls.some(i=>i.updates.includes(e))}findMutationsOutsideSetState(e,s){const t=[],n=new Set;return this.setStateCalls.forEach(i=>{i.updates.forEach(a=>{n.add(a)})}),n.has(e),t}validateLifecyclePatterns(){this.stateClasses.forEach(({metadata:e})=>{const s={};e.lifecycleMethods.forEach(t=>{s[t.name]=t}),s.dispose&&!s.dispose.callsSuper&&this.validationResults.push({type:"lifecycle-issue",severity:"error",method:"dispose",location:s.dispose.location,message:"dispose() should call super.dispose()",suggestion:"Add super.dispose() call at the end of dispose()"}),s.initState&&!s.initState.callsSuper&&this.validationResults.push({type:"lifecycle-issue",severity:"warning",method:"initState",location:s.initState.location,message:"initState() should call super.initState()",suggestion:"Add super.initState() call"})})}validateEventHandlers(){this.eventHandlers.forEach(e=>{!this.stateClasses.values().some(t=>t.metadata.stateFields.some(n=>n.name===e.handler)||t.astNode.body.methods.some(n=>n.key.name===e.handler))&&e.handler&&this.validationResults.push({type:"missing-handler",severity:"error",handler:e.handler,event:e.event,location:e.location,message:`Event handler "${e.handler}" not found`,suggestion:`Create a method called ${e.handler} in the State class`})})}getResults(){return{stateClasses:Array.from(this.stateClasses.entries()).map(([e,s])=>({name:e,metadata:s.metadata})),stateFields:Array.from(this.stateFields.values()),setStateCalls:this.setStateCalls,lifecycleMethods:this.lifecycleMethods,eventHandlers:this.eventHandlers,dependencyGraph:this.dependencyGraph,validationResults:this.validationResults,errors:this.errors}}}class d{constructor(e,s,t){this.name=e,this.location=s,this.linkedStatefulWidget=t,this.stateFields=[],this.lifecycleMethods=[],this.methods=[]}}class f{constructor(e,s,t,n){this.name=e,this.type=s,this.initialValue=t,this.location=n,this.isMutable=!0,this.mutations=[],this.usedInMethods=[],this.usedInBuild=!1}}class u{constructor(e,s,t,n,i){this.name=e,this.location=s,this.params=t,this.callsSuper=n,this.hasSideEffects=i}}class h{constructor(e,s,t,n){this.location=e,this.method=s,this.updates=t||[],this.stateClassName=n,this.isValid=!0,this.issues=[]}}class c{constructor(){this.stateToMethods=new Map,this.methodToState=new Map,this.eventToState=new Map}}export{c as DependencyGraph,u as LifecycleMethod,p as StateAnalyzer,d as StateClassMetadata,f as StateField,h as StateUpdateCall};
//# sourceMappingURL=state_analyzer_implementation.js.map
